---
title: "HIVCycIF_Analysis"
output: html_document
author: "Heeva Baharlou"
editor_options: 
  chunk_output_type: console
  dataset: "HIVCycIF data"
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE, message = FALSE, warning = FALSE)
```

## R Markdown

## Install Packages
```{r eval = FALSE, echo = FALSE}
install.packages("RColorBrewer",  repos = "http://cran.us.r-project.org")
install.packages("tidyverse",  repos = "http://cran.us.r-project.org")
install.packages("stringr",  repos = "http://cran.us.r-project.org")
install.packages("Hmisc",  repos = "http://cran.us.r-project.org")
install.packages("naniar",  repos = "http://cran.us.r-project.org")
install.packages("reshape",  repos = "http://cran.us.r-project.org")
install.packages("reshape2",  repos = "http://cran.us.r-project.org")
install.packages("rmarkdown",  repos = "http://cran.us.r-project.org")
install.packages("ggpubr")
install.packages("spatstat")
install.packages("lemon")
install.packages("parallel")
install.packages("scales")
install.packages("cowplot")
install.packages("corrplot")
install.packages("psych")
BiocManager::install("ComplexHeatmap")
install.packages("pheatmap")
BiocManager::install("spicyR")
install.packages("rlang")
install.packages("lme4")
install.packages("ggplot")
install.packages("wesanderson")
install.packages("fabricatr")
install.packages("ggplotify")
BiocManager::install("EBImage")

```

## Load in Packages
```{r eval = FALSE, echo = FALSE}
library(RColorBrewer)
library(tidyverse)
library(stringr)
library(Hmisc)
library(naniar)
library(reshape)
library(reshape2)
library(rmarkdown)
library(ggpubr)
library(spatstat)
library(rstatix)
library(lemon)
library(parallel)
library(scales)
library(cowplot)
library(corrplot)
library(psych)
library(ComplexHeatmap)
library(pheatmap)
library(spicyR)
library(rlang)
library(lme4)
library(ggplotify)
library(wesanderson)
library(fabricatr)
library(EBImage)

```

## Load in data, set directories and other general prep stuff
```{r eval = FALSE, echo = FALSE}
  setwd("")
  cellData <- readRDS("cellDataZ.rds")

```

## Figure S1C - Eg. Histogram of CD4 expression in CD3+ T cells. 

```{r echo = FALSE}


df = cellData %>%
  dplyr::filter(Image == "20190814_D182_hivTF_S10_ID44") %>%
  dplyr::filter(CellTypeZ == "CD3CD4p" | CellTypeZ == "CD3CD4n")

df %>% dplyr::filter(CellTypeZ == "CD3CD4p") %>% summarise(min(CD4))
  
ggplot(df, aes(x = CD4, fill = Donor, color = Donor)) + 
  geom_histogram(alpha = 0.4, position = "identity", bins = 50) +
  xlim(c(0,450)) +
  geom_vline(xintercept = 64, color = "black", size=2.0) +
  scale_color_manual(values = c("#4292C6")) +
  scale_fill_manual(values = c("#4292C6")) +
  scale_y_continuous(limits = c(0,1100), expand = expansion(mult = c(0, .1))) +
  theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_blank(),
              axis.title.y=element_blank(),
              axis.text.y=element_blank())

ggsave("plot.png", width = 15, height = 5, units = "cm", dpi = 300) 


```

## Figure 2B -  HIV target cell proportion and distribution in compartments of colorectum. 

```{r echo = FALSE}

## Change the Compartment variable below and re run to get data for each compartment. 
comp = "SM"

## Pie chart of proportion of target cells vs other cells.

cellProp = cellData %>%
  dplyr::filter(Condition == "ori") %>%
  dplyr::filter(Compartments != "Undefined") %>%
  dplyr::filter(batch == "new") %>%
  group_by(Image) %>%
  dplyr::filter((sum(Compartments == "LA") > 0) &
           (sum(Compartments == "LP") > 0) &
           (sum(Compartments == "EP") > 0) &
           (sum(Compartments == "SM") > 0)) %>%
  mutate(CellTypeZ = case_when(
    CellTypeZ %in% c("CD3CD4p", "CD11c", "FXIIIa") ~ "targetCell",
    TRUE~as.character("otherCell"))) %>%
  group_by(DonorNo, Image, Compartments) %>%
  count(CellTypeZ) %>%
  mutate(sumCell = sum(n)) %>%
  ungroup() %>%
  mutate(propCell = n/sumCell) %>%
  group_by(DonorNo, Compartments, CellTypeZ) %>%
  summarise(compMean = mean(propCell)) %>%
  ungroup() %>%
  mutate(Compartments = factor(Compartments, levels = c("EP", "LP","LA","SM"))) %>%
  mutate(CellTypeZ = factor(CellTypeZ, levels = c("targetCell", "otherCell")))

plot = cellProp %>% 
      dplyr::filter(Compartments == !!comp) %>%
      group_by(CellTypeZ) %>%
      summarise(cellPerc = mean(compMean))

ggplot(plot, aes(x = " ", y = cellPerc, fill=CellTypeZ)) +
  scale_fill_manual(values = c(wes_palette("Darjeeling1")[1], wes_palette("Darjeeling2")[2])) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar("y", start=0, direction = -1) +
    theme_void() +
    theme(legend.position = "none")

ggsave("plot.png", width = 4, height = 4, units = "cm", dpi = 300)


## Pie chart of proportion of each target cell type in compartments

cellProp = cellData %>%
  dplyr::filter(Condition == "ori") %>%
  dplyr::filter(Compartments != "Undefined") %>%
  dplyr::filter(batch == "new") %>%
  group_by(Image) %>%
  dplyr::filter((sum(Compartments == "LA") > 0) &
           (sum(Compartments == "LP") > 0) &
           (sum(Compartments == "EP") > 0) &
           (sum(Compartments == "SM") > 0)) %>%
  dplyr::filter(!CellTypeZ %in% c("Unknown", "CD3CD4n", "MDDC")) %>%
  group_by(DonorNo, Image, Compartments) %>%
  count(CellTypeZ) %>%
  mutate(sumCell = sum(n)) %>%
  ungroup() %>%
  mutate(propCell = n/sumCell) %>%
  group_by(DonorNo, Compartments, CellTypeZ) %>%
  summarise(compMean = mean(propCell)) %>%
  ungroup() %>%
  mutate(Compartments = factor(Compartments, levels = c("EP", "LP","LA","SM"))) %>%
  mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD11c", "FXIIIa","CD3CD4p")))

plot = cellProp %>% 
      dplyr::filter(Compartments == !!comp) %>%
      group_by(CellTypeZ) %>%
      summarise(cellPerc = mean(compMean)) %>%
      mutate(CellType = factor(c("DC", "CD4 T cell", "Mac"), levels = c("DC", "CD4 T cell", "Mac")))

ggplot(plot, aes(x = " ", y = cellPerc, fill=CellTypeZ)) +
   scale_fill_manual(values = c("#78C679", "#FEB24C", "#4292C6")) +
  geom_bar(width = 1, stat = "identity") +
  coord_polar("y", start=0, direction = -1) +
    theme_void() +
    theme(legend.position = "none")

ggsave("plot1.png", width = 4, height = 4, units = "cm", dpi = 300)


## Target Cell densities in each compartment (individual cells including CD4n cells)

cellDen = cellData %>%
  dplyr::filter(Condition == "ori") %>%
  dplyr::filter(Compartments != "Undefined") %>%
  dplyr::filter(batch == "new") %>%
  group_by(Image) %>%
  dplyr::filter((sum(Compartments == "LA") > 0) &
           (sum(Compartments == "LP") > 0) &
           (sum(Compartments == "EP") > 0) &
           (sum(Compartments == "SM") > 0)) %>%
  group_by(DonorNo, Image, Compartments) %>%
  mutate(sumArea = sum(NucArea)/(((3.07^2)*10^6))) %>%
  group_by(DonorNo, Image, Compartments, CellTypeZ) %>%
  add_count(name = "sumCell") %>%
  mutate(cellDen = sumCell/sumArea) %>%
  summarise(cellDen = mean(cellDen), sumCell = mean(sumCell)) %>%
  dplyr::filter(CellTypeZ %in% c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n")) %>%
  mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n"))) %>%
  mutate(Compartments = factor(Compartments, levels = c("EP", "LP","LA","SM")))

cellDen %>%
  dplyr::filter(Compartments == !!comp) %>%
ggplot(aes(x = CellTypeZ, y=cellDen, fill = CellTypeZ)) + 
  geom_boxplot(position=position_dodge(1.0), width = 0.8, alpha = 0.65, lwd = 2.0, outlier.shape = NA) +
  scale_fill_manual(values = c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3")) +
  coord_cartesian(ylim = c(0,1000)) +
  scale_x_discrete(labels = c("DC", "Mac", "CD4+ TC", "CD4- TC")) +
  theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 14,
                                       face="plain",
                                       angle = 45,
                                       vjust = 0.9,
                                       hjust = 1.0),    # Y axis text
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4,
                                       hjust = 0))    # Y axis text

ggsave("plot2.png", width = 10, height = 10, units = "cm", dpi = 300)

dfTest = cellDen %>%
  dplyr::filter(Compartments == "SM") %>%
  select(-sumCell) %>%
  pivot_wider(names_from = CellTypeZ, values_from = cellDen)

wilcox.test(dfTest$CD11c, dfTest$Unknown, paired = TRUE)


```

## Figure 2 - How does the proportion or density of EP or LP target cells change with increasing distance from LAs? (To DO)

```{r echo = FALSE}
# CellProp and CellDen can be measured by commenting in/out the appropriate lines below. dfWholeDen is only used for the density measurement and need
# to be joined into the dfMain dataframe in the loop. 

df = cellData %>%
  dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "ori") %>%
  group_by(DonorNo, Image) %>%
  dplyr::filter(
           (sum(Compartments == "LP") > 0) &
           (sum(Compartments == "EP") > 0) &
           (sum(Compartments == "LA") > 0)) %>%
  dplyr::filter(Compartments == "EP") 
  # mutate(CellTypeZ = case_when(
  #   hivCount > 0 ~ "HIVPos",
  #   hivCount == 0 ~ "HIVNeg",
  #   TRUE~as.character("toDelete"))) %>%
  # dplyr::filter(CellTypeZ != "toDelete")
  
dfWholeDen = df %>%
  group_by(DonorNo, Image) %>%
  mutate(sumAreaWhole = sum(NucArea)/(((3.07^2)*10^6))) %>%
  group_by(DonorNo, Image, CellTypeZ) %>%
  add_count(name = "cellTypeCountWhole") %>%
  mutate(cellDenWhole = cellTypeCountWhole/sumAreaWhole) %>%
  dplyr::filter(CellTypeZ %in% c("CD11c", "FXIIIa", "CD3CD4p", "Unknown")) %>%
  mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD11c", "FXIIIa", "CD3CD4p", "Unknown"))) %>%
  # summarise(cellPropWhole = mean(cellPropWhole)) %>%
  summarise(cellDenWhole = mean(cellDenWhole)) %>%
  ungroup()

sequence = seq(20, 400, by = 20)
vals = data.frame(sequence)
colnames(vals) = "Distance"
n = 0
interval = 20

dfMain = data.frame()

for(i in sequence) {
  
  df0 = df %>%  
    group_by(DonorNo, Image) %>%
    dplyr::filter((LADist >= n*interval*3.07) & (LADist <= i*3.07)) %>%
    add_count(name = "cellCount") %>%
    mutate(sumArea = sum(NucArea)/(((3.07^2)*10^6))) %>%
    group_by(DonorNo,Image, CellTypeZ) %>%
    add_count(name = "cellTypeCount") %>%
    # mutate(cellProp = (cellTypeCount/cellCount)*100) %>%
    mutate(cellDen = cellTypeCount/sumArea) %>%
    dplyr::filter(CellTypeZ %in% c("CD11c", "FXIIIa", "CD3CD4p", "Unknown")) %>%
    mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD11c", "FXIIIa", "CD3CD4p", "Unknown"))) %>%
    # summarise(cellProp = mean(cellProp)) %>%
    summarise(cellDen = mean(cellDen)) %>%
    ungroup()

  toMeasure = "cellDen"
  #Adding back in cell counts that are 0 (and so excluded from cellDensity measurements above)
  df1 = pivot_wider(df0, names_from = c("CellTypeZ"), values_from = toMeasure)
  df1[is.na(df1)] = 0
  df1 = pivot_longer(df1, cols = c("CD11c", "FXIIIa", "CD3CD4p", "Unknown"), names_to = c("CellTypeZ"), values_to = toMeasure)
  # df1 = pivot_longer(df1, cols = c("HIVPos", "HIVNeg"), names_to = c("CellTypeZ"), values_to = toMeasure)
  
  df1 = left_join(df1, dfWholeDen)
  
  df1 = df1 %>%
    mutate(foldChange = cellDen/cellDenWhole)
  
  df1$distance = i
  dfMain = rbind(dfMain, df1)
  
  n = n + 1 
  
}

dfMain$distance = as.factor(dfMain$distance)
dfMain$CellTypeZ = factor(dfMain$CellTypeZ, levels = c("CD11c", "FXIIIa", "CD3CD4p", "Unknown"))

dfMain2 = dfMain %>% dplyr::filter(foldChange != 0)

# dfMain2 = dfMain2 %>% dplyr::filter(DonorNo != 116) %>% dplyr::filter(CellTypeZ != "FXIIIa")

test1 = dfMain2 %>%
  pivot_longer(cols = c("foldChange", "cellDen", "cellDenWhole"), names_to = c("measureType"), values_to = "values") %>%
  dplyr::filter(measureType != "foldChange") %>%
  group_by(CellTypeZ, distance) %>%
  summarise(pVal = t.test(values ~ measureType, paired = TRUE, alternative = "two.sided")$p.value)

test2 = dfMain2 %>%
  group_by(CellTypeZ, distance) %>%
  summarise(mean = mean(foldChange), sd = sd(foldChange))

test = left_join(test1, test2)

test = test %>%
  mutate(sdLower = mean - sd) %>%
  mutate(sdHigher = mean + sd)

test$distance = as.numeric(as.character((test$distance)))

g = test %>%
  dplyr::filter(CellTypeZ == "CD11c" | CellTypeZ == "Unknown") %>%
  ggplot(aes(x = distance, y = mean, colour = CellTypeZ, fill = CellTypeZ)) +
  # geom_line(aes(colour = CellTypeZ), size = 1) +
  geom_smooth() +
  # geom_ribbon(aes(ymin = sdLower, ymax = sdHigher, fill = CellTypeZ), colour = "grey70", alpha = 0.4) +
  # geom_point(size = 3, alpha = 0.65) +
  # scale_color_gradient(low = "#e5f5e0", high = "#31a354")
  geom_hline(yintercept = 1.0, linetype = "dashed", color = "black") +
  # ylim(c(0.5,2.5)) +
  # coord_cartesian(ylim = c(0.9,1.5)) +
  theme_minimal() +
  scale_colour_manual(values = c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3")) +
  scale_fill_manual(values = c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3")) +
  # scale_colour_manual(values = c("#78C679", "#FEB24C", "#4292C6")) +
  # scale_fill_manual(values = c("#78C679", "#FEB24C", "#4292C6")) +
  # scale_colour_manual(values = c("#78C679", "#B3B3B3")) +
  # scale_fill_manual(values = c("#78C679", "#B3B3B3")) +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.0,
                                       angle = 0,
                                       hjust = 0.5),    # Y axis text
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4)) 
g

ggsave("plot1.png", width = 10, height = 10, units = "cm", dpi = 300)

# Checking how it looks in individual donors


g = dfMain2 %>%
  dplyr::filter(CellTypeZ == "CD11c") %>%
  ggplot(aes(x = distance, y = foldChange, colour = CellTypeZ, fill = CellTypeZ)) +
  geom_line(aes(colour = CellTypeZ), size = 1) +
  # geom_smooth() +
  # geom_ribbon(aes(ymin = sdLower, ymax = sdHigher, fill = CellTypeZ), colour = "grey70", alpha = 0.4) +
  geom_point(size = 3, alpha = 0.65) +
  # scale_color_gradient(low = "#e5f5e0", high = "#31a354")
  geom_hline(yintercept = 1.0, linetype = "dashed", color = "black") +
  coord_cartesian(ylim = (c(0.0,2.5))) +
  # coord_cartesian(ylim = c(0.9,1.5)) +
  theme_minimal() +
  scale_colour_manual(values = c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3")) +
  scale_fill_manual(values = c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3")) +
  # scale_colour_manual(values = c("#78C679", "#FEB24C", "#4292C6")) +
  # scale_fill_manual(values = c("#78C679", "#FEB24C", "#4292C6")) +
  # scale_colour_manual(values = c("#78C679", "#B3B3B3")) +
  # scale_fill_manual(values = c("#78C679", "#B3B3B3")) +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.0,
                                       angle = 0,
                                       hjust = 0.5),    # Y axis text
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4)) + 
  facet_wrap(~Image, scales = "free")
g



## Make heatmap column of p values to overlap on the fold-change vs distance plots

#using ggplot

data = test
data$pVal = -log10(data$pVal)
data$distance = as.factor(data$distance)
data$CellTypeZ = as.factor(data$CellTypeZ)

#Define a cool colour palette I found here: https://www.r-bloggers.com/simplest-possible-heatmap-with-ggplot2/
myPalette <- colorRampPalette(rev(brewer.pal(11, "Spectral")), space="Lab")

g = data %>%
 # dplyr::filter(CellTypeZ == "CD11c" | CellTypeZ == "Unknown") %>%
 # dplyr::filter(distance %in% c("10", "20", "30", "40", "50", "60", "70","80", "90", "100")) %>%
  ggplot(aes(x = distance, y = 1, fill = pVal)) +
  geom_tile(aes(fill = pVal)) + 
  scale_fill_gradientn(colors = myPalette(100),
                       # limits = c(0,4)) +
                       values=scales::rescale(c(min(data$pVal),-log10(0.01), max(data$pVal)))) +
  theme_classic() +
  theme(
    # legend.position = "none",
    plot.title=element_blank(), # title
          axis.title = element_blank(),
          axis.text=element_blank(),  
          legend.title = element_text(size = 18),
          legend.text = element_text(size =18),  
          axis.ticks = element_blank(),    
          strip.text.x = element_blank(),
          axis.line=element_blank(),
          panel.spacing = unit(0.3, "lines"),
          # plot.margin = unit(c(4,4,4,4), "cm"))    # Y axis title
          plot.margin = unit(c(1,1,1,1), "cm")) +    # Y axis title
          facet_rep_wrap(~CellTypeZ, scales = "free_y", ncol = 1, repeat.tick.labels = 'left')

g


## Density comparison in laClose and laFar groupings (shows the density in large intervals from LA)


df = cellData %>%
  dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "ori") %>%
  group_by(DonorNo, Image) %>%
  dplyr::filter(
           (sum(Compartments == "LP") > 0) &
           (sum(Compartments == "EP") > 0) &
           (sum(Compartments == "LA") > 0)) %>%
  dplyr::filter(Compartments == "LP") 
  
dfAnn = df %>%
  group_by(DonorNo, Image) %>%
  mutate(LAProx = case_when(
    LADist <= 200*3.07 ~ "LAClose",
    LADist > 200*3.07 ~ "LAFar",
    TRUE~as.character("toDelete"))) %>%
  dplyr::filter(LAProx != "toDelete") %>%
  mutate(LAProx = factor(LAProx, levels = c("LAClose", "LAFar"))) %>%
  group_by(DonorNo, Image, LAProx) %>%
  mutate(sumArea = sum(NucArea)/(((3.07^2)*10^6))) %>%
  group_by(DonorNo, Image, LAProx, CellTypeZ) %>%
  add_count(name = "cellTypeCount") %>%
  mutate(cellDen = cellTypeCount/sumArea) %>%
  dplyr::filter(CellTypeZ %in% c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n")) %>%
  mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n"))) %>%
  summarise(cellDen = mean(cellDen)) %>%
  ungroup()

dfAnn %>%
  # dplyr::filter(CellTypeZ %in% c("CD11c", "CD3CD4n")) %>%
  ggplot(aes(x = CellTypeZ, y = cellDen, fill = interaction(CellTypeZ, LAProx), colour = interaction(CellTypeZ, LAProx)))  +
  geom_boxplot(position=position_dodge(0.90), width = 0.8, alpha = 0.65, lwd = 2.0, outlier.shape = NA) +
  scale_fill_manual(values = c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3", "#78C679", "#FEB24C", "#4292C6", "#B3B3B3")) +
    scale_colour_manual(values =c(wes_palette("Zissou1")[1], wes_palette("Zissou1")[1], wes_palette("Zissou1")[1], wes_palette("Zissou1")[1],wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5]))+
  coord_cartesian(ylim = c(0,2500)) +
  # scale_x_discrete(labels = c("DC", "Mac", "CD4+ TC", "CD4- TC")) +
   # scale_fill_manual(values = c("#78C679", "#B3B3B3", "#78C679", "#B3B3B3")) +
    # scale_colour_manual(values =c(wes_palette("Zissou1")[1], wes_palette("Zissou1")[1], wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5])) +
  # coord_cartesian(ylim = c(0,400)) +
  scale_x_discrete(labels = c("DC", "Mac", "CD4+ TC", "CD4- TC")) +
  theme_classic() +
   theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 23,
                                       face="plain",
                                       vjust= 0.9,
                                       # vjust= -2.0,
                                       angle = 45,
                                       # hjust = 0.5),
                                       hjust = 1.0),
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 23,
                                       face="plain",
                                       vjust= 0.4),
              plot.margin = unit(c(1,1,1,1), "cm"))

ggsave("plot1.png", width = 21, height = 16, units = "cm", dpi = 300)

dfTest = dfAnn %>%
  dplyr::filter(CellTypeZ == "CD11c") %>%
  pivot_wider(names_from = LAProx, values_from = cellDen)

wilcox.test(dfTest$LAClose, dfTest$LAFar, paired = TRUE)

```

## Figure 2 - What is the average density of LAs across donors? (TO DO)

```{r echo = FALSE}

# Get mucosa area

df = cellData %>%
  # dplyr::filter(batch == "new") %>%
  # dplyr::filter(Condition == "ori") %>%
  group_by(DonorNo, Image) %>%
  dplyr::filter(
             (sum(Compartments == "LP") > 0) &
             (sum(Compartments == "LA") > 0)) %>%
  dplyr::filter(Compartments != "SM" & Compartments != "Undefined") %>%
  mutate(sumArea = sum(NucArea)/(((3.07^2)*10^6))) %>%
  summarise(sumArea = mean(sumArea))


# Get LA number in each image

df1 = cellData %>%
  group_by(DonorNo, Image, laID) %>%
  dplyr::filter(Compartments == "LA") %>%
  mutate(minLP = min(LPDist)) %>%
  dplyr::filter(minLP < 10*3.07) %>%
  slice_head(n=1) %>%
  group_by(DonorNo, Image) %>%
  add_count(name = "laNumber") %>%
  summarise(laNumber  = mean(laNumber))

df2 = left_join(df1, df)

df2 = df2 %>%
  group_by(DonorNo, Image) %>%
  mutate(laDen = laNumber/sumArea)

df2 %>%
  drop_na(laDen) %>%
  group_by(DonorNo) %>%
  summarise(laDen = mean(laDen)) %>%
  ggplot(aes(x = " ", y = laDen, fill = "red")) +
  # geom_bar(stat = "summary", alpha = 0.65) +
  geom_boxplot(position=position_dodge(1.0), width = 0.8, alpha = 0.65, lwd = 2.0, outlier.shape = NA) +
  geom_dotplot(position=position_dodge(0.85), binaxis='y', stackdir = "center", dotsize=0.65, show.legend = FALSE, alpha = 0.65, binwidth = 2/15) +
  # geom_point() +
  # geom_violin(width = 0.9, alpha =0.6, trim = FALSE, lwd = 1.0) +
  scale_fill_manual(values = c("#666666")) +
  coord_cartesian(ylim = c(0,1.6)) +
  # scale_x_discrete(labels = c("DC", "Mac", "CD4+ TC", "CD4- TC")) +
  theme_minimal_hgrid(12) +
  # theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 18,
                                       face="plain",
                                       vjust= -2.0,
                                       angle = 0,
                                       hjust = 0.55),
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 21,
                                       face="plain",
                                       vjust= 0.4),
              plot.margin = unit(c(1,1,1,1), "cm"))

  
ggsave("plot1.png", width = 8, height = 14, units = "cm", dpi = 300)



```
## Figure 2 - What is the cellNumber, size in mm2 and diameter of LAs? (TO DO)

```{r echo = FALSE}

# NOTE: LAInner measurement only exists for HIV. Need to generate for the Mock and Ori samples

# Average LA size and diameter

df = cellData %>%
  group_by(DonorNo, Image) %>%
  dplyr::filter(
             (sum(Compartments == "LP") > 0) &
             (sum(Compartments == "LA") > 0)) %>%
  dplyr::filter(Compartments == "LA") %>%
   mutate(minLP = min(LPDist)) %>%
  dplyr::filter(minLP < 10*3.07) %>%
  group_by(DonorNo, Image, laID) %>%
  add_count(name = "cellNo") %>%
  mutate(Area = sum(NucArea)/(((3.07^2)*10^6))) %>%
  mutate(Diameter = (max(LAInnerDist)*2)/3.07) %>%
  summarise(cellNo = mean(cellNo), Area = mean(Area), Diameter = mean(Diameter))

df %>%
  group_by(DonorNo) %>%
  summarise(cellNo = mean(cellNo, na.rm = TRUE)) %>%
  ggplot(aes(x = " ", y = cellNo, fill = "red")) +
  # geom_bar(stat = "summary", alpha = 0.65) +
  geom_boxplot(position=position_dodge(1.0), width = 0.8, alpha = 0.65, lwd = 1.0, outlier.shape = NA) +
  geom_dotplot(position=position_dodge(0.85), binaxis='y', stackdir = "center", dotsize=0.65, show.legend = FALSE, alpha = 0.65, binwidth = 5000/17) +
  # geom_dotplot(position=position_dodge(0.85), binaxis='y', stackdir = "center", dotsize=0.65, show.legend = FALSE, alpha = 0.65, binwidth = 0.3/17) +
  # geom_dotplot(position=position_dodge(0.85), binaxis='y', stackdir = "center", dotsize=0.65, show.legend = FALSE, alpha = 0.65, binwidth = 380/17) +
  # geom_point() +
  # geom_violin(width = 0.9, alpha =0.6, trim = FALSE, lwd = 1.0) +
  scale_fill_manual(values = c("#666666")) +
  # coord_cartesian(ylim = c(0,1.6)) +
  # scale_x_discrete(labels = c("DC", "Mac", "CD4+ TC", "CD4- TC")) +
  theme_minimal_hgrid(12) +
  # theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 18,
                                       face="plain",
                                       vjust= -2.0,
                                       angle = 0,
                                       hjust = 0.55),
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 14,
                                       face="plain",
                                       vjust= 0.4))
              # plot.margin = unit(c(1,1,1,1), "cm"))

  
ggsave("plot1.png", width = 3, height = 12, units = "cm", dpi = 300)


```


## Figure 3 - What is the false positive detection rate of HIV in mock samples? (TO DO)

```{r echo = FALSE}

df = cellData %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  dplyr::filter(batch =="new") %>%
  dplyr::filter(Compartments != "Undefined") %>%
  group_by(DonorNo) %>% 
  add_count() %>%
  mutate(sumArea = sum(NucArea)/(((3.07^2)*10^6))) %>%
  mutate(hivSum = sum(hivCount)) %>%
  mutate(cellRate = hivSum/n) %>%
  mutate(areaRate = hivSum/sumArea) %>%
  summarise(cellRate = mean(cellRate), areaRate = mean(areaRate))

df

```


## Figure 3 - Is HIV Associating more with target cells (grouped) than other cells? (TO DO)

```{r echo = FALSE}

## Is HIV associating more with target cells (grouped) than other cells?

#NOTE: For new and old data graphs, only difference is in the CellType2 definition below when constructing df. 

# Run this for new batch data
df = cellData %>%
  dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  dplyr::filter(Compartments != "Undefined") %>%
  dplyr::filter(CellTypeZ != "MDDC") %>%
  group_by(Condition, DonorNo, ImageID) %>%
  mutate(CellType2 = case_when(
      (CellTypeZ == "CD11c") ~ "targetCell",
      (CellTypeZ == "FXIIIa")  ~ "targetCell",
      (CellTypeZ == "CD3CD4p")  ~ "targetCell",
      (CellTypeZ == "Unknown")  ~ "otherCell",
      (CellTypeZ == "CD3CD4n")  ~ "otherCell",
      TRUE ~ as.character("toDelete"))) %>%
  dplyr::filter(CellType2 != "toDelete")

# Run this for old batch data

df = cellData %>%
  dplyr::filter(batch == "old") %>%
  dplyr::filter(Condition == "hivBal") %>%
  dplyr::filter(Compartments != "Undefined") %>%
  dplyr::filter(CellTypeZ != "CD3") %>%
  group_by(Condition, DonorNo, ImageID) %>%
  mutate(CellType2 = case_when(
      (CellTypeZ == "CD11c") ~ "targetCell",
      (CellTypeZ == "FXIIIa")  ~ "targetCell",
      (CellTypeZ == "Unknown")  ~ "otherCell",
      TRUE ~ as.character("toDelete"))) %>%
  dplyr::filter(CellType2 != "toDelete")

  
dfDen = df %>%
  group_by(ImageID) %>%
  mutate(sumArea = sum(NucArea)/(((3.07^2)*10^6))) %>%
  mutate(hivSum = sum(hivCount)) %>%
  mutate(hivDen = hivSum/sumArea) %>%
  summarise(hivDen = mean(hivDen))
  
df = df %>%
  select(Condition, DonorNo, ImageID, CellType2, hivCount) %>%
  ungroup()

#Get proportion of cells that are targetCells or otherCells
cellProp = df %>%
  group_by(Condition, DonorNo, ImageID, CellType2) %>%
  count() %>%
  group_by(ImageID) %>%
  mutate(sumCell = sum(n)) %>%
  ungroup() %>%
  mutate(propCell = n/sumCell) %>%
  mutate(CellType2 = factor(CellType2, levels = c("otherCell", "targetCell")))

## START NOT USED ####

#get proportion of HIV+ cells that are targetCells or other Cells
# hivCellProp = df %>%
#   dplyr::filter(hivCount > 0) %>%
#   group_by(DonorNo, Image, CellType2) %>%
#   count() %>%
#   group_by(Image) %>%
#   mutate(sumHIVCell = sum(n)) %>%
#   ungroup() %>%
#   mutate(propHIVCell = n/sumHIVCell) %>%
#   mutate(CellType2 = factor(CellType2, levels = c("targetCell", "otherCell")))
# 
# 
# prop = left_join(cellProp, hivCellProp, by = c("Image", "CellType2")) %>%
#   select(DonorNo.x, Image, CellType2, propCell, propHIVCell) %>%
#   mutate(HIVminusCell = propHIVCell - propCell) %>%
#   pivot_longer(cols = c("propCell", "propHIVCell", "HIVminusCell"), names_to = "Prop", values_to = "Values")
# 
# prop$CellType2 = factor(prop$CellType2, levels = c("targetCell", "otherCell", "HIVminusCell"))
# 
# prop %>% dplyr::filter(Prop != "HIVminusCell") %>%
# ggplot(aes(x = Prop, y = Values, fill = CellType2)) + 
#   geom_bar(position="fill", stat="identity", width = 0.9, alpha =0.65) +
#   scale_fill_manual(values = c("#E31A1C", "#737373")) +
#   theme_classic() +
#   theme(plot.title=element_text(size=20,
#                                 face="bold",
#                                 family="American Typewriter",
#                                 color="black",
#                                 hjust=0.5,
#                                 lineheight=10.0,
#                                 margin = margin(t =0, r = 0, b = 20, l = 0)), # title
#         axis.title.x=element_text(vjust= -4,
#                                   size=15), # X axis title
#         axis.title.y=element_text(vjust = 4,
#                                   size=15),
#         axis.text.x=element_text(size = 18,
#                                  angle = 0,
#                                  face="bold",
#                                  vjust= -2),  # X axis text
#         axis.text.y=element_text(size = 18,
#                                  face="bold",
#                                  vjust= 0.4,
#                                  hjust = 5),    # Y axis text
#         legend.title = element_text(size = 14),
#         legend.text = element_text(size =10),
#         plot.margin = unit(c(0.65,0.65,0.65,0.65), "cm"))  # Y axis title
# 
# #Plotting difference between cellProportion and hivCellProportion for target Cells, for each Image.
# prop1 = prop %>% 
#   dplyr::filter(CellType2 == "targetCell") %>%
#   dplyr::filter(Prop == "HIVminusCell") %>%
#   arrange(desc(Values)) %>%
#   mutate(Image = fct_reorder(Image, desc(Values)))
# 
# ggplot(prop1, aes(x = Image, y = Values, fill = Prop)) + 
#   geom_bar(position="stack", stat="identity") +
#   theme_classic() +
#   theme(axis.text.x = element_text(angle = 90))
# 
# 
# #Plotting total HIV in image, ordered by Images in above plot
# order = unique(prop1$Image)
# 
# hivTot = df %>% 
#   group_by(Image) %>%
#   summarise(totalHIV = sum(hivCount)) %>%
#   ungroup() %>%
#   mutate(Image = factor(Image, levels = order))
# 
#  ggplot(hivTot, aes(x = Image, y= totalHIV)) + 
#   geom_bar(position="stack", stat="identity") +
#   theme_classic() +
#   theme(axis.text.x = element_text(angle = 90))
  
 
##END NOT USED ####

# Plotting Proportion of total HIV in image in either otherCell or targetCell compartment

hivProp = df %>%
  group_by(ImageID, CellType2) %>%
  summarise(cellHIV = sum(hivCount)) %>%
  ungroup() %>%
  group_by(ImageID) %>%
  mutate(sumHIV = sum(cellHIV)) %>%
  ungroup() %>%
  mutate(propHIV = cellHIV/sumHIV)

prop = left_join(cellProp, hivProp, by = c("ImageID", "CellType2")) %>%
  select(Condition, DonorNo, ImageID, CellType2, propCell, propHIV, cellHIV, sumHIV) %>%
  mutate(HIVminusCell = propHIV - propCell) %>%
  mutate(HIVOverCell = propHIV/propCell) %>%
  pivot_longer(cols = c("propCell", "propHIV", "HIVminusCell", "HIVOverCell", "cellHIV", "sumHIV"), names_to = "Prop", values_to = "Values") %>%
  drop_na() 


prop$CellType2 = factor(prop$CellType2, levels = c("targetCell", "otherCell"))
prop$Prop = factor(prop$Prop, levels = c("propCell", "propHIV", "HIVminusCell","HIVOverCell", "cellHIV", "sumHIV"))


# Showing the data of just targetCell percentage increase

g0 = prop %>% 
  dplyr::filter(Prop %in% c("propCell", "propHIV")) %>%
  dplyr::filter(CellType2 != "otherCell") %>%
  mutate(Prop = factor(Prop, levels = c("propHIV", "propCell"))) %>%
ggplot(aes(x = Prop, y = Values*100, fill = Prop)) +
  geom_violin(position=position_dodge(1.0), width = 1.1, alpha = 0.65, trim = FALSE, lwd = 1.5) +
  geom_boxplot(position=position_dodge(1.0), width = 0.1, lwd = 1.0) +
  coord_flip() +
  # scale_fill_manual(values = c(wes_palette("Royal1")[1],wes_palette("Royal1")[2])) +
  scale_fill_manual(values = c(wes_palette("FantasticFox1")[5], wes_palette("Zissou1")[1])) +
  # coord_cartesian(xlim = c(-8,70)) +
  theme_minimal_vgrid(12) +
  scale_x_discrete(labels = c("HIV Percentage", "Cell Percentage")) +
  scale_y_continuous(position = "right",
                     limits = c(-8,70)) +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 18,
                                       face="plain",
                                       vjust= -0.4,
                                       hjust = 0.5),    # Y axis text
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4,
                                       hjust = 0),    # Y axis text
              plot.margin = unit(c(4,1,4,1), "cm"))    # Y axis title

g0

ggsave("plot4.png", width = 18, height = 14, units = "cm", dpi = 300)


# Get wilcox rank sum statistic to compare violin plots

dfTest = prop %>%
  dplyr::filter(Prop != "HIVminusCell" & Prop != "HIVOverCell") %>%
  pivot_wider(names_from = c(CellType2,Prop), values_from = Values)

wilcox.test(dfTest$targetCell_propCell, dfTest$otherCell_propHIV, paired = TRUE)


#order

order = prop %>% 
  dplyr::filter(Prop == "propHIV") %>%
  dplyr::filter(CellType2 != "otherCell") %>%
  arrange(desc(Values)) %>%
  mutate(ImageID = factor(ImageID, levels = unique(ImageID))) %>%
  select(ImageID)

# HIV Proportion
g1 = prop %>% 
  dplyr::filter(Prop == "propHIV") %>%
  dplyr::filter(CellType2 != "otherCell") %>%
  mutate(ImageID = factor(ImageID, levels = order$ImageID)) %>%
ggplot(aes(x = ImageID, y = Values*100, fill = Condition)) + 
  geom_bar(position="dodge", stat="identity", lwd = 1.5) +
  scale_fill_manual(values = c(wes_palette("Zissou1")[1], wes_palette("Zissou1")[3])) +
  # geom_hline(yintercept = 1.0, linetype = "dashed", lwd = 1.0, colour = "red") +
  # coord_cartesian(ylim = c(-6, 42)) +
  theme_classic() +
  theme(
    legend.position = "none",
          # axis.line.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.title = element_blank(),
          # axis.text.x = element_blank(),
        axis.text.x=element_text(size = 10,
                                   face = "plain" ,
                                   vjust= 0.0,
                                   hjust = 0.5),    # Y axis text  
        axis.text.y=element_text(size = 18,
                                   face="plain",
                                   vjust= 0.4,
                                   hjust = 0.2))    # Y axis text
g1  


# g1 = as.ggplot(g1, hjust = 0.005, scale = 0.97)

ggsave("plot1.png", width = 24, height = 10, units = "cm", dpi = 300)

# HIV enichment

g1 = prop %>% 
  dplyr::filter(Prop == "HIVOverCell") %>%
  dplyr::filter(CellType2 != "otherCell") %>%
  mutate(ImageID = factor(ImageID, levels = order$ImageID)) %>%
ggplot(aes(x = ImageID, y = log2(Values), fill = Condition)) + 
  geom_bar(position="dodge", stat="identity", lwd = 1.5) +
  scale_fill_manual(values = c(wes_palette("Zissou1")[1], wes_palette("Zissou1")[3])) +
  # geom_hline(yintercept = 1.0, linetype = "dashed", lwd = 1.0, colour = "red") +
  # coord_cartesian(ylim = c(-6, 42)) +
  theme_classic() +
  theme(
    legend.position = "none",
          # axis.line.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.title = element_blank(),
          # axis.text.x = element_blank(),
        axis.text.x=element_text(size = 10,
                                   face = "plain" ,
                                   vjust= 0.0,
                                   hjust = 0.5),    # Y axis text  
        axis.text.y=element_text(size = 18,
                                   face="plain",
                                   vjust= 0.4,
                                   hjust = 0.2))    # Y axis text
g1  

ggsave("plot1.png", width = 24, height = 10, units = "cm", dpi = 300)

## Make chi square test annotation.

dfTest = prop %>%
  dplyr::filter(Prop != "HIVminusCell" & Prop != "HIVOverCell") %>%
  pivot_wider(names_from = c(CellType2,Prop), values_from = Values) %>%
  drop_na()

a = rep(NA, length(dfTest$Condition))
dfChi = data.frame(a)
colnames(dfChi)[1] = "pVal"

for(i in 1:length(dfTest$ImageID)) {
  
  values = c(dfTest$targetCell_cellHIV[i], dfTest$otherCell_cellHIV[i])
  expected = c(dfTest$targetCell_propCell[i], dfTest$otherCell_propCell[i])
  dfChi$pVal[i] = chisq.test(values, p = expected)$p.value
}

dfTest = cbind(dfTest, dfChi)

donors = length(unique(dfTest$DonorNo))

# Chi square result annotation (comment in and out the two scale_fill_manuals for old and new batches)
g2 = dfTest %>% 
  mutate(pValCut = case_when(
    pVal >= 0.05  ~ "1",
    pVal < 0.05 & (targetCell_propHIV < targetCell_propCell)  ~ "2",
    pVal < 0.05 & (targetCell_propHIV > targetCell_propCell)  ~ "3",
    TRUE~as.character("toDelete")))  %>%
  dplyr::filter(pValCut != "toDelete") %>%
  mutate(pValCut = factor(pValCut, levels = c("1", "2","3"))) %>%
  mutate(ImageID = factor(ImageID, levels = order$ImageID)) %>%
ggplot(aes(x = ImageID, y = 1, fill = pValCut)) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_manual(values = c("#B3B3B3", wes_palette("Darjeeling2")[2], wes_palette("Darjeeling1")[1])) +
  # scale_fill_manual(values = c(wes_palette("Darjeeling2")[2], wes_palette("Darjeeling1")[1])) +
  theme_classic() +
  theme(
    legend.position = "none",
        line = element_blank(),
        axis.title = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y= element_blank())   # Y axis text
g2

# For new batch
ggsave("plot2.png", width = 24, height = 1, units = "cm", dpi = 300)
# For old batch
ggsave("plot2.png", width = 24, height = 1.25, units = "cm", dpi = 300)


# DonorNo Annotation
g2 = dfTest %>% 
  mutate(ImageID = factor(ImageID, levels = order$ImageID)) %>%
  mutate(DonorNo = factor(DonorNo)) %>%
ggplot(aes(x = ImageID, y = 1, fill = DonorNo)) + 
  geom_bar(position="dodge", stat="identity") +
  scale_fill_manual(values = colorRampPalette(brewer.pal(12, "Paired"))(donors)) +
  labs(fill = "Donors") +
  theme_classic() +
  theme(
    # legend.position = "none",
        line = element_blank(),
        axis.title = element_blank(),
        axis.text.x = element_blank(),
        axis.text.y= element_blank())   # Y axis text
g2

#for the graph new batch
ggsave("plot2.png", width = 24, height = 1, units = "cm", dpi = 300)
#for the graph old batch
ggsave("plot2.png", width = 24, height = 1.25, units = "cm", dpi = 300)

# For the legend:
ggsave("plot2.png", width = 24, height = 12, units = "cm", dpi = 300)



# Saving Images to keep for analysis

toKeep = dfTest %>% 
  mutate(pValCut = case_when(
    pVal >= 0.05  ~ "1",
    pVal < 0.05 & (targetCell_propHIV < targetCell_propCell)  ~ "2",
    pVal < 0.05 & (targetCell_propHIV > targetCell_propCell)  ~ "3",
    TRUE~as.character("toDelete")))  %>%
  dplyr::filter(pValCut == "3")

toKeep = unique(toKeep$ImageID)
  

temp = prop %>%
  dplyr::filter(CellType2 == "targetCell" & Prop == "propHIV")

temp2 = dfTest %>%
  mutate(pValCut = case_when(
   pVal >= 0.05  ~ "1",
    pVal < 0.05 & (targetCell_propHIV < targetCell_propCell)  ~ "2",
    pVal < 0.05 & (targetCell_propHIV > targetCell_propCell)  ~ "3",
    TRUE~as.character("toDelete")))  %>%
  dplyr::filter(pValCut != "toDelete") %>%
  mutate(pValCut = factor(pValCut, levels = c("1", "2", "3"))) %>%
  select(ImageID, pValCut)
  

dfTest2 = left_join(temp, dfDen)
dfTest2 = left_join(dfTest2, temp2)

dfTest2 %>%
  ggplot(dfTest2, aes(x = hivDen, y = Values, colour = factor(pValCut))) +
  geom_point() +
  geom_smooth(method = "lm")

ggsave("plot3.png", width = 10, height = 10, units = "cm", dpi = 300)


test = dfTest2 %>%
  dplyr::filter(hivDen > 30 & hivDen < 1000)

a = cor.test(test$hivDen, test$Values, method = "pearson")

a


# Graphing HIV density to annotate on top of figure
# Raising miniumum density to 25 particles per mm2 for visual purposes (can't see the values lower than this when the graph dimensions reduced)

dfTest2 %>%
   mutate(ImageID = factor(ImageID, levels = order$ImageID)) %>%
   mutate(DonorNo = factor(DonorNo)) %>%
   mutate(hivDen = case_when(
    hivDen < 25 ~ 25,
    TRUE ~ as.double(hivDen))) %>%
  ggplot(aes(x = ImageID, y = hivDen)) +
  geom_bar(stat ="identity") +
    theme_classic() +
    theme(
    legend.position = "none",
          axis.line.x = element_blank(),
          axis.ticks.x = element_blank(),
          axis.title = element_blank(),
          axis.text.x = element_blank(),
        # axis.text.x=element_text(size = 10,
        #                            face = "plain" ,
        #                            vjust= 0.0,
        #                            hjust = 0.5),    # Y axis text  
        axis.text.y=element_text(size = 14,
                                   face="plain",
                                   vjust= 0.4,
                                   hjust = 0.2))    # Y axis text
         
ggsave("plot4.png", width = 24, height = 2.5, units = "cm", dpi = 300)



# Scatter plot of hivProp vs hivProp/cellProp

prop %>%
  dplyr::filter(Prop %in% c("HIVOverCell", "propHIV")) %>%
  dplyr::filter(CellType2 == "targetCell") %>%
  pivot_wider(names_from = Prop, values_from = Values) %>%
  ggplot(aes(x = propHIV*100, y = log2(HIVOverCell))) +
  geom_point(size = 3, alpha = 0.65, colour = "red") +
  geom_smooth(method = "lm", colour = "#B3B3B3") +
  theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 16,
                                       face="plain",
                                       vjust= -0.4,
                                       hjust = 0.5),    # Y axis text
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 16,
                                       face="plain",
                                       vjust= 0.4,
                                       hjust = 0),    # Y axis text
              plot.margin = unit(c(1,1,1,1), "cm"))    # Y axis title

ggsave("plot4.png", width = 12, height = 12, units = "cm", dpi = 300)


dfTest = prop %>%
  dplyr::filter(Prop %in% c("HIVOverCell", "propHIV")) %>%
  dplyr::filter(CellType2 == "targetCell") %>%
  pivot_wider(names_from = Prop, values_from = Values)

cor.test(dfTest$propHIV, dfTest$HIVOverCell, method = "pearson")

```


## Figure 3 - What is the relative proportion of HIV particles interacting with each subset in whole tissue? (TO DO)

```{r eval = FALSE, echo = FALSE}

df = cellData %>%
   dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  # dplyr::filter(Condition == "hivTF") %>%
  dplyr::filter(Compartments != "Undefined") %>%
  group_by(DonorNo, Image) %>%
  dplyr::filter(
           (sum(Compartments == "LP") > 0) &
           (sum(Compartments == "EP") > 0)) %>%
  group_by(Condition, DonorNo, blockID, Image, CellTypeZ) %>%
  summarise(CellTypeHIV = sum(hivCount)) %>%
  group_by(Condition, DonorNo, blockID, Image)  %>%
  mutate(totalHIV = sum(CellTypeHIV)) %>%
  mutate(propHIV = (CellTypeHIV/totalHIV)*100) %>%
  group_by(Condition, DonorNo, blockID, CellTypeZ) %>%
  summarise(propHIV = mean(propHIV)) %>%
  dplyr::filter(CellTypeZ != "Unknown") %>%
  dplyr::filter(CellTypeZ != "MDDC")


## CellProp

cellProp = cellData %>%
  dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  # dplyr::filter(Condition == "hivTF") %>%
  dplyr::filter(Compartments != "Undefined") %>%
  group_by(DonorNo, blockID, Image) %>%
  dplyr::filter(
           (sum(Compartments == "LP") > 0) &
           (sum(Compartments == "EP") > 0)) %>%
  group_by(Condition, DonorNo,blockID, Image) %>%
  add_count(name = "totalCellNo") %>%
  group_by(Condition, DonorNo,blockID, Image, CellTypeZ) %>%
  add_count(name = "cellTypeNo") %>%
  mutate(cellProp = (cellTypeNo/totalCellNo)*100) %>%
  group_by(Condition, DonorNo, blockID, CellTypeZ) %>%
  summarise(cellProp = mean(cellProp)) %>%
  dplyr::filter(CellTypeZ != "Unknown") %>%
  dplyr::filter(CellTypeZ != "MDDC")


propCellHIV = left_join(df, cellProp) %>%
  drop_na(propHIV) %>%
  # drop_na(Image) %>%
  pivot_longer(c("cellProp", "propHIV"), names_to = "whichProp", values_to = "prop")
  
propCellHIV$DonorNo = as.factor(propCellHIV$DonorNo)
propCellHIV$blockID = as.factor(propCellHIV$blockID)

# propCellHIV$Image = as.factor(propCellHIV$Image)

propCellHIV$CellTypeZ = factor(propCellHIV$CellTypeZ, levels = c("CD11c", "FXIIIa","CD3CD4p", "CD3CD4n"))


propCellHIV %>%
ggplot(aes(x = CellTypeZ, y= prop, fill = interaction(CellTypeZ, whichProp), colour = interaction(CellTypeZ, whichProp))) + 
  # geom_bar(stat = "summary", fun.y = "mean",  position=position_dodge(0.90), width = 0.8, alpha = 0.65, lwd = 1.5) +
  # geom_dotplot(position=position_dodge(0.85), binaxis='y', stackdir = "center", dotsize=0.65, show.legend = FALSE, alpha = 0.4, binwidth = 30/30) +
  geom_boxplot(position=position_dodge(0.90), width = 0.8, alpha = 0.65, lwd = 2.0, outlier.shape = NA) +
  scale_fill_manual(values =c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3", "#78C679", "#FEB24C", "#4292C6", "#B3B3B3"),
                        name = "Cell Type",
                        labels = c("DC cellProp", "DC hivProp", "Mac cellProp", "Mac hivProp", "CD4p cellProp",
                                   "CD4p hivProp", "CD4n cellProp", "CD4n hivProp")) +
  scale_colour_manual(values =c(wes_palette("Zissou1")[1], wes_palette("Zissou1")[1], wes_palette("Zissou1")[1], wes_palette("Zissou1")[1],wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5]))+
  coord_cartesian(ylim = c(0,23)) + 
  scale_x_discrete(labels = c("DC", "Mac", "CD4+ TC", "CD4- TC")) +
  theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 21,
                                       face="plain",
                                       vjust= -0.4,
                                       hjust = 0.5),    # Y axis text
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 21,
                                       face="plain",
                                       vjust= 0.4,
                                       hjust = 0),    # Y axis text
              plot.margin = unit(c(1,1,1,1), "cm"))    # Y axis title

ggsave("plot4.png", width = 18, height = 16, units = "cm", dpi = 300)


# wilcox rank sum test to compare cellprop and HIVProp

dfTest = propCellHIV %>%
  pivot_wider(names_from = c(whichProp), values_from = prop) %>%
  dplyr::filter(CellTypeZ == "CD11c")

wilcox.test(dfTest$cellProp, dfTest$propHIV, paired = TRUE)



## Normalising by cellProp and then doing wilcox test to compare across CellType

# plotting hivProp/cellProp

propCellHIV %>%
  pivot_wider(names_from = whichProp, values_from = prop) %>%
  mutate(HIVOverCell = propHIV/cellProp) %>%
ggplot(aes(x = CellTypeZ, y= log2(HIVOverCell), fill = CellTypeZ)) +
  geom_boxplot(position=position_dodge(0.90), width = 0.8, alpha = 0.65, lwd = 2.0, outlier.shape = NA) +
  scale_fill_manual(values =c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3")) +
  geom_hline(yintercept = 0.0, linetype = "dashed", lwd = 1.25, colour = "black") +
  coord_cartesian(ylim = c(-2,3)) +
  # scale_y_continuous(position = "right")
  scale_x_discrete(labels = c("DC", "Mac", "CD4+ TC", "CD4- TC")) +
  theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 21,
                                       face="plain",
                                       vjust= -0.4,
                                       hjust = 0.5),    # Y axis text
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 21,
                                       face="plain",
                                       vjust= 0.4,
                                       hjust = 0),    # Y axis text
              plot.margin = unit(c(1,1,1,1), "cm"))    # Y axis title

ggsave("plot4.png", width = 18, height = 16, units = "cm", dpi = 300)


#Dimension for figure 1 mock figure #
propCellHIV %>%
  pivot_wider(names_from = whichProp, values_from = prop) %>%
  mutate(HIVOverCell = propHIV/cellProp) %>%
ggplot(aes(x = CellTypeZ, y= log2(HIVOverCell), fill = CellTypeZ)) +
  geom_boxplot(position=position_dodge(0.90), width = 0.8, alpha = 0.65, lwd = 1.5, outlier.shape = NA) +
  scale_fill_manual(values =c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3")) +
  geom_hline(yintercept = 0.0, linetype = "dashed", lwd = 1.25, colour = "black") +
  coord_cartesian(ylim = c(-1.5,3)) +
  scale_x_discrete(labels = c("DC", "Mac", "CD4+ TC", "CD4- TC")) +
  theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 21,
                                       face="plain",
                                       vjust= -0.4,
                                       hjust = 0.5),    # Y axis text
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 21,
                                       face="plain",
                                       vjust= 0.4,
                                       hjust = 0))    # Y axis text
              # plot.margin = unit(c(1,1,1,1), "cm"))    # Y axis title
ggsave("plot1.png", width = 8, height = 5, units = "cm", dpi = 300)

#


dfTest= propCellHIV %>%
  pivot_wider(names_from = whichProp, values_from = prop) %>%
  mutate(HIVOverCell = log2(propHIV/cellProp)) %>%
  select(Condition, DonorNo, blockID, CellTypeZ, HIVOverCell) %>%
  pivot_wider(names_from = CellTypeZ, values_from = HIVOverCell) 


wilcox.test(dfTest$CD11c, dfTest$FXIIIa, paired = TRUE)
wilcox.test(dfTest$CD11c, dfTest$CD3CD4p, paired = TRUE)
wilcox.test(dfTest$CD11c, dfTest$CD3CD4n, paired = TRUE)

wilcox.test(dfTest$FXIIIa, dfTest$CD3CD4p, paired = TRUE)
wilcox.test(dfTest$FXIIIa, dfTest$CD3CD4n, paired = TRUE)

wilcox.test(dfTest$CD3CD4p, dfTest$CD3CD4n, paired = TRUE)


propCellHIV %>%
  pivot_wider(names_from = whichProp, values_from = prop) %>%
  mutate(HIVOverCell = propHIV/cellProp) %>%
  dplyr::filter(CellTypeZ %in% c("CD3CD4p", "Unknown")) %>%
ggplot(aes(x = CellTypeZ, y= HIVOverCell, fill = CellTypeZ)) +
  geom_boxplot(position=position_dodge(0.90), width = 0.8, alpha = 0.65, lwd = 1.5, outlier.shape = NA) +
  scale_fill_manual(values =c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3")) +
  geom_hline(yintercept = 1.0, linetype = "dashed", lwd = 1.25, colour = "grey70") +
  # coord_cartesian(ylim = c(0,23)) + 
  theme_classic() +
  theme(
    legend.position = "none",
          axis.title.x=element_blank(),
          axis.text.x=element_blank(),
          axis.title.y=element_blank(),
          axis.text.y=element_text(size = 24,
                                   face="plain",
                                   vjust= 0.4,
                                   hjust = 0),    # Y axis text
        #   legend.title = element_text(size = 14),
        #   legend.text = element_text(size =10),
          plot.margin = unit(c(1,1,1,1), "cm"))    # Y axis title



## Get wald statistics and then perform wilcox rank sum test (not used) ####

df = cellData %>%
   dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  dplyr::filter(Compartments != "Undefined") %>%
  group_by(Condition, DonorNo, blockID, Image) %>%
  dplyr::filter(
           (sum(Compartments == "LP") > 0) &
           (sum(Compartments == "EP") > 0)) %>%
  group_by(Condition, DonorNo, blockID, Image, CellTypeZ) %>%
  summarise(CellTypeHIV = sum(hivCount)) %>%
  group_by(Condition, DonorNo, blockID, Image)  %>%
  mutate(totalHIV = sum(CellTypeHIV)) %>%
  mutate(propHIV = (CellTypeHIV/totalHIV)*100) %>%
  group_by(Condition, DonorNo, blockID, CellTypeZ) %>%
  summarise(totalHIV = mean(totalHIV), CellTypeHIV = mean(CellTypeHIV)) %>%
  dplyr::filter(CellTypeZ != "Unknown") %>%
  dplyr::filter(CellTypeZ != "MDDC")

df$otherCellHIV = df$totalHIV - df$CellTypeHIV

## CellProp

cellProp = cellData %>%
  dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  dplyr::filter(Compartments != "Undefined") %>%
  group_by(Condition, DonorNo, blockID, Image) %>%
  dplyr::filter(
           (sum(Compartments == "LP") > 0) &
           (sum(Compartments == "EP") > 0)) %>%
  group_by(Condition, DonorNo, blockID, Image) %>%
  add_count(name = "totalCellNo") %>%
  group_by(Condition, DonorNo,blockID, Image, CellTypeZ) %>%
  add_count(name = "cellTypeNo") %>%
  mutate(cellProp = (cellTypeNo/totalCellNo)*100) %>%
  group_by(Condition, DonorNo, blockID, CellTypeZ) %>%
  summarise(cellProp = mean(cellProp)) %>%
  dplyr::filter(CellTypeZ != "Unknown") %>%
  dplyr::filter(CellTypeZ != "MDDC")


dfTest = left_join(df, cellProp) 

dfTest$otherProp = 100 - dfTest$cellProp

# propCellHIV$DonorNo = as.factor(propCellHIV$DonorNo)
# propCellHIV$Image = as.factor(propCellHIV$Image)

# propCellHIV$CellTypeZ = factor(propCellHIV$CellTypeZ, levels = c("CD11c", "FXIIIa","CD3CD4p", "Unknown"))

a = rep(NA, length(dfTest$DonorNo))
dfChi = data.frame(a,a)
colnames(dfChi) = c("chiPvalue", "waldStat")

for(i in 1:length(dfTest$DonorNo)) {
  
  #Chi Square p value extraction for each row
  values = c(dfTest$CellTypeHIV[i], dfTest$otherCellHIV[i])
  expected = c(dfTest$cellProp[i]/100, dfTest$otherProp[i]/100)
  dfChi$chiPvalue[i] = chisq.test(values, p = expected)$p.value
  
  #Wald stat extraction for each row
  observed = dfTest$CellTypeHIV[i]
  expected = (dfTest$cellProp[i]/100)*dfTest$totalHIV[i]
  dfChi$waldStat[i] = (observed-expected)/sqrt(expected)
}

dfTest = cbind(dfTest, dfChi)
dfTest$hivProp = (dfTest$CellTypeHIV/dfTest$totalHIV)*100


# Plotting the wald statistcs

dfTest %>%
  ggplot(aes(x = CellTypeZ, y = waldStat, fill = CellTypeZ)) +
  geom_boxplot(position=position_dodge(0.90), width = 0.8, alpha = 0.65, lwd = 1.5, outlier.shape = NA) +
    geom_dotplot(position=position_dodge(0.85), binaxis='y', stackdir = "center", dotsize=0.65, show.legend = FALSE, alpha = 0.4, binwidth = 30/30) +
  scale_fill_manual(values =c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3")) +
  geom_hline(yintercept = 1.0, linetype = "dashed", lwd = 1.25, colour = "red") +
  # coord_cartesian(ylim = c(0,23)) + 
  theme_classic() +
  theme(
    legend.position = "none",
          axis.title.x=element_blank(),
          axis.text.x=element_blank(),
          axis.title.y=element_blank(),
          axis.text.y=element_text(size = 24,
                                   face="plain",
                                   vjust= 0.4,
                                   hjust = 0),    # Y axis text
        #   legend.title = element_text(size = 14),
        #   legend.text = element_text(size =10),
          plot.margin = unit(c(1,1,1,1), "cm"))    # Y axis title

ggsave("plot4.png", width = 12, height = 9, units = "cm", dpi = 300)



# Do wilcox signed rank test on the wald statistics

dfTest = dfTest %>%
  select(Condition, DonorNo, blockID, CellTypeZ, Image, waldStat) %>%
  pivot_wider(names_from = CellTypeZ, values_from = waldStat)

wilcox.test(dfTest$CD11c, dfTest$FXIIIa, paired = TRUE)
wilcox.test(dfTest$CD11c, dfTest$CD3CD4p, paired = TRUE)
wilcox.test(dfTest$CD11c, dfTest$Unknown, paired = TRUE)

wilcox.test(dfTest$FXIIIa, dfTest$CD3CD4p, paired = TRUE)
wilcox.test(dfTest$FXIIIa, dfTest$Unknown, paired = TRUE)

wilcox.test(dfTest$CD3CD4p, dfTest$Unknown, paired = TRUE)



# Old handwavy mehod

# dfTest2 = dfTest %>%
#   mutate(sig = case_when(
#     pVal < 0.05 & (hivProp > cellProp) ~ 1,
#     pVal >= 0.05 ~ 0,
#     pVal < 0.05 & (hivProp < cellProp) ~ -1,
#     TRUE~NA_real_)) %>%
#   group_by(CellTypeZ) %>%
#   add_count(name = "ImageNo") %>%
#   mutate(percPos = (sum(sig == 1)/ImageNo)*100) %>%
#   mutate(percNeg = (sum(sig==-1)/ImageNo)*100) %>%
#   mutate(aScore = sum(sig))
  


```
## Figure 3 - What is the percentage of each subset interacting with HIV? (To do)

```{r eval = FALSE, echo = FALSE}

df = cellData %>% 
  dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal") %>%
  # dplyr::filter(Condition == "hivTF") %>%
  dplyr::filter(Compartments != "Undefined") %>%
  group_by(Condition, DonorNo, blockID, Image, CellTypeZ) %>%
  mutate(imageTotalHIV = sum(hivCount)) %>%
  group_by(Condition, DonorNo, blockID, Image) %>%
  add_count(CellTypeZ, name = "totalCells") %>%
  dplyr::filter(hivCount > 0) %>%
  add_count(CellTypeZ, name = "hivPosCells") %>%
  mutate(PercCellHIVPos = (hivPosCells/totalCells)*100) %>%
  group_by(Condition, DonorNo, blockID, CellTypeZ) %>%
  summarise(percCell = mean(PercCellHIVPos)) %>%
  ungroup() %>%
  dplyr::filter(CellTypeZ %in% c("CD11c", "FXIIIa", "CD3CD4p", "Unknown"))


df$CellTypeZ = factor(df$CellTypeZ, levels = c("CD11c", "FXIIIa", "CD3CD4p", "Unknown"))
df$DonorNo = factor(df$DonorNo)
df$blockID = factor(df$blockID)

          
# Normal GGPlot

ggplot(df, aes(x = CellTypeZ, y= percCell, fill = CellTypeZ)) + 
  # geom_bar(stat = "summary", fun.y = "mean", position=position_dodge(1.0), width = 0.6, alpha = 0.65, lwd = 2.0) +
  # geom_dotplot(position=position_dodge(1.0), binaxis='y', stackdir = "center", dotsize=0.65, show.legend = FALSE, alpha = 0.45, binwidth = 3/25) +  
  geom_boxplot(position=position_dodge(1.0), width = 0.80, alpha = 0.65, lwd = 2.0, outlier.shape =  NA) +
  scale_fill_manual(values = c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3"),
                      name = "Cell Type",
                      labels = c("DC", "Mac", "CD4 T-Cell", "CD4n T-Cell")) +
  # coord_cartesian(ylim = c(0,10)) +
  # scale_y_continuous(breaks = c(0,2,4,6,8,10),
  #                  labels = c("0","2","4","6","8","10")) +
  scale_x_discrete(labels = c("DC", "Mac", "CD4+TC", "CD4-TC")) +
  theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 18,
                                       face="plain",
                                       vjust= -0.4,
                                       hjust = 0.5),    # Y axis text
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 21,
                                       face="plain",
                                       vjust= 0.4,
                                       hjust = 0),    # Y axis text
              plot.margin = unit(c(1,1,1,1), "cm"))    # Y axis title

ggsave("plot4.png", width = 14, height = 12, units = "cm", dpi = 300)

# Figure 1 Mock Figure dimensions
df %>%
  dplyr::filter(CellTypeZ == "CD11c") %>%
  ggplot(aes(x = CellTypeZ, y= percCell, fill = CellTypeZ)) + 
  geom_boxplot(position=position_dodge(1.0), width = 0.80, alpha = 0.65, lwd = 2.0, outlier.shape =  NA) +
  scale_fill_manual(values = c("#78C679")) +
  # coord_cartesian(ylim = c(0,10)) +
  # scale_y_continuous(breaks = c(0,2,4,6,8,10),
  #                  labels = c("0","2","4","6","8","10")) +
  theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 18,
                                       face="plain",
                                       vjust= -0.4,
                                       hjust = 0.5),    # Y axis text
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 21,
                                       face="plain",
                                       vjust= 0.4,
                                       hjust = 0),    # Y axis text
              plot.margin = unit(c(1,1,1,1), "cm"))    # Y axis title

ggsave("plot1.png", width = 6, height = 8, units = "cm", dpi = 300)

#

# Wilcox test to compare percentage HIV+

dfTest = df %>%
  pivot_wider(names_from = CellTypeZ, values_from = percCell) 

wilcox.test(dfTest$CD3CD4p, dfTest$Unknown, paired = TRUE)




# df$Compartments = factor(df$Compartments, levels = c("EP", "LP","LA","SM"))

# GGplot for Compartments

ggplot(df, aes(x = CellTypeZ, y= percCell, fill = CellTypeZ)) +  
  geom_boxplot(alpha = 0.65, lwd = 1.0) +
  # geom_boxplot(position=position_dodge(1.0), width = 0.5, alpha = 0.65, lwd = 1.5, size = 10) +

  scale_fill_manual(values =c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3", "#78C679", "#FEB24C", "#4292C6", "#B3B3B3"),
                        name = "Cell Type",
                        labels = c("DC cellProp", "DC hivProp", "Mac cellProp", "Mac hivProp", "CD4p cellProp",
                                   "CD4p hivProp", "CD4n cellProp", "CD4n hivProp")) +
  # scale_fill_manual(values =c("#FFFFFF", "#737373"),
  #                       name = "Cell Type",
  #                       labels = c("cellProp", "hivProp")) +
  # scale_color_manual(values =c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3", "#78C679", "#FEB24C", "#4292C6", "#B3B3B3"),
  #                       name = "Cell Type",
  #                     labels = c("DC cellProp", "DC hivProp", "Mac cellProp", "Mac hivProp", "CD4p cellProp",
  #                                  "CD4p hivProp", "CD4n cellProp", "CD4n hivProp")) +

    theme_classic() +
    labs(title="Percentage of cell-type HIV+", y="Percentage of cell-type HIV+", x="Cell Types") +
  # scale_x_discrete(expand=c(0.2, 0.2)  
  theme(plot.title=element_text(size=20,
                                  face="bold",
                                  family="American Typewriter",
                                  color="black",
                                  hjust=0.5,
                                  lineheight=10.0,
                                  margin = margin(t =0, r = 0, b = 20, l = 0)), # title
          axis.title.x=element_blank(),
          axis.text.x=element_blank(),
          axis.ticks.x=element_blank(),
          axis.title.y=element_blank(),
          legend.title = element_blank(),
          legend.text = element_blank(),


        # axis.title.x=element_text(vjust= -6,
        #                             size=15), # X axis title
          # axis.title.y=element_text(vjust = 6,
          #                           size=15),
        #   axis.text.x=element_text(size = 18,
        #                            angle = 90,
        #                            face="bold",
        #                            vjust= -6),  # X axis text
          axis.text.y=element_text(size = 18,
                                   face="bold",
                                   vjust= 0.4,
                                   hjust = 0),    # Y axis text
        #   legend.title = element_text(size = 14),
        #   legend.text = element_text(size =10),
          plot.margin = unit(c(7,1,7,1), "cm")) +   # Y axis title
          facet_wrap(~Compartments, scales = "free", nrow = 1)
          
```

## Figure 3 - What is the mean amount of HIV interacting with each subset? (To do)

```{r eval = FALSE, echo = FALSE}


df = cellData %>% 
  dplyr::filter(batch == "new") %>%
  # dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  dplyr::filter(Condition == "hivBal") %>%
  dplyr::filter(Compartments != "Undefined") %>%
  dplyr::filter(CellTypeZ != "Unknown") %>%
  dplyr::filter(CellTypeZ != "MDDC") %>%
  group_by(Condition, DonorNo, blockID) %>%
  dplyr::filter(hivCount > 0) %>%
  group_by(Condition, DonorNo, blockID, CellTypeZ) %>%
  summarise(meanHIV = mean(hivCount))

df$CellTypeZ = factor(df$CellTypeZ, levels = c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n"))
df$DonorNo = factor(df$DonorNo)
df$blockID = factor(df$blockID)


# install.packages("extrafont")
# library(extrafont)
# font_import()
# loadfonts(device = "win")

# Normal GGplot

ggplot(df, aes(x = CellTypeZ, y= meanHIV, fill = CellTypeZ)) + 
  # geom_bar(stat = "summary", fun.y = "mean", position=position_dodge(1.0), width = 0.6, alpha = 0.65, lwd = 2.0) +
  # geom_dotplot(position=position_dodge(1.0), binaxis='y', stackdir = "center", dotsize=0.65, show.legend = FALSE, alpha = 0.45, binwidth = 3/25) +
  geom_boxplot(position=position_dodge(1.0), width = 0.8, alpha = 0.65, lwd = 2.0, outlier.shape = NA) +
  scale_fill_manual(values = c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3")) +
  # coord_cartesian(ylim = c(1,3.5)) +
  # scale_y_continuous(breaks = c(1,2,3),
  #                  labels = c("1","2","3")) +
  coord_cartesian(ylim = c(1,4)) +
  scale_y_continuous(breaks = c(1,2,3,4),
                   labels = c("1","2","3", "4")) +
  scale_x_discrete(labels = c("DC", "Mac", "CD4+TC", "CD4-TC")) +
  theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 18,
                                       face="plain",
                                       vjust= -0.4,
                                       hjust = 0.5),    # Y axis text
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 21,
                                       face="plain",
                                       vjust= 0.4,
                                       hjust = 0),    # Y axis text
              plot.margin = unit(c(1,1,1,1), "cm"))    # Y axis title

ggsave("plot4.png", width = 14, height = 12, units = "cm", dpi = 300)

# Figure 1 Mock figure dimensions 

df %>%
  dplyr::filter(CellTypeZ == "CD11c") %>%
  ggplot(aes(x = CellTypeZ, y= meanHIV, fill = CellTypeZ)) + 
  # geom_bar(stat = "summary", fun.y = "mean", position=position_dodge(1.0), width = 0.6, alpha = 0.65, lwd = 2.0) +
  # geom_dotplot(position=position_dodge(1.0), binaxis='y', stackdir = "center", dotsize=0.65, show.legend = FALSE, alpha = 0.45, binwidth = 3/25) +
  geom_boxplot(position=position_dodge(1.0), width = 0.8, alpha = 0.65, lwd = 2.0, outlier.shape = NA) +
  scale_fill_manual(values = c("#78C679")) +
  # coord_cartesian(ylim = c(1,3.5)) +
  # scale_y_continuous(breaks = c(1,2,3),
  #                  labels = c("1","2","3")) +
  coord_cartesian(ylim = c(1,4)) +
  scale_y_continuous(breaks = c(1,2,3,4),
                   labels = c("1","2","3", "4")) +
  theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 18,
                                       face="plain",
                                       vjust= -0.4,
                                       hjust = 0.5),    # Y axis text
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 21,
                                       face="plain",
                                       vjust= 0.4,
                                       hjust = 0),    # Y axis text
              plot.margin = unit(c(1,1,1,1), "cm"))    # Y axis title

ggsave("plot1.png", width = 6, height = 8, units = "cm", dpi = 300)
#

# Wilcox test to compare mean HIV

dfTest = df %>%
  pivot_wider(names_from = CellTypeZ, values_from = meanHIV) 

wilcox.test(dfTest$CD3CD4p, dfTest$CD11c, paired = TRUE)



# df$Compartments = factor(df$Compartments, levels = c("EP", "LP","LA","SM"))

# Ggplot for Compartments

ggplot(df, aes(x = CellTypeZ, y= meanHIV, fill = CellTypeZ)) +  
  geom_boxplot(alpha = 0.65, lwd = 1.0) +
  # geom_boxplot(position=position_dodge(1.0), width = 0.5, alpha = 0.65, lwd = 1.5, size = 10) +

  scale_fill_manual(values =c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3", "#78C679", "#FEB24C", "#4292C6", "#B3B3B3"),
                        name = "Cell Type",
                        labels = c("DC cellProp", "DC hivProp", "Mac cellProp", "Mac hivProp", "CD4p cellProp",
                                   "CD4p hivProp", "CD4n cellProp", "CD4n hivProp")) +
  # scale_fill_manual(values =c("#FFFFFF", "#737373"),
  #                       name = "Cell Type",
  #                       labels = c("cellProp", "hivProp")) +
  # scale_color_manual(values =c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3", "#78C679", "#FEB24C", "#4292C6", "#B3B3B3"),
  #                       name = "Cell Type",
  #                     labels = c("DC cellProp", "DC hivProp", "Mac cellProp", "Mac hivProp", "CD4p cellProp",
  #                                  "CD4p hivProp", "CD4n cellProp", "CD4n hivProp")) +

    theme_classic() +
    labs(title="Mean HIV per cell type", y="Mean HIV per cell type", x="Cell Types") +
  # scale_x_discrete(expand=c(0.2, 0.2)  
  theme(plot.title=element_text(size=20,
                                  face="bold",
                                  family="American Typewriter",
                                  color="black",
                                  hjust=0.5,
                                  lineheight=10.0,
                                  margin = margin(t =0, r = 0, b = 20, l = 0)), # title
          axis.title.x=element_blank(),
          axis.text.x=element_blank(),
          axis.ticks.x=element_blank(),
          axis.title.y=element_blank(),
          legend.title = element_blank(),
          legend.text = element_blank(),


        # axis.title.x=element_text(vjust= -6,
        #                             size=15), # X axis title
          # axis.title.y=element_text(vjust = 6,
          #                           size=15),
        #   axis.text.x=element_text(size = 18,
        #                            angle = 90,
        #                            face="bold",
        #                            vjust= -6),  # X axis text
          axis.text.y=element_text(size = 18,
                                   face="bold",
                                   vjust= 0.4,
                                   hjust = 0),    # Y axis text
        #   legend.title = element_text(size = 14),
        #   legend.text = element_text(size =10),
          plot.margin = unit(c(7,1,7,1), "cm")) +   # Y axis title
          facet_wrap(~Compartments, scales = "free", nrow = 1)


    
```



#### Figure 3 - Flow cytometry percentage and mean HIV per subset

```{r }

uptake = read.csv("3_uptake_p24_n6_SUMMARYFixed.csv")

uptake = as.data.frame(uptake)

uptake = uptake[,1:5]

uptake$CellTypeZ = factor(uptake$CellTypeZ, levels = c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n"))

uptake %>%
  dplyr::filter(Condition == "Bal") %>%
ggplot(aes(x = CellTypeZ, y = hivPerc, fill = CellTypeZ)) +
  geom_bar(stat= "summary", fun = "median", position=position_dodge(1.0), width = 0.8, alpha = 0.65, lwd = 2.0) +
  # geom_dotplot(position=position_dodge(1.0), binaxis='y', stackdir = "center", dotsize=0.65, show.legend = FALSE, alpha = 1.0, binwidth = 6000/18) +
  geom_dotplot(position=position_dodge(1.0), binaxis='y', stackdir = "center", dotsize=0.65, show.legend = FALSE, alpha = 1.0, binwidth = 100/20) +
   # geom_boxplot(position=position_dodge(1.0), width = 0.70, alpha = 0.65, lwd = 2.0, outlier.shape =  NA) +
    scale_fill_manual(values = c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3"),
                      name = "Cell Type",
                      labels = c("DC", "Mac", "CD4 T-Cell", "CD4n T-Cell")) +
  # scale_colour_manual(values = c("black", "black", "black", "black")) +
  scale_x_discrete(labels = c("DC", "Mac", "CD4+TC", "CD4-TC")) +
  theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 18,
                                       face="plain",
                                       vjust= -0.4,
                                       hjust = 0.5),    # Y axis text
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 21,
                                       face="plain",
                                       vjust= 0.4,
                                       hjust = 0),    # Y axis text
              plot.margin = unit(c(1,1,1,1), "cm"))    # Y axis title

ggsave("plot4.png", width = 14, height = 12, units = "cm", dpi = 300)


dfTest = uptake %>%
  dplyr::filter(Condition == "Bal") %>%
  select(-hivMean) %>%
  pivot_wider(names_from = CellTypeZ, values_from = hivPerc)

wilcox.test(dfTest$CD11c, dfTest$CD3CD4p, paired = FALSE)


```


## Figure 3 - Among target cells, what proportion of each cell type has 1,2,3,4,5,6,7,8,9,10 particles? (to do)

```{r eval = FALSE, echo = FALSE}

# Note condition added that a cell type is only included in each bar graph is there are at least 3 that have that many HIV particles.
# This was implemented to try and smooth out noise (non-specific measurements of HIV association with a cell type)

df = cellData %>%
  dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  dplyr::filter(Compartments != "Undefined") %>%
  group_by(DonorNo, Image) %>%
  # dplyr::filter(
  #          (sum(Compartments == "LP") > 0) &
  #          (sum(Compartments == "EP") > 0)) %>%
  # # dplyr::filter(Compartments != "SM") %>%
  # # dplyr::filter(Compartments != "EP") %>%
  dplyr::filter(CellTypeZ != "Unknown") %>%
  dplyr::filter(CellTypeZ != "CD3CD4n") %>%
  dplyr::filter(CellTypeZ != "MDDC") %>%
  dplyr::filter((hivCount > 0) & (hivCount < 16)) %>%
  mutate(hivCount = factor(hivCount, levels = c(1:15))) %>%
  group_by(hivCount, CellTypeZ) %>%
  add_count(name = "toFilter") %>%
  dplyr::filter(toFilter > 2) %>%
  group_by(hivCount) %>%
  add_count(name =  "cellsWithNParticles") %>%
  group_by(hivCount, CellTypeZ) %>%
  add_count(name = "celltypeWithNParticles") %>%
  mutate(prop = (celltypeWithNParticles/cellsWithNParticles)*100) %>%
  summarise_at(c("prop", "cellsWithNParticles"), funs(mean))
  

## Target cell number for each HIV particle category

cellNo = df %>%
  group_by(hivCount) %>%
  summarise(mean(cellsWithNParticles))

# 
df$CellTypeZ = factor(df$CellTypeZ, levels = c("CD3CD4p", "FXIIIa", "CD11c"))
# propCellHIV$Image = as.factor(propCellHIV$Image)


ggplot(df, aes(x = hivCount, y= prop, fill = CellTypeZ)) + 
  geom_bar(position="stack", stat = "identity", alpha = 0.85) +
  scale_fill_manual(values =c("#4292C6","#FEB24C", "#78C679"),
                        name = "Cell Type",
                        labels = c("CD3CD4p", "FXIIIa", "CD11c")) +
  theme_classic() +
  theme(
    legend.position = "none",
        axis.title.x=element_blank(),
        axis.title.y=element_blank(),
        axis.text.x=element_text(size = 24,
                                   face="plain",
                                   hjust = 0.5,
                                   vjust = -1),  # X axis text
        axis.text.y=element_text(size = 24,
                                   face="plain",
                                   vjust= 0.4,
                                   hjust = -0.2),    # Y axis text
         
        plot.margin = unit(c(1,1,1,1), "cm"))   # Y axis title


ggsave("plot4.png", width = 25, height = 10, units = "cm", dpi = 300)

# Wilcox test to compare mean HIV

dfTest = df %>%
  pivot_wider(names_from = CellTypeZ, values_from = meanHIV) 

wilcox.test(dfTest$CD3CD4p, dfTest$Unknown, paired = TRUE)




## Extracting co-ordinates of HIV Super-Interactors


df = cellData %>%
  dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal") %>%
  # dplyr::filter(Condition == "hivTF") %>%
  dplyr::filter(Compartments != "Undefined") %>%
  group_by(DonorNo, Image) %>%
  dplyr::filter(
           (sum(Compartments == "LP") > 0) &
           (sum(Compartments == "EP") > 0)) %>%
  dplyr::filter(CellTypeZ != "Unknown") %>%
  dplyr::filter(CellTypeZ != "Unknown") %>%
  dplyr::filter(CellTypeZ != "MDDC") %>%
  dplyr::filter((hivCount > 0) & (hivCount < 16)) %>%
  mutate(hivCount = factor(hivCount, levels = c(1:15))) %>%
  arrange(DonorNo, Image, CellTypeZ, hivCount) %>%
  select(DonorNo, Image, CellTypeZ, hivCount, X, Y)

df1 = df %>%
  # dplyr::filter(hivCount == "5" | hivCount == "6" | hivCount == "7" | hivCount == "8")
  dplyr::filter(hivCount == "2")

write.csv(df1, "hivPosCellCoordinates_n2.csv")

# Image name, x, y coordinate, particle number
```


## Figure 3 - Are target cell-HIV interactions in images specific (non-random)?

```{r eval = FALSE, echo = FALSE}

#Check that proportion of HIV associating with CD4- cells is not greater than expected based on its cell proportion


# dataframe of mucosal target cells
df = cellData %>%
  dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal") %>%
  # dplyr::filter((Condition == "hivBal") | (Condition == "hivTF")) %>%
  dplyr::filter(Compartments != "Undefined") %>%
  group_by(DonorNo, Image) %>%
  # dplyr::filter(
           # (sum(Compartments == "LA") > 0) &
           # (sum(Compartments == "LP") > 0) &
           # (sum(Compartments == "EP") > 0)) %>%
           # (sum(Compartments == "SM") > 0)) %>%
  mutate(CellType2 = case_when(
      # (CellTypeZ == "CD11c") ~ "targetCell",
      # (CellTypeZ == "FXIIIa")  ~ "targetCell",
      # (CellTypeZ == "CD3CD4p")  ~ "targetCell",
      # (CellTypeZ == "Unknown")  ~ "otherCell",
      (CellTypeZ == "Unknown")  ~ "otherCell",
      TRUE ~ as.character(CellTypeZ))) %>%
  select(DonorNo, Image, CellType2, hivCount) %>%
  ungroup()


#Get proportion of cells that are Unknown Cells, targetCells or otherCells
cellProp = df %>%
  group_by(DonorNo, Image, CellType2) %>%
  count() %>%
  group_by(Image) %>%
  mutate(sumCell = sum(n)) %>%
  ungroup() %>%
  mutate(propCell = n/sumCell) %>%
  mutate(CellType2 = factor(CellType2, levels = c("otherCell", "Unknown", "CD3CD4p", "CD11c", "FXIIIa", "MDDC")))

hivProp = df %>%
  group_by(Image, CellType2) %>%
  summarise(cellHIV = sum(hivCount)) %>%
  ungroup() %>%
  group_by(Image) %>%
  mutate(sumHIV = sum(cellHIV)) %>%
  ungroup() %>%
  mutate(propHIV = cellHIV/sumHIV)

prop = left_join(cellProp, hivProp, by = c("Image", "CellType2")) %>%
  select(DonorNo, Image, CellType2, propCell, propHIV) %>%
  pivot_longer(cols = c("propCell", "propHIV"), names_to = "Prop", values_to = "Values")

prop$CellType2 = factor(prop$CellType2, levels = c("otherCell", "Unknown", "CD3CD4p", "CD11c", "FXIIIa", "MDDC"))
prop$Prop = factor(prop$Prop, levels = c("propCell", "propHIV"))


prop %>% 
  dplyr::filter(!(CellType2 %in% c("MDDC", "otherCell"))) %>%
ggplot(aes(x = Prop, y = Values, fill = Prop)) + 
  # geom_bar(position="dodge", stat="summary", fun.y = "mean", width = 0.9, alpha =0.65) +
  geom_violin(width = 0.9, alpha =0.65, trim = FALSE) +
  geom_boxplot(width = 0.1, alpha =1.0, fill = "white") +
  scale_fill_manual(values = c("#737373", "#E31A1C")) +
  theme_classic() +
  ylim(0,0.6) +
  theme(plot.title=element_text(size=20,
                                face="bold",
                                family="American Typewriter",
                                color="black",
                                hjust=0.5,
                                lineheight=10.0,
                                margin = margin(t =0, r = 0, b = 20, l = 0)), # title
        axis.title.x=element_text(vjust= -4,
                                  size=15), # X axis title
        axis.title.y=element_text(vjust = 4,
                                  size=15),
        axis.text.x=element_text(size = 18,
                                 angle = 0,
                                 face="bold",
                                 vjust= -2),  # X axis text
        axis.text.y=element_text(size = 18,
                                 face="bold",
                                 vjust= 0.4,
                                 hjust = 5),    # Y axis text
        legend.title = element_text(size = 14),
        legend.text = element_text(size =10),
        plot.margin = unit(c(0.65,0.65,0.65,0.65), "cm"))  # Y axis title



```





## All Comps ##

### Figure 4 - 1. What is the relative proportion of HIV particles interacting with each subset in each compartment? 2. Which cell types are most enriched with HIV relative to their cell proportion? (to do)

```{r eval = FALSE, echo = FALSE, fig.width=8, fig.height=4}


df = cellData %>%
   dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  # dplyr::filter(hivDist <= 30*3.07) %>%
  dplyr::filter(Compartments != "Undefined") %>%
  group_by(blockID, DonorNo, Image) %>%
  dplyr::filter(
           (sum(Compartments == "LP") > 0) &
           (sum(Compartments == "EP") > 0) &
           (sum(Compartments == "LA") > 0) &
           (sum(Compartments == "SM") > 0)) %>%
  group_by(blockID, DonorNo, Image, Compartments, CellTypeZ) %>%
  summarise(CellTypeHIV = sum(hivCount)) %>%
  group_by(blockID, DonorNo, Image, Compartments)  %>%
  mutate(totalHIV = sum(CellTypeHIV)) %>%
  mutate(propHIV = (CellTypeHIV/totalHIV)*100) %>%
  group_by(blockID, DonorNo, Compartments, CellTypeZ) %>%
  summarise(propHIV = mean(propHIV)) %>%
  # dplyr::filter(CellTypeZ != "CD3") %>%
  # dplyr::filter(DonorNo != "107") %>%
  dplyr::filter(CellTypeZ != "Unknown") %>%
  dplyr::filter(CellTypeZ != "MDDC")


## CellProp

cellProp = cellData %>%
  dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  # dplyr::filter(hivDist <= 30*3.07) %>%
  dplyr::filter(Compartments != "Undefined") %>%
  group_by(blockID, DonorNo, Image) %>%
  dplyr::filter(
           (sum(Compartments == "LP") > 0) &
           (sum(Compartments == "EP") > 0) &
           (sum(Compartments == "LA") > 0) &
           (sum(Compartments == "SM") > 0)) %>%
  group_by(blockID, DonorNo, Image, Compartments) %>%
  add_count(name = "totalCellNo") %>%
  group_by(DonorNo, Image, Compartments, CellTypeZ) %>%
  add_count(name = "cellTypeNo") %>%
  mutate(cellProp = (cellTypeNo/totalCellNo)*100) %>%
  group_by(blockID, DonorNo, Compartments, CellTypeZ) %>%
  summarise(cellProp = mean(cellProp)) %>%
  dplyr::filter(CellTypeZ != "Unknown") %>%
  dplyr::filter(CellTypeZ != "MDDC")


propCellHIV = left_join(df, cellProp) %>%
  # mutate(propHIV = replace_na(propHIV, 0)) %>%
  drop_na(propHIV) %>%
  # drop_na() %>%
  pivot_longer(c("cellProp", "propHIV"), names_to = "whichProp", values_to = "prop")

# propCellHIV$DonorNo = as.factor(propCellHIV$DonorNo)
# propCellHIV$Image = as.factor(propCellHIV$Image)

propCellHIV$CellTypeZ = factor(propCellHIV$CellTypeZ, levels = c("CD11c", "FXIIIa","CD3CD4p", "CD3CD4n"))
propCellHIV$Compartments = factor(propCellHIV$Compartments, levels = c("EP", "LP","LA","SM"))
propCellHIV$whichProp = factor(propCellHIV$whichProp, levels = c("cellProp", "propHIV"))

## Making blank data for getting scales of facetted plots correct (Deprecated. Figured out that this is only useful for expanding y axis, not shortening it)
# Compartments = levels(propCellHIV$Compartments)
# Compartments = rep(Compartments, times = 2)
# whichProp = rep(unique(propCellHIV$whichProp),  times = c(4,4))
# y = rep(c(10, 15, 65, 50), times = 2)
# blank_data = data.frame(Compartments = Compartments, prop = y, whichProp = whichProp)
# blank_data = do.call("rbind", replicate(4, blank_data, simplify = FALSE))
# cell_data = rep(levels(propCellHIV$CellTypeZ), times = c(8,8,8,8))
# blank_data = cbind(blank_data, cell_data)
# colnames(blank_data)[4] = "CellTypeZ"
# blank_data$CellTypeZ = factor(blank_data$CellTypeZ, levels = c("CD11c", "FXIIIa","CD3CD4p", "Unknown"))
# blank_data$Compartments = factor(blank_data$Compartments, levels = c("EP", "LP","LA","SM"))
# blank_data$whichProp = factor(blank_data$whichProp, levels = c("cellProp", "propHIV"))


# Here make plots a1-a4 by manually specifying compartments and then use cowplot below to stitch them together
a1 = propCellHIV %>%
  dplyr::filter(Compartments == "LP") %>%
ggplot(aes(x = CellTypeZ, y = prop, fill = interaction(CellTypeZ, whichProp), colour = interaction(CellTypeZ, whichProp))) + 
  geom_boxplot(position=position_dodge(0.90), width = 0.82, outlier.shape = NA, alpha = 0.65, lwd = 1.25) +
  # geom_boxplot(position=position_dodge(1.0), width = 0.5, alpha = 0.65, lwd = 1.5, size = 10) +
  scale_fill_manual(values =c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3", "#78C679", "#FEB24C", "#4292C6", "#B3B3B3")) +
  scale_colour_manual(values =c(wes_palette("Zissou1")[1], wes_palette("Zissou1")[1], wes_palette("Zissou1")[1], wes_palette("Zissou1")[1],wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5]))+
  # coord_cartesian(ylim = c(0,10)) +
  coord_cartesian(ylim = c(0,18)) +
  # coord_cartesian(ylim = c(0,100)) +
  # coord_cartesian(ylim = c(0,70)) +
  # scale_y_continuous(breaks=c(0,3, 6, 9)) +
  scale_x_discrete(labels = c("DC", "Mac", "CD4+ TC", "CD4- TC")) +
  theme_minimal_hgrid(12) +
  # theme_classic() +
  theme(
          text = element_text(family = "Arial"),
          legend.position = "none",
                axis.title.x=element_blank(),
                axis.text.x = element_blank(),
                axis.ticks.x = element_blank(),
                # axis.text.x=element_text(size = 16,
                #                          face="plain",
                #                          vjust= 1.0,
                #                          angle = 45,
                #                          hjust = 1.1),    # Y axis text
                axis.title.y=element_blank(),
                axis.text.y=element_text(size = 18,
                                         face="plain",
                                         vjust= 0.4))
          # theme(plot.margin = unit(c(0, 0, 0, 0), "cm"))) 

a1

ggsave("plot1.png", width = 20, height =20, units = "cm", dpi = 300)



# library(ggpubr)
# library(cowplot)

plot_grid(a1,a2,a3,a4, ncol = 2, align = "hv")

ggsave("plot1.png", width = 24, height = 20, units = "cm", dpi = 300)



## Statistical tests

dfTest = propCellHIV %>%
  dplyr::filter(Compartments == "LP") %>%
  dplyr::filter(CellTypeZ == "CD3CD4p") %>%
  # select(-c(sumArea, compCellCount, cellDen)) %>%
  pivot_wider(names_from = "whichProp", values_from = "prop")

wilcox.test(dfTest$cellProp, dfTest$propHIV, paired = TRUE)



## What is the level of HIV enrichment in each cell in the different compartments?

# Make new celltypes labelled like EP_DC

df = propCellHIV %>%
  mutate(CellType2 = paste0(paste0(Compartments,"_"), CellTypeZ)) %>%
  pivot_wider(names_from = whichProp, values_from = prop) %>%
  mutate(hivEnrich = log2(propHIV/cellProp)) %>%
  mutate(hivEnrich = case_when(
    !is.finite(hivEnrich) ~ 0,
    TRUE~as.numeric(hivEnrich))) %>%
  group_by(CellType2) %>%
  mutate(meanEnrich = mean(hivEnrich)) %>%
  ungroup() %>%
  arrange(desc(meanEnrich)) %>%
  mutate(CellType2 = factor(CellType2, levels = unique(CellType2))) 

ggplot(df, aes(x = CellType2, y = hivEnrich, fill = CellTypeZ)) +
  geom_boxplot(position=position_dodge(0.90), width = 0.75, outlier.shape = NA, alpha = 0.65, lwd = 1.25) +
  scale_fill_manual(values =c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3")) +
  geom_hline(yintercept = 0.0, linetype = "dashed", lwd = 1.25, colour = "red") +
  coord_cartesian(ylim = c(-2.5,4)) +
  # theme_minimal_hgrid(12) +
  scale_x_discrete(labels = c("EP","SM","SM", "LA","LP","LA","EP","EP","LA","LP","SM","EP","LP", "LA","LP","SM")) +
  theme_classic() +
  theme(
          text = element_text(family = "Arial"),
          legend.position = "none",
                axis.title.x=element_blank(),
                # axis.text.x = element_blank(),
                # axis.ticks.x = element_blank(),
                axis.text.x=element_text(size = 12,
                                         face="plain",
                                         vjust= 0.0,
                                         angle = 0,
                                         hjust = 0.5),    # Y axis text
                axis.title.y=element_blank(),
                axis.text.y=element_text(size = 18,
                                         face="plain",
                                         vjust= 0.4)) 

ggsave("plot1.png", width = 16, height = 8, units = "cm", dpi = 300)

# Dimensions for Figure 1 mock figures

df %>%
  dplyr::filter(CellTypeZ == "CD11c") %>%
ggplot(aes(x = CellType2, y = hivEnrich, fill = Compartments)) +
  geom_boxplot(position=position_dodge(0.90), width = 0.75, outlier.shape = NA, alpha = 0.65, lwd = 1.25) +
  scale_fill_manual(values =c("#78C679", "#78C679", "#78C679", "#78C679")) +
  geom_hline(yintercept = 0.0, linetype = "dashed", lwd = 1.25, colour = "black") +
  coord_cartesian(ylim = c(-2.5,4)) +
  scale_x_discrete(labels = c("EP","LP","LA", "SM")) +
  theme_classic() +
  theme(
          text = element_text(family = "Arial"),
          legend.position = "none",
                axis.title.x=element_blank(),
                # axis.text.x = element_blank(),
                # axis.ticks.x = element_blank(),
                axis.text.x=element_text(size = 12,
                                         face="plain",
                                         vjust= 0.0,
                                         angle = 0,
                                         hjust = 0.5),    # Y axis text
                axis.title.y=element_blank(),
                axis.text.y=element_text(size = 18,
                                         face="plain",
                                         vjust= 0.4)) 
ggsave("plot1.png", width = 8, height = 5, units = "cm", dpi = 300)

#

dfTest = df %>%
  select(-c(CellTypeZ,Compartments,cellProp,propHIV,meanEnrich)) %>%
  pivot_wider(names_from = "CellType2", values_from = "hivEnrich")

dfTest = drop_na(dfTest)

wilcox.test(dfTest$SM_FXIIIa, dfTest$LP_FXIIIa, paired = FALSE)


# Generating stacked bar graphs to summarise hivProp in each cell type in each compartment


df$Compartments = factor(df$Compartments, levels = c("SM", "LA","LP","EP"))
df$CellTypeZ = factor(df$CellTypeZ, levels = c("CD3CD4p", "FXIIIa", "CD11c"))
d
df %>%
  group_by(DonorNo, Compartments) %>%
  dplyr::filter(CellTypeZ != "Unknown") %>%
  mutate(sumProp = sum(propHIV)) %>%
  mutate(propHIV2 = (propHIV/sumProp)*100) %>%
  drop_na(propHIV2) %>%
  group_by(Compartments, CellTypeZ) %>% 
  summarise(propHIV2 = mean(propHIV2)) %>%
ggplot(aes(x = Compartments, y = propHIV2, fill = CellTypeZ)) + 
  geom_bar(position = "stack", stat = "identity", size = 2.5, alpha = 0.65) + 
  scale_fill_manual(values =c("#4292C6", "#FEB24C", "#78C679")) +
  # scale_colour_manual(values =c("#1d4761", "#724101", "#1e481f")) +
  theme_classic() +
  coord_flip() +
  scale_y_continuous(limits = c(-1,101), expand = c(0, 0)) +
   theme(
     legend.position = "none",
         # legend.title = element_blank(),
         # legend.text = element_text(size = 21),
         axis.line = element_blank(),
         axis.title = element_blank(),
         axis.ticks = element_line(size = 1.5),
         axis.ticks.length=unit(.3, "cm"), 
         axis.text.x=element_text(size = 21,
                                   angle = 0,
                                   face="plain",
                                   vjust= -1,
                                  hjust = 0.5),
         axis.text.y=element_text(size = 21,
                                   face="plain",
                                   vjust= 0.4,
                                   hjust = 0),    # Y axis text
        plot.margin = unit(c(1,1,1,1), "cm"))    # Y axis title

ggsave("plot.png", width = 24, height = 16, units = "cm", dpi = 300)

```

  
### Figure 4 - Find and export coordinates of EP, LP, LA, SM HIV interactions with key target cells (used for representative images) (to do)
```{r eval = FALSE, echo = FALSE}

df = cellData %>%
  dplyr::filter(Condition == "hivBal") %>%
  dplyr::filter(Compartments != "Undefined") %>%
  dplyr::filter(Compartments == "EP" | Compartments == "SM") %>%
  dplyr::filter(CellTypeZ == "CD11c" | CellTypeZ == "FXIIIa") %>%
  dplyr::filter(hivCount >= 2) %>%
  select(Image, CellID, Compartments, CellTypeZ, X, Y, hivCount)
                
write.csv(df, "Fig4Reps.csv")

b = which(a, arr.ind=TRUE)


```
  

## EP and LP ##

### Figure 4 - Are DCs enriched in HIV+ epithelium?
```{r eval = FALSE, echo = FALSE}

## code below calculates either the density of DCs in HIV+ vs HIV- epi, or their proportion within the HIV+ vs HIV- epi.

df = cellData %>%
   dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal") %>%
  dplyr::filter(Compartments == "EP") %>%
  mutate(hivStatus = case_when(
    (hivCount > 0)  ~ "HIV+",
    (hivCount == 0)  ~ "HIV-",
    TRUE ~ as.character(CellTypeZ))) %>%
  group_by(DonorNo, Image, hivStatus) %>%
  add_count(name = "compCellCount") %>%
  mutate(sumArea = sum(NucArea)/((3.07^2)*1000)) %>%
  group_by(DonorNo, Image, hivStatus, CellTypeZ) %>%
  add_count(name = "cellCount") %>%
  mutate(cellDen = cellCount/sumArea) %>%
  mutate(cellPerc = (cellCount/compCellCount)*100) %>%
  summarise(cellDen = mean(cellDen), cellPerc = mean(cellPerc), sumArea = mean(sumArea), compCellCount = mean(compCellCount)) %>%
  ungroup()


df %>% 
  dplyr::filter(CellTypeZ == "CD11c") %>%
  ggplot(aes(x = hivStatus, y = cellPerc, fill = hivStatus)) +
    geom_boxplot(position=position_dodge(0.90), width = 0.85, outlier.shape = NA, alpha = 0.65, lwd = 1.0) +
    scale_fill_manual(values = c( "#78C679", "#78C679")) +
    coord_cartesian(ylim = c(0,10)) +
    theme_minimal_hgrid(12) + 
    theme(plot.title=element_blank(),
            legend.position = "none",
            axis.title.x=element_text(vjust= -6,
                                      size=15), # X axis title
            axis.title.y=element_text(vjust = 6,
                                    size=15),
            axis.text.x=element_text(size = 18,
                                     face="bold",
                                     vjust= -3,  # X axis text
                                     hjust = 0.5),
            axis.text.y=element_text(size = 14,
                                     face="bold",
                                     vjust= 0.4,
                                     hjust = 0),   # Y axis text
            axis.line.x = element_blank(),
            plot.margin = unit(c(1,1,1,1), "cm"))    # Y axis title



ggsave("plot.png", width = 9, height = 9, units = "cm", dpi = 300)

dfTest = df %>%
  dplyr::filter(CellTypeZ == "FXIIIa") %>%
  select(-c(sumArea, compCellCount, cellDen)) %>%
  pivot_wider(names_from = "hivStatus", values_from = "cellPerc")


dfTest = drop_na(dfTest)
cox = wilcox.test(dfTest$`HIV-`, dfTest$`HIV+`, paired = TRUE)
cox$p.value

```

### Figure 4 - Are DCs migrating into the Epi in response to HIV? (to do)

```{r eval = FALSE, echo = FALSE}

# 1. Are DCs at a higher density in HIV+ Epi vs Mock Epi?
# 2. What is the probability of finding a region in the epi of 
# the mock sample that has as high a density as DCs in HIV+ epi?
# 3. Is the increase in DC density in epi proportional to the 
# the density of virons in that region of Epi?
# 4. Is DC density in Epi increasing with distance toward HIV? --> This was answered using code in another chunk above. Shared code for Figure 3 and 4.
# 5. In windows with HIV in Epi but little/none in underlying LP
# is the density of DCs within 10um of HIV+ epi lower than the
# the density of DCs within 10um of any epithelium?

#### 1. Are DCs at a higher density in HIV+ Epi vs Mock Epi? ####

df = cellData %>%
   dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition != "hivTF") %>%
  dplyr::filter(Compartments == "EP") %>%
  mutate(hivStatus = case_when(
    (hivCount > 0) & (Condition == "hivBal")  ~ "HIV+",
    (hivCount == 0) & (Condition == "hivBal")  ~ "HIV+",
    Condition == "mock"  ~ "mock",
    Condition == "ori"  ~ "ori",
  TRUE ~ as.character(Condition))) %>%
  group_by(DonorNo, hivStatus) %>%
  add_count(name = "compCellCount") %>%
  mutate(sumArea = sum(NucArea)/((3.07^2)*1000)) %>%
  group_by(DonorNo, hivStatus, CellTypeZ) %>%
  add_count(name = "cellCount") %>%
  mutate(cellDen = cellCount/sumArea) %>%
  mutate(cellPerc = (cellCount/compCellCount)*100) %>%
  summarise(cellDen = mean(cellDen), cellPerc = mean(cellPerc), sumArea = mean(sumArea), compCellCount = mean(compCellCount)) %>%
  ungroup()



df %>% dplyr::filter(CellTypeZ == "CD11c") %>%
  dplyr::filter(hivStatus != "ori") %>%
  ggplot(aes(x = hivStatus, y = cellDen, fill = hivStatus)) +
    geom_boxplot(position=position_dodge(0.90), width = 0.85, outlier.shape = NA, alpha = 0.65, lwd = 1.0) +
    # scale_fill_manual(values = c( "#78C679", "#78C679", "#78C679", "#78C679")) +
    # coord_cartesian(ylim = c(0,1.0)) +
    theme_minimal_hgrid(12) + 
    theme(plot.title=element_blank(),
            legend.position = "none",
            axis.title.x=element_text(vjust= -6,
                                      size=15), # X axis title
            axis.title.y=element_text(vjust = 6,
                                    size=15),
            axis.text.x=element_text(size = 18,
                                     face="bold",
                                     vjust= 0.4,  # X axis text
                                     hjust = -0.2,
                                     angle = 90),
            axis.text.y=element_text(size = 14,
                                     face="bold",
                                     vjust= 0.4,
                                     hjust = 0),   # Y axis text
            axis.line.x = element_blank(),
            plot.margin = unit(c(1,1,1,1), "cm"))    # Y axis title



ggsave("plot.png", width = 12, height = 12, units = "cm", dpi = 300)

dfTest = df %>%
  dplyr::filter(CellTypeZ == "CD11c") %>%
    dplyr::filter(hivStatus != "ori") %>%

  select(-c(sumArea, compCellCount, cellPerc)) %>%
  pivot_wider(names_from = "hivStatus", values_from = "cellDen")


dfTest = drop_na(dfTest)
cox = wilcox.test(dfTest$`HIV+`, dfTest$`HIV-`, paired = TRUE)
cox$p.value


#### 5. In windows with HIV in Epi but little/none in underlying LP is the density of DCs within 10um of HIV+ epi lower than the the density of DCs within 10um of any epithelium. ####

# Annotated windows with hivCount in EP >0 and hivCount in LP == 0 or 10% of EP HIV number. Annotated other inedows. Also annotate HIV- EP windows.
# Select all LP cells within 20um of EP (EPDist)
# Get their density in each window. Also get the simple cell count of DCs in each window


# Get win_LP_hivCount and win_EP_hivCount

df = temp %>%
  select(-c(win_sumArea, win_cellNumber, win_cellDensity, win_foldChange, win_CD11cHighDist, win_hivCount, win_hivDist))

df$Compartments = factor(df$Compartments)
df$CellTypeZ = factor(df$CellTypeZ)
df = droplevels(df)


# Calculate the area of EP in each window. Plot and decide on cut off for excluding areas with not enough EP.
df0 = cellData %>%
  # droplevels() %>%
  # dplyr::filter(batch == "new") %>%
  # dplyr::filter(DonorNo %in% c(56,65)) %>%
  dplyr::filter(Condition =="hivBal") %>%
  dplyr::filter(Compartments != "Undefined") %>%
  dplyr::filter(
           (sum(Compartments == "LP") > 0) &
           (sum(Compartments == "EP") > 0)) %>%
  dplyr::filter(Compartments == "EP" | Compartments == "LP") %>%
  group_by(Condition, DonorNo, Image, winCoord, Compartments) %>%
  mutate(win_comp_hivCount = sum(hivCount)) %>%
  mutate(win_comp_sumArea = sum(NucArea)/((3.07^2)*(10^6))) %>%
  group_by(Condition, DonorNo, Image, winCoord) %>%
  dplyr::filter(
           (sum((Compartments == "LP") & (win_comp_sumArea > 0.001)) > 0) &
           (sum((Compartments == "EP") & (win_comp_sumArea > 0.0005)) > 0)) %>%
  group_by(Condition, DonorNo, Image, winCoord, Compartments, CellTypeZ, .drop = FALSE) %>%
  add_count(name = "win_comp_cellCount") %>%
  summarise(win_comp_hivCount = mean(win_comp_hivCount), win_comp_sumArea = mean(win_comp_sumArea), win_comp_cellCount = mean(win_comp_cellCount)) %>%
  ungroup() %>%
  drop_na(winCoord)

df0$win_comp_hivCount[is.nan(df0$win_comp_hivCount)] = 0
df0$win_comp_sumArea[is.nan(df0$win_comp_sumArea)] = 0
df0$win_comp_cellCount[is.nan(df0$win_comp_cellCount)] = 0



## Filtering for DCs and graphing to see how hivCounts in LP and EP look like for all windows. 
df1 = df0 %>%
  dplyr::filter(CellTypeZ == "CD11c") %>%
  group_by(DonorNo, Image, winCoord) %>%
  arrange(Compartments) %>%
  mutate(epHIVCount = first(win_comp_hivCount)) %>%
  ungroup() %>%
  select(DonorNo, Image, winCoord, Compartments, CellTypeZ, epHIVCount, win_comp_cellCount) %>%
  spread(Compartments, win_comp_cellCount)
  # dplyr::mutate(LP = replace_na(LP,0)) %>%
  # dplyr::mutate(EP = replace_na(EP,0))  %>%
  # gather(Compartments, win_comp_cellCount, LP:EP)

#Define a cool colour palette I found here: https://www.r-bloggers.com/simplest-possible-heatmap-with-ggplot2/
myPalette <- colorRampPalette(rev(brewer.pal(11, "Spectral")), space="Lab")

# Visualise whether there are actually windows that have high HIV in EP with little in LP


ggplot(df1, aes(x = LP, y = EP, colour = epHIVCount)) +
  geom_point() +
  scale_colour_gradientn(colors = myPalette(100), limits = c(0,10),
                       values=rescale(c(min(0),2, max(10)))) +
  facet_wrap(~DonorNo, scales = "free")

ggsave("plot.png", width = 30, height = 24, units = "cm", dpi = 300)


# Seems there are windows with High HIV in Epi and little in LP. Based on graph let's say:
# if EP hivCount is 0-5 then LP hivCount == 0
# if EP hivCount is 5-10 then LP hivCOunt 0-1
# if EP hivCount > 10 then LP hivCount 0-3
df1 = df0 %>%
  dplyr::filter(CellTypeZ == "CD11c") %>%
  drop_na(winCoord) %>%
  group_by(Condition, DonorNo, Image, winCoord) %>%
  mutate(filter = case_when(
  (sum((Compartments == "LP") & (win_comp_hivCount == 0)) > 0) & (sum((Compartments == "EP") & (win_comp_hivCount > 0 & win_comp_hivCount <= 5)) > 0) ~ "EP+LP-",
  (sum((Compartments == "LP") & (win_comp_hivCount > 0 & win_comp_hivCount <= 1)) > 0) & (sum((Compartments == "EP") & (win_comp_hivCount > 5 & win_comp_hivCount <= 10)) > 0) ~ "EP+LP-",
  (sum((Compartments == "LP") & (win_comp_hivCount > 0 & win_comp_hivCount <= 3)) > 0) & (sum((Compartments == "EP") & (win_comp_hivCount > 10)) > 0) ~ "EP+LP-",
  TRUE ~ as.character("other"))) %>%
   # mutate(filter = case_when(
    # (sum(Compartments == "LP" & win_comp_hivCount <= 2) > 0) & (sum(Compartments == "EP" & win_comp_hivCount) > 0) ~ "EP+LP-",
    # TRUE ~ as.character("other"))) %>%
  ungroup()


df1$filter = factor(df1$filter, levels = c("other", "EP+LP-"))
df1$Compartments = factor(df1$Compartments, levels = c("EP", "LP"))
df1$Image = factor(df1$Image)


ggplot(df1, aes(x = Compartments, y = win_comp_cellCount, fill = interaction(Compartments, filter))) +
    geom_boxplot(position=position_dodge(0.85), width = 0.8, alpha = 0.65, lwd = 1.5, size = 10) +
  coord_cartesian(ylim = c(0,10)) +
  facet_wrap(~DonorNo)

# Subsample the filter == 'other' windows to get them the same size as "EP+LP-"

EPLPCount = df1 %>%
  dplyr::filter(filter == "EP+LP-") %>%
  count()/2

otherSample = df1 %>%
  mutate(ID = paste0(Image, winCoord)) %>%
  dplyr::filter(Compartments == "EP") %>%
  dplyr::filter(filter == "other") %>%
  nest(data = everything()) %>%
  mutate(n = EPLPCount$n) %>%
  mutate(samp = map2(data, n, sample_n)) %>%
  select(-c(data, n)) %>%
  unnest(samp)

toJoin = df1 %>%
  dplyr::filter(Compartments == "LP") %>%
  mutate(ID = paste0(Image, winCoord)) %>%
  dplyr::filter(ID %in% otherSample$ID)

otherSample = rbind(otherSample, toJoin)
otherSample = otherSample %>% select(-ID)

EPLPData = df1 %>%
    dplyr::filter(filter == "EP+LP-")

sampledData = rbind(EPLPData, otherSample)

ggplot(sampledData, aes(x = Compartments, y = win_comp_cellCount, fill = interaction(Compartments, filter))) +
    geom_boxplot(position=position_dodge(0.85), width = 0.8, alpha = 0.65, lwd = 1.5, size = 10) +
  coord_c

# Test to see if cell Count in LP  of 'EP+LP-' vs 'other' windows is different

# First let's see how many windows there are per Donor. Exclude Donors that don't have enough

a = df1 %>%
  group_by(DonorNo, filter) %>%
  count() 
  # dplyr::filter(n < 10)
  
dfTest = df1 %>%
  # dplyr::filter(!(DonorNo %in% a$DonorNo)) %>%
  dplyr::filter(Compartments == "LP") %>%
  mutate(ID = paste0(Image, winCoord)) %>%
  group_by(DonorNo, filter) %>%
  summarise(win_comp_cellCount = mean(win_comp_cellCount)) %>%
  pivot_wider(names_from = filter, values_from = win_comp_cellCount)

#per donor test
dfTest = df1 %>%
  dplyr::filter(DonorNo == 100) %>%
  dplyr::filter(Compartments == "LP") %>%
  mutate(ID = paste0(Image, winCoord)) %>%
  select(ID, filter, win_comp_cellCount)  %>%
  pivot_wider(names_from = filter, values_from = win_comp_cellCount)

wilcox.test(dfTest$other, dfTest$`EP+LP-`)


# If there is more HIV in EP, does the cell count in underlyping LP decrease?
df1 = df0 %>%
  dplyr::filter(CellTypeZ == "CD11c") %>%
  group_by(DonorNo, Image, winCoord) %>%
  arrange(Compartments) %>%
  mutate(epHIVCount = first(win_comp_hivCount)) %>%
  ungroup() %>%
  select(DonorNo, Image, winCoord, Compartments, CellTypeZ, epHIVCount, win_comp_cellCount) %>%
  spread(Compartments, win_comp_cellCount) %>%
  dplyr::filter(epHIVCount > 0) %>%
  mutate(EPCut = quantile(EP, 0.5)) %>%
  mutate(epStatus = case_when(
    EP > EPCut ~ "epDCHigh",
    TRUE ~ as.character("EPDCLow")))

df1$epStatus = factor(df1$epStatus)

ggplot(df1, aes(x = epStatus, y = LP)) +
  geom_violin() +
  geom_point()
  # geom_point() +
  # geom_smooth(method = "loess", colour = "#78C679")

cor.test(df1$LP, df1$epHIVCount, method = "spearman")

exponential.model <- lm(log(df1$epHIVCount)~ df1$LP)
summary(exponential.model)


# Alternative method: comparing epHIVDist to epDist < 10um LP Dc density (not finished)

df = cellData %>% 
    dplyr::filter(batch == "new") %>%
    dplyr::filter(Condition == "hivBal") %>%
    dplyr::filter(Compartments != "Undefined") %>%
    dplyr::filter(
               (sum(Compartments == "LP") > 0) &
               (sum(Compartments == "EP") > 0)) %>%
    dplyr::filter(Compartments == "LP")

# dfWholeDen = df %>%
#     group_by(DonorNo, Image) %>%
#     mutate(sumArea = sum(NucArea)/((3.07^2)*1000)) %>%
#     dplyr::filter(CellTypeZ != "Unknown") %>%
#     # dplyr::filter(CellTypeZ != "Unknown") %>%  
#     dplyr::filter(CellTypeZ != "MDDC") %>%
#     group_by(DonorNo, Image, CellTypeZ) %>%
#     add_count(name = "cellNumber") %>%
#     mutate(cellDensityWhole = cellNumber/sumArea) %>%
#     # summarise_at(c("cellNumber", "cellDensity", "sumArea", "LADist"), funs(mean)) %>%
#     summarise(cellDensityWhole = mean(cellDensityWhole)) %>%
#     ungroup()

dfDist = df %>%  
    mutate(lpRegion = case_when(
    epHIVDist <= 10*3.07 ~ "hivClose",
    TRUE ~ as.character(hivDist))) %>%
    dplyr::filter(epiRegion == "hivClose") %>%
    group_by(DonorNo, Image) %>%
    mutate(sumArea = sum(NucArea)/((3.07^2)*1000)) %>%
    dplyr::filter(CellTypeZ == "CD11c") %>%
    group_by(DonorNo, Image) %>%
    add_count(name = "cellNumber") %>%
    mutate(cellDensity = cellNumber/sumArea) %>%
    summarise(cellDensity = mean(cellDensity)) %>%
    ungroup()




```

### Figure 4 - Do HIV+ epi DCs have a higher mean amount of HIV than DCs in other comps? (to do)

```{r eval = FALSE, echo = FALSE}

df = cellData %>%
  dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  dplyr::filter(Compartments != "Undefined") %>%
  group_by(DonorNo) %>%
  dplyr::filter(
           (sum(Compartments == "LP") > 0) &
           (sum(Compartments == "EP") > 0) &
           (sum(Compartments == "LA") > 0)) %>%
  dplyr::filter(Compartments != "SM") %>%
  dplyr::filter(hivDist <= 50*3.07) %>%
  dplyr::filter(CellTypeZ == "CD11c") %>%
  dplyr::filter(hivCount > 0) %>%
   mutate(Compartments = case_when(
   (Compartments == "LP") | (Compartments == "LA") ~ "LPLA",
   TRUE ~ as.character(Compartments))) %>%
  group_by(DonorNo, Compartments) %>%
  add_count(name = "count") %>%
  dplyr::filter(count > 5) %>%
  summarise(hivCount = mean(hivCount), count = mean(count))
  group_by(DonorNo) %>%
  dplyr::filter((sum(Compartments == "EP") > 0) &
                  (sum(Compartments == "LPLA") > 0)) %>%
  ungroup()

df$Compartments = factor(df$Compartments, levels = c("EP", "LPLA"))


df %>%
  #dplyr::filter(DonorNo != "100") %>%
  ggplot(aes(x = Compartments, y = hivCount, fill = Compartments, colour = Compartments)) +
  # geom_bar(stat = "summary", position=position_dodge(0.90), alpha = 0.65) +
  geom_boxplot(position=position_dodge(0.90), width = 0.85, outlier.shape = NA, alpha = 0.65, lwd =2.0) +
  # geom_dotplot(position=position_dodge(0.85), binaxis='y', stackdir = "center", dotsize=0.65, show.legend = FALSE, alpha = 0.65, binwidth = 4/20) +
  # geom_point() +
  scale_fill_manual(values = c("#78C679", "#78C679")) +
  scale_colour_manual(values =c(wes_palette("Zissou1")[1], wes_palette("Zissou1")[1]))+
  # scale_fill_manual(values = c("#B3B3B3", "#B3B3B3")) +
  # scale_fill_manual(values = c("#02384f", "#02384f")) +
  coord_cartesian(ylim = c(1,4.3)) +
  # coord_cartesian(ylim = c(1,1.5)) +
  scale_x_discrete(labels = c("EP ", "LP+LA")) +
  # scale_y_continuous(breaks = c(1.0,1.5,2.0)) +
  theme_minimal_hgrid(12) + 
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 16,
                                       face="plain",
                                       vjust= 0.0,
                                       angle = 0,
                                       hjust = 0.5),    # Y axis text
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4)) 

# ggsave("plot1.png", width = 7, height = 14, units = "cm", dpi = 300)
# ggsave("plot1.png", width = 9, height = 14, units = "cm", dpi = 300)
ggsave("plot1.png", width = 4, height = 8, units = "cm", dpi = 300)

# Don't know what test to use for a beta distribution so just do a wilcox test

dfTest = df %>%
  # dplyr::filter(DonorNo != "100") %>%
  select(-count) %>%
  pivot_wider(names_from = "Compartments", values_from = "hivCount")

wilcox.test(dfTest$EP, dfTest$LPLA, paired = TRUE)

#Get DonorNo
length(unique(df$DonorNo))


```
### Figure 4 - Is the percentage of epithelial DCs interacting with HIV greater than the LP and LA? (to do)

```{r eval = FALSE, echo = FALSE}

df = cellData %>% 
  dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  # dplyr::filter(Condition == "hivTF") %>%
  dplyr::filter(Compartments != "Undefined") %>%
  group_by(DonorNo) %>%
  dplyr::filter(
           (sum(Compartments == "LP") > 0) &
           (sum(Compartments == "EP") > 0) &
           (sum(Compartments == "LA") > 0)) %>%
  dplyr::filter(Compartments != "SM") %>%
  dplyr::filter(hivDist <= 50*3.07) %>%
  dplyr::filter(CellTypeZ == "CD11c") %>%
   mutate(Compartments = case_when(
   (Compartments == "LP") | (Compartments == "LA") ~ "LPLA",
   TRUE ~ as.character(Compartments))) %>%
  group_by(DonorNo, Compartments) %>%
  add_count(name = "count") %>%
  dplyr::filter(count > 10) %>%
  # mutate(compTotalHIV = sum(hivCount)) %>%
  # dplyr::filter(compTotalHIV > 50) %>%
  add_count(CellTypeZ, name = "totalCells") %>%
  dplyr::filter(hivCount > 0) %>%
  add_count(CellTypeZ, name = "hivPosCells") %>%
  mutate(PercCellHIVPos = (hivPosCells/totalCells)*100) %>%
  summarise(percCell = mean(PercCellHIVPos)) %>%
  group_by(DonorNo) %>%
  dplyr::filter(
           (sum(Compartments == "EP") > 0) &
           (sum(Compartments == "LPLA") > 0)) %>%
  ungroup()

df$Compartments = factor(df$Compartments, levels = c("EP", "LPLA"))

ggplot(df, aes(x = Compartments, y = percCell, fill = Compartments, colour = Compartments)) +
  # geom_bar(stat = "summary", position=position_dodge(0.90), alpha = 0.65) +
  geom_boxplot(position=position_dodge(0.90), width = 0.85, outlier.shape = NA, alpha = 0.65, lwd =2.0) +
  # geom_dotplot(position=position_dodge(0.85), binaxis='y', stackdir = "center", dotsize=0.65, show.legend = FALSE, alpha = 0.65, binwidth = 4/20) +
  # geom_point() +
  scale_fill_manual(values = c("#78C679", "#78C679")) +
  scale_colour_manual(values =c(wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5]))+
  # scale_fill_manual(values = c("#B3B3B3", "#B3B3B3")) +
  # scale_fill_manual(values = c("#02384f", "#02384f")) +
  coord_cartesian(ylim = c(0,19)) +
  # coord_cartesian(ylim = c(0,4)) +
  # coord_cartesian(ylim = c(0,1.5)) +
  scale_x_discrete(labels = c("EP", "LP+LA")) +
  theme_minimal_hgrid(12) + 
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 14,
                                       face="plain",
                                       vjust= 0.0,
                                       angle = 0,
                                       hjust = 0.5),    # Y axis text
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4)) 

ggsave("plot1.png", width = 6, height = 10, units = "cm", dpi = 300)
# ggsave("plot1.png", width = 7, height = 14, units = "cm", dpi = 300)
# ggsave("plot1.png", width = 9, height = 14, units = "cm", dpi = 300)


# Don't know what test to use for a beta distribution so just do a wilcox test

dfTest = df %>%
  pivot_wider(names_from = "Compartments", values_from = "percCell")

wilcox.test(dfTest$EP, dfTest$LPLA, paired = TRUE)

# Get DonorNo:
length(unique(df$DonorNo))

#### Sandbox ####
```

### Figure 4 - Are HIV+ Epithelial or Lamina propria DCs closer to LAs than their HIV- counterparts? (to do)

```{r eval = FALSE, echo = FALSE}

df = cellData %>% 
  # dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  group_by(blockID, DonorNo, Image) %>%
  dplyr::filter(
           (sum(Compartments == "LP") > 0) &
           (sum(Compartments == "EP") > 0) &
           (sum(Compartments == "LA") > 0)) %>% 
    dplyr::filter(Compartments == "EP") %>%
   dplyr::filter(CellTypeZ == "CD11c") %>%
  mutate(hivStatus = case_when(
    hivCount > 0 ~ "HIVPos",
    hivCount == 0 ~ "HIVNeg",
    TRUE~as.character("toDelete"))) %>%
  dplyr::filter(hivStatus != "toDelete") %>%
  dplyr::filter(
    (sum(hivStatus == "HIVPos") > 5) &
    (sum(hivStatus == "HIVNeg") > 5)) %>% 
  group_by(blockID, DonorNo, Image, hivStatus) %>%
  summarise(LADist = mean(LADist/3.07))

df$hivStatus = factor(df$hivStatus, levels = c("HIVNeg", "HIVPos"))

df %>%
  ggplot(aes(x = hivStatus, y = LADist)) +
    geom_boxplot(position=position_dodge(0.90), width = 0.85, outlier.shape = NA, alpha = 0.65, lwd =2.0) 

  
dfTest = df %>%
  pivot_wider(names_from = "hivStatus", values_from = "LADist")

wilcox.test(dfTest$HIVPos, dfTest$HIVNeg, paired = TRUE)




```
### Figure 4 - Is there a higher density of HIV+ cells or virions in total in EP or LP near LAs? (USED IN PAPER) (to do)

```{r eval = FALSE, echo = FALSE}

# NOTE: Need to do this in Unknown cells as target cell densities and HIV+ target cel densities vary in LAClose and LAFar regions. 


# Also test this with the data in the chunk below that measures fold change in HIV+ cell density between LAClose and LAFar regions. 
# Get the relevant images for significant comparisons and check here whether those images of a significiant increase in HIV+ cell density between
# the regions. 
#LPSigImages
#EPSigImages

sigImages = EPSigImages %>% 
  dplyr::filter(CellTypeZ == "Unknown") %>%
  dplyr::filter(hivStatus == "hivPosFold")

# Short answer: No.HOWEVER, if you filter by laIDHIVCount > 20 particles (possibly less) and include new and old batch data then you get significantly
# higher hiv density in LAClose LP when the HIV levels are high in the associated lymphoid aggregate.

df = cellData %>% 
  dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  group_by(blockID, DonorNo, Image) %>%
  # dplyr::filter(Image %in% sigImages$Image) %>%
  dplyr::filter(
           (sum(Compartments == "LP") > 0) &
           (sum(Compartments == "EP") > 0) &
           (sum(Compartments == "LA") > 0)) %>% 
  dplyr::filter(Compartments == "LP") %>%
  dplyr::filter(CellTypeZ == "Unknown") %>%
  mutate(hivStatus = case_when(
    hivCount > 0 ~ "HIVPos",
    hivCount == 0 ~ "HIVNeg",
    TRUE~as.character("toDelete"))) %>%
  dplyr::filter(hivStatus != "toDelete") %>%
  mutate(hivStatus = factor(hivStatus, levels = c("HIVNeg", "HIVPos"))) %>%
  mutate(LAProx = case_when(
    LADist <= 400*3.07 ~ "LAClose",
    LADist > 400*3.07 & LADist <= 800*3.07 ~ "LAFar",
    TRUE~as.character("toDelete"))) %>%
  dplyr::filter(LAProx != "toDelete") %>%
  mutate(LAProx = factor(LAProx, levels = c("LAClose", "LAFar"))) %>%
  group_by(blockID, DonorNo, Image, laID, LAProx) %>%
  mutate(sumArea = sum(NucArea)/(((3.07^2)*10^6))) %>%
  group_by(blockID, DonorNo, Image, laID, LAProx, hivStatus) %>%
  add_count(name = "cellTypeCount") %>%
  mutate(totalHIV = sum(hivCount)) %>%
  mutate(cellDen = cellTypeCount/sumArea) %>%
  mutate(hivDen = totalHIV/sumArea) %>%
  summarise(cellDen = mean(cellDen), hivDen = mean(hivDen), laIDHIVCount = mean(laIDHIVCount)) %>%
  group_by(blockID, DonorNo, Image, laID) %>%
  dplyr::filter(hivStatus == "HIVPos") %>%
  dplyr::filter(
    (sum(LAProx == "LAClose") > 0) &
    (sum(LAProx == "LAFar") > 0)) %>%
  ungroup()

# plotting density of HIV+ cells

#
df %>%
  # dplyr::filter(laIDHIVCount >= 50) %>%
  ggplot(aes(x = LAProx, y = hivDen, fill = LAProx))  +
  geom_boxplot(position=position_dodge(0.90), width = 0.8, alpha = 0.65, lwd = 2.0, outlier.shape = NA) +
  # geom_dotplot(position=position_dodge(0.85), binaxis='y', stackdir = "center", dotsize=0.65, show.legend = FALSE, alpha = 0.4, binwidth = 3/10) +
  scale_fill_manual(values = c("#666666", "#666666")) +
    coord_cartesian(ylim = c(0,1000)) +
  # coord_cartesian(ylim = c(0,1250)) +
  scale_x_discrete(labels = c("LA Proximal", "LA Distal")) +
  theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 14,
                                       face="plain",
                                       vjust= -2.0,
                                       angle = 0,
                                       hjust = 0.55),
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4),
              plot.margin = unit(c(1,1,1,1), "cm"))


ggsave("plot1.png", width = 4, height = 8, units = "cm", dpi = 300)

dfTest = df %>%
  # dplyr::filter(laIDHIVCount >= 50) %>%
  select(-cellDen) %>%
  pivot_wider(names_from = LAProx, values_from = hivDen)

wilcox.test(dfTest$LAClose, dfTest$LAFar, paired = TRUE)


# Get donorNo and number of LAs:
length(unique(df$DonorNo))
length(df$blockID)/2
```            

### Figure 4 - 1. Is there a higher density of HIV+ EP or LP DCs near LAs? How does this compare to HIV- counterparts? 2. If there is a higher density near LAs for any target cells, is this solely because that target cell is naturally increased in density near LAs? (USED IN PAPER) (to do)

```{r eval = FALSE, echo = FALSE}

# Answer: Yes there is for DCs and CD4  Tcells in the EP. Some is obviously due to the increased density of these cells near LAs, so at the bottom of
# this chunk we've graphed the fold increased in denstiy of HIV+ or HIV- cells in the LAClose vs LAFar regions. This tells use whether or not HIV+ target
# cells of a give type have an increased propensity to localise near LAs.

#Summary of findings:
# 1. In EP HIV+ and HIV- DCs are at a higher density near LAs
# 2. In EP HIV+ DCs show a greater fold increase in density near LAs than HIV- DCs (indicating that HIV+ DCs preferentially occupy the niche near LAs)
# 3. In LP HIV+ DCs, CD4 T cells and Macs, but not CD4n T cells are at a higher density near LAs than further. Macs are particularly interesting here as HIV+ Macs are at an increased density here whereas there is no difference with LADist for HIV- Macs
# 4.  In LP HIV+ DCs and CD4 T cells show a greater fold increase in density near LAs than HIV- counterparts. Weirdly Macs don't show this increase despite being at a higher density near LAs as per point 3. 

#NOTE: LP filtered for cells in each region being at least 5 whilst EP at least 1 (this is for fold change graphs in part 2 below). For the HIV+ and HIV- cell
# density measurements there was no filtering but zero values not included. 

df = cellData %>% 
  dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  group_by(blockID, DonorNo, Image) %>%
  dplyr::filter(
           (sum(Compartments == "LP") > 0) &
           (sum(Compartments == "EP") > 0) &
           (sum(Compartments == "LA") > 0)) %>% 
  dplyr::filter(Compartments == "LP") %>%
  # mutate(CellTypeZ = case_when(
  #   CellTypeZ == "CD3CD4p" ~ "CD3",
  #   CellTypeZ == "CD3CD4n" ~ "CD3",
  #   TRUE~as.character(CellTypeZ))) %>%
  mutate(hivStatus = case_when(
    hivCount > 0 ~ "HIVPos",
    hivCount == 0 ~ "HIVNeg",
    TRUE~as.character("toDelete"))) %>%
  dplyr::filter(hivStatus != "toDelete") %>%
  mutate(hivStatus = factor(hivStatus, levels = c("HIVNeg", "HIVPos"))) %>%
  mutate(LAProx = case_when(
    LADist <= 400*3.07 ~ "LAClose",
    LADist > 400*3.07 & LADist <= 800*3.07~ "LAFar",
    # LADist > 400*3.07 ~ "LAFar",
    TRUE~as.character("toDelete"))) %>%
  dplyr::filter(LAProx != "toDelete") %>%
  mutate(LAProx = factor(LAProx, levels = c("LAClose", "LAFar"))) %>%
  group_by(blockID, DonorNo, Image, laID, LAProx) %>%
  mutate(sumArea = sum(NucArea)/(((3.07^2)*10^6))) %>%
  group_by(blockID, DonorNo, Image, laID, LAProx, CellTypeZ) %>%
  add_count(name = "totalCellCount") %>%
  # dplyr::filter(totalCellCount >= 10) %>%
  group_by(blockID, DonorNo, Image, laID, LAProx, CellTypeZ, hivStatus) %>%
  add_count(name = "cellTypeCount") %>%
  mutate(cellPerc = (cellTypeCount/totalCellCount)*100) %>%
  # dplyr::filter(cellPerc >= 1) %>%
  # dplyr::filter(totalCellCount >= 10) %>%
  dplyr::filter(cellTypeCount >= 5) %>%
  mutate(cellDen = cellTypeCount/sumArea) %>%
  dplyr::filter(CellTypeZ %in% c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n")) %>%
  mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n"))) %>%
  summarise(cellDen = mean(cellDen), cellTypeCount = mean(cellTypeCount), sumArea = mean(sumArea), totalCellCount = mean(totalCellCount), cellPerc = mean(cellPerc)) %>%
  ungroup()

# Because doing density need to include 0 values for target cells (at least for the LAClose vs Far comparison for either HIV+ or HIV- cells)
# For now don't do this because it drastically skews the results.
# 
# df1 = df %>%
#   select(-c(cellTypeCount, totalCellCount, sumArea, cellPerc)) %>%
#   pivot_wider(names_from = c(LAProx, CellTypeZ, hivStatus), values_from = cellDen)
# 
# df1[is.na(df1)] = 0
# 
# df1 = df1 %>%
#   pivot_longer(cols =c(LAClose_CD11c_HIVNeg:LAFar_CD3CD4n_HIVPos), names_to = c("LAProx", "CellTypeZ", "hivStatus"), names_sep = "_", values_to = "cellDen")

# Check number of LAs, explants, donors, images etc
df %>%
  group_by(blockID, DonorNo, Image, laID, CellTypeZ) %>%
  dplyr::filter(hivStatus == "HIVPos") %>%
  dplyr::filter(
    (sum(LAProx == "LAClose") > 0) &
    (sum(LAProx == "LAFar") > 0)) %>%
  dplyr::filter(CellTypeZ == "CD3CD4n" & LAProx == "LAClose")
  


#plotting

df %>%
  # dplyr::filter(CellTypeZ == "CD11c" | CellTypeZ == "CD3CD4n") %>%
  # mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD11c", "CD3CD4n"))) %>%
  group_by(blockID, DonorNo, Image, laID, CellTypeZ) %>%
  dplyr::filter(hivStatus == "HIVPos") %>%
  dplyr::filter(
    (sum(LAProx == "LAClose") > 0) &
    (sum(LAProx == "LAFar") > 0)) %>%
  ggplot(aes(x = CellTypeZ, y = cellDen, fill = interaction(CellTypeZ, LAProx), colour = interaction(CellTypeZ, LAProx)))  +
  # geom_bar(stat = "summary", position=position_dodge(0.90)) +
  geom_boxplot(position=position_dodge(0.90), width = 0.8, alpha = 0.65, lwd = 1.25, outlier.shape = NA) +
  # geom_point(position=position_dodge(0.90), size = 3) +
  # For EP
 # scale_fill_manual(values = c("#78C679", "#B3B3B3", "#78C679", "#B3B3B3")) +
 # scale_colour_manual(values =c(wes_palette("Zissou1")[1], wes_palette("Zissou1")[1], wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5]))+
 # scale_x_discrete(labels = c("DC", "CD4- TC")) +
  # coord_cartesian(ylim = c(0,160)) +
 coord_cartesian(ylim = c(0,400)) +
 # For LP
  scale_fill_manual(values = c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3", "#78C679", "#FEB24C", "#4292C6", "#B3B3B3")) +
    scale_colour_manual(values =c(wes_palette("Zissou1")[1], wes_palette("Zissou1")[1], wes_palette("Zissou1")[1], wes_palette("Zissou1")[1],wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5]))+
 scale_x_discrete(labels = c("DC", "Mac", "CD4+ TC", "CD4- TC")) +
 # # coord_cartesian(ylim = c(0,400)) +
 # coord_cartesian(ylim = c(0,3000)) +
  theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 14,
                                       face="plain",
                                       vjust= -2.0,
                                       angle = 0,
                                       hjust = 0.55),
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4),
              plot.margin = unit(c(1,1,1,1), "cm"))

# EP      
ggsave("plot1.png", width = 8, height = 6, units = "cm", dpi = 300)
# LP
ggsave("plot1.png", width = 14, height = 10, units = "cm", dpi = 300)


dfTest = df %>%
  select(-c(cellTypeCount, sumArea, totalCellCount, cellPerc)) %>%
  dplyr::filter(hivStatus == "HIVPos") %>%
  dplyr::filter(CellTypeZ == "CD11c") %>%
  group_by(blockID, DonorNo, Image, laID, CellTypeZ) %>%
  dplyr::filter(
    (sum(LAProx == "LAClose") > 0) &
    (sum(LAProx == "LAFar") > 0)) %>%
  pivot_wider(names_from = LAProx, values_from = cellDen)

wilcox.test(dfTest$LAClose, dfTest$LAFar, paired = TRUE)


## Graphing the fold increase in density for HIV+ vs HIV- target cells in LAClose vs LAFar regions. 

dfFold = df %>%
  select(-c(cellTypeCount, sumArea, totalCellCount, cellPerc)) %>%
  group_by(blockID, DonorNo, Image, laID, CellTypeZ, hivStatus) %>%
  dplyr::filter(
  (sum(LAProx == "LAClose") > 0) &
  (sum(LAProx == "LAFar") > 0)) %>%
  pivot_wider(names_from = c(LAProx, hivStatus), values_from = cellDen) %>%
  drop_na()

dfFold = dfFold %>%
  mutate(hivPosFold = log2(LAClose_HIVPos/LAFar_HIVPos)) %>%
  mutate(hivNegFold = log2(LAClose_HIVNeg/LAFar_HIVNeg)) %>%
  select(c(DonorNo, Image, CellTypeZ, hivPosFold, hivNegFold)) %>%
  pivot_longer(cols = c(hivPosFold:hivNegFold), names_to = "hivStatus", values_to = "foldIncrease") %>%
  group_by(blockID, DonorNo, Image, laID, CellTypeZ) %>%
  drop_na(foldIncrease) 
  # dplyr::filter(
  #   (sum(hivStatus == "hivPosFold") > 0) &
  #   (sum(hivStatus == "hivNegFold") > 0))

#Selecting fold change graphs that have highest DC fold change near LA
# dcHigh = dfFold %>%
#   dplyr::filter(CellTypeZ == "CD11c") %>%
#   dplyr::filter(hivStatus == "hivPosFold") %>%
#   arrange(desc(foldIncrease)) %>%
#   dplyr::filter(foldIncrease > 0.4)
# 
# dcLow = dfFold %>%
#   dplyr::filter(CellTypeZ == "CD11c") %>%
#   dplyr::filter(hivStatus == "hivPosFold") %>%
#   arrange(desc(foldIncrease)) %>%
#   dplyr::filter(foldIncrease < 0.4)

dfFold %>%
  # dplyr::filter(CellTypeZ == "CD11c" | CellTypeZ == "CD3CD4n") %>%
  # mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD11c", "CD3CD4n"))) %>%
  ggplot(aes(x = CellTypeZ, y = foldIncrease, fill = interaction(CellTypeZ, hivStatus), colour = interaction(CellTypeZ, hivStatus)))  +
  geom_boxplot(position=position_dodge(0.90), width = 0.8, alpha = 0.65, lwd = 1.25, outlier.shape = NA) +
  # geom_point(position=position_dodge(0.90), size = 3) +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color = "black", size = 1.0) +
 # # For EP
  # scale_fill_manual(values = c("#78C679", "#B3B3B3", "#78C679", "#B3B3B3")) +
  # scale_colour_manual(values =c(wes_palette("Zissou1")[1], wes_palette("Zissou1")[1], wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5]))+
  # scale_x_discrete(labels = c("DC", "CD4- TC")) +
 # For LP
 scale_fill_manual(values = c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3", "#78C679", "#FEB24C", "#4292C6", "#B3B3B3")) +
   scale_colour_manual(values =c(wes_palette("Zissou1")[1], wes_palette("Zissou1")[1], wes_palette("Zissou1")[1], wes_palette("Zissou1")[1],wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5])) +
 scale_x_discrete(labels = c("DC", "Mac", "CD4+TC", "CD4-TC")) +
 # coord_cartesian(ylim = c(-1,6)) +
 #  coord_cartesian(ylim = c(-1.25,2.25)) +
  theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 18,
                                       face="plain",
                                       vjust= -2.0,
                                       angle = 0,
                                       hjust = 0.55),
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4),
              plot.margin = unit(c(1,1,1,1), "cm"))


# EP      
ggsave("plot1.png", width = 12, height = 10, units = "cm", dpi = 300)
# LP
ggsave("plot1.png", width = 14, height = 10, units = "cm", dpi = 300)
ggsave("plot1.png", width = 18, height = 12, units = "cm", dpi = 300)


dfTest = dfFold %>%
  dplyr::filter(CellTypeZ == "CD11c") %>%
  pivot_wider(names_from = hivStatus, values_from = foldIncrease)

t.test(dfTest$hivPosFold, dfTest$hivNegFold, paired = TRUE)

qqnorm(dfTest$hivPosFold)
qqline(dfTest$hivPosFold)
# t.test(dfTest$hivPosFold, dfTest$hivNegFold, paired = TRUE)


# Assign images for significiant comparisons here. Then go back to previous chunk and see if there is an increase in the density of HIV virions near LAs for those images. This acts as a control against the question of whether more virus is simply localising near LAs. CD4n cells should be enough to answer that question but this additional proof helps. 

EPSigImages = dfFold
LPSigImages = dfFold

# Check number of LAs, explants, donors, images etc
dfFold %>%
  # mutate(laIDUnique = paste0(paste0(Image,"_"),laID)) %>%
  dplyr::filter(CellTypeZ == "CD3CD4n") %>%
  dplyr::filter(hivStatus == "hivNegFold")




```


### Figure 4 - Is there an enrichment of HIV+ Macrophages in LP near the EP surface? (to do) (data not shown)

```{r eval = FALSE, echo = FALSE}

df = cellData %>% 
  dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  group_by(blockID, DonorNo, Image) %>%
  dplyr::filter(
           (sum(Compartments == "LP") > 0) &
           (sum(Compartments == "EP") > 0) &
           (sum(Compartments == "LA") > 0)) %>% 
  dplyr::filter(Compartments == "LP") %>%
  # mutate(CellTypeZ = case_when(
  #   CellTypeZ == "CD3CD4p" ~ "CD3",
  #   CellTypeZ == "CD3CD4n" ~ "CD3",
  #   TRUE~as.character(CellTypeZ))) %>%
  mutate(hivStatus = case_when(
    hivCount > 0 ~ "HIVPos",
    hivCount == 0 ~ "HIVNeg",
    TRUE~as.character("toDelete"))) %>%
  dplyr::filter(hivStatus != "toDelete") %>%
  mutate(hivStatus = factor(hivStatus, levels = c("HIVNeg", "HIVPos"))) %>%
  mutate(EPProx = case_when(
    EPDist <= 10*3.07 ~ "EPClose",
    EPDist > 10*3.07 & EPDist <= 20*3.07~ "EPFar",
    TRUE~as.character("toDelete"))) %>%
  dplyr::filter(EPProx != "toDelete") %>%
  mutate(EPProx = factor(EPProx, levels = c("EPClose", "EPFar"))) %>%
  group_by(blockID, DonorNo, Image, EPProx) %>%
  mutate(sumArea = sum(NucArea)/(((3.07^2)*10^6))) %>%
  group_by(blockID, DonorNo, Image,  EPProx, CellTypeZ) %>%
  add_count(name = "totalCellCount") %>%
  # dplyr::filter(totalCellCount >= 10) %>%
  group_by(blockID, DonorNo, Image, EPProx, CellTypeZ, hivStatus) %>%
  add_count(name = "cellTypeCount") %>%
  mutate(cellPerc = (cellTypeCount/totalCellCount)*100) %>%
  # dplyr::filter(cellPerc >= 1) %>%
  # dplyr::filter(totalCellCount >= 10) %>%
  # dplyr::filter(cellTypeCount >= 5) %>%
  mutate(cellDen = cellTypeCount/sumArea) %>%
  dplyr::filter(CellTypeZ %in% c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n")) %>%
  mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n"))) %>%
  summarise(cellDen = mean(cellDen), cellTypeCount = mean(cellTypeCount), sumArea = mean(sumArea), totalCellCount = mean(totalCellCount), cellPerc = mean(cellPerc)) %>%
  ungroup()

# Because doing density need to include 0 values for target cells (at least for the EPClose vs Far comparison for either HIV+ or HIV- cells)
# For now don't do this because it drastically skews the results.
# 
# df1 = df %>%
#   select(-c(cellTypeCount, totalCellCount, sumArea, cellPerc)) %>%
#   pivot_wider(names_from = c(EPProx, CellTypeZ, hivStatus), values_from = cellDen)
# 
# df1[is.na(df1)] = 0
# 
# df1 = df1 %>%
#   pivot_longer(cols =c(EPClose_CD11c_HIVNeg:EPFar_CD3CD4n_HIVPos), names_to = c("EPProx", "CellTypeZ", "hivStatus"), names_sep = "_", values_to = "cellDen")

#plotting

df %>%
  # dplyr::filter(CellTypeZ == "CD11c" | CellTypeZ == "CD3CD4n") %>%
  # mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD11c", "CD3CD4n"))) %>%
  group_by(blockID, DonorNo, Image, CellTypeZ) %>%
  dplyr::filter(hivStatus == "HIVNeg") %>%
  dplyr::filter(
    (sum(EPProx == "EPClose") > 0) &
    (sum(EPProx == "EPFar") > 0)) %>%
  ggplot(aes(x = CellTypeZ, y = cellDen, fill = interaction(CellTypeZ, EPProx), colour = interaction(CellTypeZ, EPProx)))  +
  # geom_bar(stat = "summary", position=position_dodge(0.90)) +
  geom_boxplot(position=position_dodge(0.90), width = 0.8, alpha = 0.65, lwd = 1.25, outlier.shape = NA) +
  # geom_point(position=position_dodge(0.90), size = 3) +
  # For EP
 # scale_fill_manual(values = c("#78C679", "#B3B3B3", "#78C679", "#B3B3B3")) +
 # scale_colour_manual(values =c(wes_palette("Zissou1")[1], wes_palette("Zissou1")[1], wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5]))+
 # scale_x_discrete(labels = c("DC", "CD4- TC")) +
  # coord_cartesian(ylim = c(0,160)) +
 # For LP
  scale_fill_manual(values = c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3", "#78C679", "#FEB24C", "#4292C6", "#B3B3B3")) +
    scale_colour_manual(values =c(wes_palette("Zissou1")[1], wes_palette("Zissou1")[1], wes_palette("Zissou1")[1], wes_palette("Zissou1")[1],wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5]))+
 scale_x_discrete(labels = c("DC", "Mac", "CD4+ TC", "CD4- TC")) +
   # coord_cartesian(ylim = c(0,40)) +
    coord_cartesian(ylim = c(0,2500)) +
  theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 14,
                                       face="plain",
                                       vjust= -2.0,
                                       angle = 0,
                                       hjust = 0.55),
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4),
              plot.margin = unit(c(1,1,1,1), "cm"))

# EP      
ggsave("plot1.png", width = 8, height = 6, units = "cm", dpi = 300)
# LP
ggsave("plot1.png", width = 14, height = 10, units = "cm", dpi = 300)


dfTest = df %>%
  select(-c(cellTypeCount, sumArea, totalCellCount, cellPerc)) %>%
  dplyr::filter(hivStatus == "HIVPos") %>%
  dplyr::filter(CellTypeZ == "FXIIIa") %>%
  group_by(blockID, DonorNo, Image, CellTypeZ) %>%
  dplyr::filter(
    (sum(EPProx == "EPClose") > 0) &
    (sum(EPProx == "EPFar") > 0)) %>%
  pivot_wider(names_from = EPProx, values_from = cellDen)

wilcox.test(dfTest$EPClose, dfTest$EPFar, paired = TRUE)


## Graphing the fold increase in density for HIV+ vs HIV- target cells in EPClose vs EPFar regions. 

dfFold = df %>%
  select(-c(cellTypeCount, sumArea, totalCellCount, cellPerc)) %>%
  group_by(blockID, DonorNo, Image, CellTypeZ, hivStatus) %>%
  dplyr::filter(
  (sum(EPProx == "EPClose") > 0) &
  (sum(EPProx == "EPFar") > 0)) %>%
  pivot_wider(names_from = c(EPProx, hivStatus), values_from = cellDen) %>%
  drop_na()

dfFold = dfFold %>%
  mutate(hivPosFold = log2(EPClose_HIVPos/EPFar_HIVPos)) %>%
  mutate(hivNegFold = log2(EPClose_HIVNeg/EPFar_HIVNeg)) %>%
  select(c(DonorNo, Image, CellTypeZ, hivPosFold, hivNegFold)) %>%
  pivot_longer(cols = c(hivPosFold:hivNegFold), names_to = "hivStatus", values_to = "foldIncrease") %>%
  group_by(blockID, DonorNo, Image, CellTypeZ) %>%
  drop_na(foldIncrease) 
  # dplyr::filter(
  #   (sum(hivStatus == "hivPosFold") > 0) &
  #   (sum(hivStatus == "hivNegFold") > 0))

#Selecting fold change graphs that have highest DC fold change near LA
# dcHigh = dfFold %>%
#   dplyr::filter(CellTypeZ == "CD11c") %>%
#   dplyr::filter(hivStatus == "hivPosFold") %>%
#   arrange(desc(foldIncrease)) %>%
#   dplyr::filter(foldIncrease > 0.4)
# 
# dcLow = dfFold %>%
#   dplyr::filter(CellTypeZ == "CD11c") %>%
#   dplyr::filter(hivStatus == "hivPosFold") %>%
#   arrange(desc(foldIncrease)) %>%
#   dplyr::filter(foldIncrease < 0.4)

dfFold %>%
  # dplyr::filter(CellTypeZ == "CD11c" | CellTypeZ == "CD3CD4n") %>%
  # mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD11c", "CD3CD4n"))) %>%
  ggplot(aes(x = CellTypeZ, y = foldIncrease, fill = interaction(CellTypeZ, hivStatus), colour = interaction(CellTypeZ, hivStatus)))  +
  geom_boxplot(position=position_dodge(0.90), width = 0.8, alpha = 0.65, lwd = 1.25, outlier.shape = NA) +
  # geom_point(position=position_dodge(0.90), size = 3) +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color = "black", size = 1.0) +
 # # For EP
  # scale_fill_manual(values = c("#78C679", "#B3B3B3", "#78C679", "#B3B3B3")) +
  # scale_colour_manual(values =c(wes_palette("Zissou1")[1], wes_palette("Zissou1")[1], wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5]))+
  # scale_x_discrete(labels = c("DC", "CD4- TC")) +
 # For LP
 scale_fill_manual(values = c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3", "#78C679", "#FEB24C", "#4292C6", "#B3B3B3")) +
   scale_colour_manual(values =c(wes_palette("Zissou1")[1], wes_palette("Zissou1")[1], wes_palette("Zissou1")[1], wes_palette("Zissou1")[1],wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5])) +
 scale_x_discrete(labels = c("DC", "Mac", "CD4+TC", "CD4-TC")) +
 # coord_cartesian(ylim = c(-1,6)) +
 #  coord_cartesian(ylim = c(-1.25,2.25)) +
  theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 18,
                                       face="plain",
                                       vjust= -2.0,
                                       angle = 0,
                                       hjust = 0.55),
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4),
              plot.margin = unit(c(1,1,1,1), "cm"))


# EP      
ggsave("plot1.png", width = 12, height = 10, units = "cm", dpi = 300)
# LP
ggsave("plot1.png", width = 14, height = 10, units = "cm", dpi = 300)
ggsave("plot1.png", width = 18, height = 12, units = "cm", dpi = 300)


dfTest = dfFold %>%
  dplyr::filter(CellTypeZ == "CD3CD4n") %>%
  pivot_wider(names_from = hivStatus, values_from = foldIncrease)

t.test(dfTest$hivPosFold, dfTest$hivNegFold, paired = TRUE)

qqnorm(dfTest$hivPosFold)
qqline(dfTest$hivPosFold)
# t.test(dfTest$hivPosFold, dfTest$hivNegFold, paired = TRUE)


# Assign images for significiant comparisons here. Then go back to previous chunk and see if there is an increase in the density of HIV virions near LAs for those images. This acts as a control against the question of whether more virus is simply localising near LAs. CD4n cells should be enough to answer that question but this additional proof helps. 

EPSigImages = dfFold
LPSigImages = dfFold

```




## LP ##

## LA ##

### Do LAs have a higher density of HIV than other compartments? (USED IN PAPER)

```{r eval = FALSE, echo = FALSE}

# Method: Compare top 10% most HIV dense compartments to each other. Eg top 10% most HIV dense LAs verses top 10% most HIV dense LP (Images). 

# Get mucosal LAs only:
a = cellData %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  group_by(blockID, DonorNo, ImageID, laID) %>%
  dplyr::filter(Compartments == "LA") %>%
  mutate(minLP = min(LPDist)) %>%
  dplyr::filter(minLP < 10*3.07)

toKeep = unique(a$ImageID)

# Select top 10% most dense LAs
dfLA = cellData %>%
  dplyr::filter(ImageID %in% toKeep) %>%
  group_by(blockID, DonorNo, ImageID, Compartments, laID) %>%
  # dplyr::filter(laIDHIVCount >=2) %>%
  dplyr::filter(Compartments == "LA") %>%
  mutate(compArea = sum(NucArea)/((3.07^2)*(10^6))) %>%
  mutate(compHIV = sum(hivCount)) %>%
  mutate(hivDen = (compHIV/compArea)) %>%
  summarise(compHIV = mean(compHIV), compArea = mean(compArea), hivDen = mean(hivDen)) %>%
  group_by(Compartments) %>%
  # dplyr::filter(hivDen > quantile(hivDen, 0.9))%>%
  slice_max(hivDen, n=10)

dfOther = cellData %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  group_by(blockID, DonorNo, ImageID, Compartments) %>%
  dplyr::filter(Compartments != "LA" & Compartments != "Undefined") %>%
  mutate(compArea = sum(NucArea)/((3.07^2)*(10^6))) %>%
  mutate(compHIV = sum(hivCount)) %>%
  # dplyr::filter(compHIV >=2)
  mutate(hivDen = (compHIV/compArea)) %>%
  summarise(compHIV = mean(compHIV), compArea = mean(compArea), hivDen = mean(hivDen)) %>%
  group_by(Compartments) %>%
  slice_max(hivDen, n=10)

dfOther$laID = "noLA"
dfOther = dfOther %>%
  relocate(laID, .before = compHIV)
df = rbind(dfLA, dfOther)

df %>%
  mutate(Compartments = factor(Compartments, levels = c("LA", "EP", "LP", "SM"))) %>%
  ggplot(aes(x = Compartments, y= hivDen, fill = Compartments)) + 
  geom_boxplot(position=position_dodge(1.0), width = 0.8, alpha = 0.65, lwd = 2.0, outlier.shape = NA) +
  scale_fill_manual(values = c("#666666", "#666666", "#666666", "#666666")) +
  # coord_cartesian(ylim = c(1,3.5)) +
  theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 16,
                                       face="plain",
                                       vjust= -0.4,
                                       hjust = 0.5),    # Y axis text
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 6.3,
                                       angle = 45,
                                       hjust = -0.75),    # Y axis text
              plot.margin = unit(c(1,1,1,1), "cm"))    # Y axis title

ggsave("plot4.png", width = 10, height = 12, units = "cm", dpi = 300)


# Run to compare LA to other comps grouped. Checking to see fold difference in enrichment in LAs vs other compartments
dfCompare = df %>%
   mutate(Compartments = case_when(
     Compartments %in% c("EP", "LP", "SM") ~ "nonLA",
     TRUE ~ as.character("LA"))) %>%
  summarise(hivDen = median(hivDen))

# End
  
dfTest = dfCompare
dfTest$ID = rep(seq(1,length(dfTest$Compartments)))

dfTest =  dfTest %>%
  select(ID, Compartments, hivDen) %>%
  pivot_wider(names_from = Compartments, values_from = hivDen)

# dfTest[is.na(dfTest)] = 0

wilcox.test(dfTest$LA, dfTest$nonLA, paired = FALSE)



```
### Figure 4 - What does the distribution of HIV levels in LAs look like? Plot together and by DonorNo (USED IN PAPER)

```{r eval = FALSE, echo = FALSE}


df = cellData %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  group_by(blockID, DonorNo, ImageID, laID) %>%
  dplyr::filter(Compartments == "LA") %>%
  # dplyr::filter(laIDHIVCount >=2) %>%
  mutate(minLP = min(LPDist)) %>%
  dplyr::filter(minLP < 10*3.07) %>%
  mutate(compArea = sum(NucArea)/((3.07^2)*(10^6))) %>%
  mutate(compHIV = sum(hivCount)) %>%
  mutate(hivDen = (compHIV/compArea)) %>%
  summarise(compHIV = mean(compHIV), compArea = mean(compArea), hivDen = mean(hivDen))

# By DonorNo

a = df[1,]
a$DonorNo = " "
a$DonorNo = as.factor(a$DonorNo)
a$hivDen = 1000000

df = rbind(df,a)

df = df %>%
    arrange(desc(hivDen))

df$blockID = factor(df$blockID, levels = unique(df$blockID))
df$DonorNo = factor(df$DonorNo, levels = unique(df$DonorNo))

df %>%
  ggplot(aes(x = DonorNo, y = log10(hivDen), size = log10(hivDen))) +
  geom_point(alpha = 0.5, colour = "#666666" ) +
  scale_size(range = c(0.1,4)) +
  # scale_fill_manual(values = "#666666") +
  coord_cartesian(ylim = c(0,4.3)) +
    # theme_minimal_hgrid(12) +
  annotation_logticks(sides = "l", size = 0.5) +
  theme_classic() +
    theme(
          text = element_text(family = "Arial"),
          legend.position = "none",
                axis.title.x=element_blank(),
                axis.text.x=element_text(size = 13,
                                         face="plain",
                                         vjust= 0.4,
                                         angle = 90,
                                         hjust = 0),    # Y axis text
                axis.title.y=element_blank(),
                axis.text.y=element_text(size = 21,
                                         face="plain",
                                         vjust= 0.4),
      plot.margin = unit(c(0.75,0.75,0.75,0.75), "cm"))


ggsave("plot1.png", width = 10, height = 10, units = "cm", dpi = 300)


# Get the number of LAs per donor and the number that are HIV+ (annotate this on top of above figure)
# Will need to comment out the filtering of laIDHIVCount >=2 above in df. 

a = df %>% 
  group_by(DonorNo) %>%
  mutate(LANo = sum(ImageID > 0)) %>%
  mutate(LAHIVNo= sum(hivDen > 0)) %>%
  mutate(LAHIVNegNo = LANo - LAHIVNo) %>%
  summarise(LANo = mean(LANo), LAHIVNo = mean(LAHIVNo), LAHIVNegNo = mean(LAHIVNegNo))

a = a %>%
  pivot_longer(cols = c(LAHIVNegNo, LAHIVNo), names_to = "noType", values_to = "No") %>%
  mutate(noType = factor(noType, levels = c("LAHIVNo", "LAHIVNegNo")))

a %>%
  ggplot(aes(x = DonorNo, y = No, fill = noType)) +
  geom_bar(stat = "identity", position = "stack") +
  scale_fill_manual(values = c("#ef8a62", "#67a9cf"))  +
  theme_classic() +
  theme(
          text = element_text(family = "Arial"),
          legend.position = "none",
                axis.title.x=element_blank(),
                axis.text.x=element_blank(),
                # axis.text.x=element_text(size = 14,
                #                          face="plain",
                #                          vjust= 0.0,
                #                          angle = 90,
                #                          hjust = 0.0),    # Y axis text
                axis.title.y=element_blank(),
                axis.text.y=element_text(size = 14,
                                         face="plain",
                                         vjust= 0.4),
      plot.margin = unit(c(0.75,0.75,0.75,0.75), "cm"))

ggsave("plot1.png", width = 10, height = 4, units = "cm", dpi = 300)


# 
# df %>%
#   # dplyr::filter(hivDen > 0) %>%
#   # dplyr::filter(compHIV > 30) %>%
#   ggplot(aes(x = " ", y = log10(hivDen + 0.0001), fill = "#666666")) +
#   # geom_bar(stat= "summary") +
#   # geom_boxplot(position=position_dodge(0.90), width = 0.8, alpha = 0.65, lwd = 1.25, outlier.shape = NA) +
#   geom_violin(width = 0.9, alpha =0.6, trim = FALSE, lwd = 1.0) +
#   geom_dotplot(position=position_dodge(0.85), binaxis='y', stackdir = "center", dotsize=0.65, show.legend = FALSE, alpha = 0.4, binwidth = log10(20000)/20) +
#   scale_fill_manual(values = "#666666") +
#   # coord_cartesian(ylim = c(0,30)) +
#     theme_minimal_hgrid(12) +
#     theme(
#           text = element_text(family = "Arial"),
#           legend.position = "none",
#                 axis.title.x=element_blank(),
#                 axis.text.x=element_text(size = 18,
#                                          face="plain",
#                                          vjust= 0.0,
#                                          angle = 0,
#                                          hjust = 0.5),    # Y axis text
#                 axis.title.y=element_blank(),
#                 axis.text.y=element_text(size = 18,
#                                          face="plain",
#                                          vjust= 0.4)) 
# 
# ggsave("plot1.png", width = 14, height = 10, units = "cm", dpi = 300)


# Scatter plots

df %>%
  # dplyr::filter(hivDen > 0) %>%
  ggplot(aes(x = compArea, y = sqrt(hivDen), colour = blockID, fill = "#666666")) +
  geom_point(size = 4, alpha = 0.65)
  scale_fill_manual(values = "#666666") +
  # coord_cartesian(ylim = c(0,30)) +
    theme_minimal_hgrid(12) +
    theme(
          text = element_text(family = "Arial"),
          legend.position = "none",
                axis.title.x=element_blank(),
                axis.text.x=element_text(size = 18,
                                         face="plain",
                                         vjust= 0.0,
                                         angle = 0,
                                         hjust = 0.5),    # Y axis text
                axis.title.y=element_blank(),
                axis.text.y=element_text(size = 18,
                                         face="plain",
                                         vjust= 0.4)) 

  
ggsave("plot1.png", width = 14, height = 10, units = "cm", dpi = 300)
```

## Figure 4 - For LAs what is the distribution of HIV penetration depths? (USED IN PAPER)

```{r echo = FALSE}

# Group LAs into 3 sizes, small, medium, large. Show LAInnerDist normalised with 3 boxplots. And also the average radius of LAs in each group. 

df = cellData %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  group_by(blockID, DonorNo, ImageID, laID) %>%
  dplyr::filter(Compartments == "LA") %>%
  dplyr::filter(laIDHIVCount >= 10) %>%
  mutate(minLP = min(LPDist)) %>%
  dplyr::filter(minLP < 10*3.07) %>%
  mutate(maxDist = max(LAInnerDist)) %>%
  mutate(LAInnerDist2 = LAInnerDist/maxDist) %>%
  mutate(radius = maxDist/3.07) %>%
  mutate(LAInnerDist = LAInnerDist/3.07) %>%
  dplyr::filter(hivCount > 0) %>%
  # mutate(hivStatus = case_when(
  #   hivCount > 0 ~ "hivPos",
  #   hivCount == 0 ~ "hivNeg",
  #   TRUE~as.character("toDelete"))) %>%
  # dplyr::filter(hivStatus != "toDelete") %>%
  mutate(laIDUnique = paste0(paste0(blockID,"_"),ImageID)) %>%
  mutate(laIDUnique = paste0(paste0(laIDUnique,"_"),laID)) %>%
# arrange(desc(maxDist)) %>%
  mutate(laIDUnique = factor(laIDUnique, levels = unique(laIDUnique)))

# check donorNo and LAs used for fig legend. 
length(unique(df$DonorNo))
length(unique(df$laIDUnique))


df1 = df %>%
  group_by(blockID, DonorNo, ImageID, laID) %>%
  summarise(radius = mean(radius), LAInnerDist = mean(LAInnerDist), LAInnerDist2 = mean(LAInnerDist2))

df1$quants =  fabricatr::split_quantile(df1$radius,3)
df1$quants = factor(df1$quants, levels = c("1", "2", "3"))

#Radius
df1 %>%
  ggplot(aes(x = quants, y = radius, fill = quants)) +
  geom_boxplot(position=position_dodge(1.0), width = 0.8, alpha = 0.65, lwd = 2.0, outlier.shape = NA) +
  scale_fill_manual(values = rep("#666666",3)) +
  scale_x_discrete(labels = c("small", "mid", "large")) +
  theme_classic() +
  
  coord_cartesian(ylim = c(0,400)) +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 16,
                                       face="plain",
                                       vjust= -1,
                                       angle = 0,
                                       hjust = 0.5),
              axis.title.y=element_blank(),

              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4),
              plot.margin = unit(c(1,1,1,1), "cm"))
  
ggsave("plot1.png", width = 8, height = 10, units = "cm", dpi = 300)
  
# Penetration depth

df2 = left_join(df, df1[,c("blockID", "DonorNo", "ImageID", "laID", "quants")])

df2 %>%
  ggplot(aes(x = quants, y = LAInnerDist2)) +
  geom_violin(width = 0.7, alpha =0.65, trim = TRUE, lwd = 1.5, fill = "#666666", draw_quantiles = c(0.25, 0.5, 0.75)) +
  scale_x_discrete(labels = c("small", "mid", "large")) +
  theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 16,
                                       face="plain",
                                       vjust= -1,
                                       angle = 0,
                                       hjust = 0.5),
              axis.title.y=element_blank(),

              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4),
              plot.margin = unit(c(1,1,1,1), "cm"))

ggsave("plot1.png", width = 8, height = 10, units = "cm", dpi = 300)



```

## Figure 4 - 1. Are HIV+ cells in LAs more toward the inside or outer ring of LAs? (USED IN PAPER)

```{r echo = FALSE}

#First we do boxplots with intervals broken up. In second part in this section we do foldchange vs LAInnerDist

# Virion density in intervals of LA. Also proportion of celltypes that are HIV+ in each region. 

#LA intervals for splitting into even area concentric cirlces
intervals = 1 - c(sqrt(1-(1/8)), sqrt(1-(2/8)), sqrt(1-(3/8)), sqrt(1-(4/8)), sqrt(1-(5/8)), sqrt(1-(6/8)), sqrt(1-(7/8)))

#Note. LA assumed as circle and divided into 4 even areas concentrically.
df = cellData %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  group_by(blockID, DonorNo, ImageID, laID) %>%
  dplyr::filter(Compartments == "LA") %>%
  dplyr::filter(laIDHIVCount >= 2) %>%
  mutate(minLP = min(LPDist)) %>%
  dplyr::filter(minLP < 10*3.07) %>%
  mutate(maxDist = max(LAInnerDist)) %>%
  mutate(LAInnerDist = LAInnerDist/maxDist) %>%
  #  mutate(edgeInterval = case_when(
  #   LAInnerDist >= 0 & LAInnerDist < (1 - c(sqrt(1-(1/2)))) ~ "1",
  #   LAInnerDist >= (1 - c(sqrt(1-(1/2)))) & LAInnerDist < 1 ~ "2",
  #   TRUE~as.character("toDelete"))) %>%
  # dplyr::filter(edgeInterval != "toDelete") %>%
  # mutate(edgeInterval = factor(edgeInterval, levels = c("1","2"))) %>%
  mutate(edgeInterval = case_when(
    LAInnerDist >= 0 & LAInnerDist < intervals[1] ~ "1",
    LAInnerDist >= intervals[1] & LAInnerDist < intervals[2] ~ "2",
    LAInnerDist >= intervals[2] & LAInnerDist < intervals[3] ~ "3",
    LAInnerDist >= intervals[3] & LAInnerDist < intervals[4]~ "4",
    LAInnerDist >= intervals[4] & LAInnerDist < intervals[5] ~ "5",
    LAInnerDist >= intervals[5] & LAInnerDist < intervals[6] ~ "6",
    LAInnerDist >= intervals[6] & LAInnerDist < intervals[7] ~ "7",
    LAInnerDist >= intervals[7] & LAInnerDist < 1.0 ~ "8",
    TRUE~as.character("toDelete"))) %>%
  dplyr::filter(edgeInterval != "toDelete") %>%
  mutate(edgeInterval = factor(edgeInterval, levels = c("1","2", "3", "4", "5", "6", "7", "8"))) %>%
  # mutate(hivStatus = case_when(
  #   hivCount > 0 ~ "hivPos",
  #   hivCount == 0 ~ "hivNeg",
  #   TRUE~as.character("toDelete"))) %>%
  # dplyr::filter(hivStatus != "toDelete") %>%
  group_by(blockID, DonorNo, ImageID, laID, edgeInterval) %>%
  mutate(hivSum = sum(hivCount)) %>%
  mutate(sumArea = sum(NucArea)/(((3.07^2)*10^6))) %>%
  mutate(hivDen = hivSum/sumArea) %>%
  add_count(name = "cellCount") %>%
  group_by(blockID, DonorNo,ImageID,laID, edgeInterval, CellTypeZ) %>%
  mutate(cellTypeHIV = sum(hivCount)) %>%
  mutate(hivProp = (cellTypeHIV/hivSum)*100) %>%
  dplyr::filter(hivCount > 0) %>%
  add_count(name = "cellTypeCount") %>%
  mutate(cellProp = (cellTypeCount/cellCount)*100) %>%
  summarise(cellProp = mean(cellProp), hivDen = mean(hivDen), hivProp = mean(hivProp), sumArea = mean(sumArea))

# Density of virions in two regions of LA. Or HIVProp in each region.

# df1 =  df %>%
#   select(-c(cellProp, hivProp, sumArea)) %>%
#   dplyr::filter(CellTypeZ == "CD11c") %>%
#   pivot_wider(names_from = edgeInterval, values_from = hivDen) 
#   
# df1[is.na(df1)] = 0
# 
# 
# df1 = df1 %>% pivot_longer(cols = c(`1`:`7`), names_to = "edgeInterval", values_to = "hivDen")


df %>%
  ggplot(aes(x = edgeInterval, y = sumArea, fill = edgeInterval)) +
  # geom_bar(stat ="summary",position=position_dodge(0.85), alpha = 0.65) +
  geom_boxplot(position=position_dodge(1.0), width = 0.6, alpha = 0.65, lwd = 2.0, outlier.shape = NA) +
  scale_fill_manual(values = rep("#666666",8)) +
  # scale_x_discrete(labels = c("0.125", "0.50", "0.75", "1.0", "0.25", "0.50", "0.75", "1.0")) +
  theme_classic() +
  coord_cartesian(ylim = c(0,0.05)) +
  # coord_cartesian(ylim = c(0,10000)) +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 18,
                                       face="plain",
                                       vjust= -1,
                                       angle = 0,
                                       hjust = 0.5),
              axis.title.y=element_blank(),

              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4),
              plot.margin = unit(c(1,1,1,1), "cm"))
  
ggsave("plot1.png", width = 8, height = 10, units = "cm", dpi = 300)

dfTest =  df %>%
  select(-c(cellProp, hivProp, sumArea)) %>%
  dplyr::filter(CellTypeZ == "CD11c") %>%
  pivot_wider(names_from = edgeInterval, values_from = hivDen) 
  

# dfTest[is.na(dfTest)] = 0

wilcox.test(dfTest$`1`, dfTest$`8`, paired = TRUE)

# Checking LA and donorNo

# Add blockID to the pipe above. Then merge with blockID and ImageID and laID. 
df1 = df %>%
  mutate(laIDUnique = paste0(paste0(blockID,"_"),ImageID)) %>%
  mutate(laIDUnique = paste0(paste0(laIDUnique,"_"),laID))

length(unique(df1$DonorNo))
length(unique(df1$laIDUnique))


## Proportion of target cells HIV+ going into LA.
    
df = cellData %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  group_by(blockID, DonorNo, ImageID, laID) %>%
  dplyr::filter(Compartments == "LA") %>%
  dplyr::filter(laIDHIVCount >= 2) %>%
  mutate(minLP = min(LPDist)) %>%
  dplyr::filter(minLP < 10*3.07) %>%
  mutate(maxDist = max(LAInnerDist)) %>%
  mutate(LAInnerDist = LAInnerDist/maxDist)
   
dfWholeDen = df %>%
  group_by(blockID, DonorNo, ImageID, laID) %>%
  mutate(sumAreaWhole = sum(NucArea)/(((3.07^2)*10^6))) %>%
  mutate(hivSumWhole = sum(hivCount)) %>%
  mutate(hivDenWhole = hivSumWhole/sumAreaWhole) %>%
  summarise(hivDenWhole = mean(hivDenWhole)) %>%
  ungroup()

sequence = 1 - c(sqrt(1-(1/20)), sqrt(1-(2/20)), sqrt(1-(3/20)), sqrt(1-(4/20)), sqrt(1-(5/20)), sqrt(1-(6/20)), sqrt(1-(7/20)), sqrt(1-(8/20)),sqrt(1-(9/20)), sqrt(1-(10/20)), sqrt(1-(11/20)), sqrt(1-(12/20)), sqrt(1-(13/20)), sqrt(1-(14/20)), sqrt(1-(15/20)), sqrt(1-(16/20)), sqrt(1-(17/20)),sqrt(1-(18/20)), sqrt(1-(19/20)))

vals = data.frame(sequence)
colnames(vals) = "Distance"
base =  0 
dfMain = data.frame()
n = 0

for(i in sequence) {
  
  df0 = df %>%  
    group_by(blockID, DonorNo, ImageID, laID) %>%
    dplyr::filter((LAInnerDist >= base) & (LAInnerDist < i)) %>%
    mutate(sumArea = sum(NucArea)/(((3.07^2)*10^6))) %>%
    mutate(hivSum = sum(hivCount)) %>%
    mutate(hivDen = hivSum/sumArea) %>%
    summarise(hivDen = mean(hivDen)) 
  
  df1 = df0
  df1[is.na(df1)] = 0

  df1 = left_join(df1, dfWholeDen)

  df1 = df1 %>%
    mutate(foldChange = hivDen/hivDenWhole)
  
  df1$distance = i
  n = n + 1
  df1$interval = n
  dfMain = rbind(dfMain, df1)
  
  base = i
  
}

dfMain$distance = as.factor(dfMain$distance)
dfMain$interval = as.factor(dfMain$interval)

# check donorNo and LAs used for fig legend. 
df1 = dfMain %>%
  mutate(laIDUnique = paste0(paste0(blockID,"_"),ImageID)) %>%
  mutate(laIDUnique = paste0(paste0(laIDUnique,"_"),laID))
length(unique(df1$DonorNo))
length(unique(df1$laIDUnique))

dfMain2 = dfMain %>% dplyr::filter(hivDen != 0)

# dfMain2 = dfMain %>% drop_na(foldChange)

# dfMain2 = dfMain



test1 = dfMain2 %>%
  pivot_longer(cols = c("foldChange", "hivDen", "hivDenWhole"), names_to = c("measureType"), values_to = "values") %>%
  dplyr::filter(measureType != "foldChange") %>%
  group_by(interval) %>%
  summarise(pVal = t.test(values ~ measureType, paired = TRUE, alternative = "two.sided")$p.value)

test2 = dfMain2 %>%
  group_by(interval) %>%
  summarise(mean = mean(hivDen), sd = sd(hivDen))

# test = test2
test = left_join(test1, test2)
# 
test = test %>%
  mutate(sdLower = mean - sd) %>%
  mutate(sdHigher = mean + sd)

# test$distance = as.numeric(as.character((test$distance)))
# test$hivStatus = factor(test$hivStatus, levels = c("hivNeg", "hivPos"))
# seqChar = as.character(sequence)
test$interval = as.numeric(as.character((test$interval)))

g = test %>%
  # dplyr::filter(CellTypeZ != "Unknown") %>%
  ggplot(aes(x = interval, y = mean, fill = "red", colour = "red")) +
  # geom_line(aes(colour = CellTypeZ), size = 1) +
  geom_smooth() +
  # geom_ribbon(aes(ymin = sdLower, ymax = sdHigher, fill = CellTypeZ), colour = "grey70", alpha = 0.4) +
  geom_point(size = 4, alpha = 0.5) +
  scale_colour_manual(values = c("#666666")) +
  scale_fill_manual(values = c("#666666")) +
  # scale_color_gradient(low = "#e5f5e0", high = "#31a354")
  # geom_hline(yintercept = 0.0, linetype = "dashed", color = "black") +
  # ylim(c(0.5,2.5)) +
  # coord_cartesian(ylim = c(0.9,1.5)) +
  theme_minimal() +
  # scale_colour_manual(values = c("#78C679", "#4292C6")) +
  # scale_fill_manual(values = c("#78C679", "#4292C6")) +
  # scale_colour_manual(values = c("#67a9cf", "#ef8a62")) +
  # scale_fill_manual(values = c("#67a9cf", "#ef8a62")) +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.0,
                                       angle = 0,
                                       hjust = 0.5),    # Y axis text
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4)) 
g
              
ggsave("plot1.png", width = 10, height = 10, units = "cm", dpi = 300)


# Spare


## Scatter plot of HIV penetration distances

df1 = cellData %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  mutate(minLP = min(LPDist)) %>%
  dplyr::filter(minLP < 10*3.07) %>%
  group_by(blockID, DonorNo, ImageID, laID) %>%
  dplyr::filter(Compartments == "LA") %>%
  dplyr::filter(laIDHIVCount >= 10) %>%
  mutate(maxDist = max(LAInnerDist)) %>%
  mutate(LAInnerDist2 = LAInnerDist/maxDist) %>%
  mutate(laIDUnique = paste0(ImageID,laID)) %>%
  mutate(hivStatus = case_when(
    hivCount > 0 ~ "hivPos",
    hivCount == 0 ~ "hivNeg",
    TRUE~as.character("toDelete"))) %>%
  dplyr::filter(hivStatus != "toDelete")

df1 %>%
  # dplyr::filter(hivCount > 0) %>%
  dplyr::filter(CellTypeZ == "CD3CD4p") %>%
  # group_by(blockID, DonorNo, ImageID, laID, CellTypeZ, hivStatus) %>%
  # summarise(LAInnerDist = mean(LAInnerDist), LAInnerDist2 = mean(LAInnerDist2)) %>%
  ggplot(aes(x = LAInnerDist/3.07, y = LAInnerDist2, colour = hivStatus)) +
  # geom_point(alpha = 0.5, size = 2) +
  geom_smooth() +
  theme_classic() +
   theme(
        text = element_text(family = "Arial"),
        # legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 18,
                                       face="plain",
                                       vjust= -1,
                                       angle = 0,
                                       hjust = 0.5),
              axis.title.y=element_blank(),

              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4),
              plot.margin = unit(c(1,1,1,1), "cm"))


```



## Figure 4 - Are HIV+ DCs preferentially located toward the inside of LAs? i.e does the proportion of DCs that are HIV+ increase toward center?

```{r echo = FALSE}


#First we do boxplots with intervals broken up. In second part in this section we check finner intervals and draw a line graph. 

# LA intervals for splitting into even area concentric cirlces
intervals = 1 - c(sqrt(1-(1/8)), sqrt(1-(2/8)), sqrt(1-(3/8)), sqrt(1-(4/8)), sqrt(1-(5/8)), sqrt(1-(6/8)), sqrt(1-(7/8)))

# Proportion of target cells that are HIV+ in each of the regions of the LA. 
df = cellData %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  group_by(blockID, DonorNo, ImageID, laID) %>%
  dplyr::filter(Compartments == "LA") %>%
  dplyr::filter(laIDHIVCount >= 2) %>%
  mutate(minLP = min(LPDist)) %>%
  dplyr::filter(minLP < 10*3.07) %>%
  mutate(maxDist = max(LAInnerDist)) %>%
  mutate(LAInnerDist = LAInnerDist/maxDist) %>%
  #  mutate(edgeInterval = case_when(
  #   LAInnerDist >= 0 & LAInnerDist < (1 - c(sqrt(1-(1/2)))) ~ "1",
  #   LAInnerDist >= (1 - c(sqrt(1-(1/2)))) & LAInnerDist < 1 ~ "2",
  #   TRUE~as.character("toDelete"))) %>%
  # dplyr::filter(edgeInterval != "toDelete") %>%
  # mutate(edgeInterval = factor(edgeInterval, levels = c("1","2"))) %>%
  mutate(edgeInterval = case_when(
    LAInnerDist >= 0 & LAInnerDist < intervals[1] ~ "1",
    LAInnerDist >= intervals[1] & LAInnerDist < intervals[2] ~ "2",
    LAInnerDist >= intervals[2] & LAInnerDist < intervals[3] ~ "3",
    LAInnerDist >= intervals[3] & LAInnerDist < intervals[4]~ "4",
    LAInnerDist >= intervals[4] & LAInnerDist < intervals[5] ~ "5",
    LAInnerDist >= intervals[5] & LAInnerDist < intervals[6] ~ "6",
    LAInnerDist >= intervals[6] & LAInnerDist < intervals[7] ~ "7",
    LAInnerDist >= intervals[7] & LAInnerDist < 1.0 ~ "8",
    TRUE~as.character("toDelete"))) %>%
  dplyr::filter(edgeInterval != "toDelete") %>%
  mutate(edgeInterval = factor(edgeInterval, levels = c("1","2", "3", "4", "5", "6", "7", "8"))) %>%
  group_by(blockID, DonorNo, ImageID, laID, edgeInterval, CellTypeZ) %>%
  add_count(name = "cellCount") %>%
  dplyr::filter(hivCount > 0) %>%
  add_count(name = "cellTypeCount") %>%
  mutate(cellProp = (cellTypeCount/cellCount)*100) %>%
  summarise(cellProp = mean(cellProp)) %>%
  dplyr::filter(CellTypeZ %in% c("CD11c", "CD3CD4p", "Unknown")) %>%
  mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD11c", "CD3CD4p", "Unknown")))

  # df1 = pivot_wider(df, names_from = CellTypeZ, values_from = "cellProp")
  # 
  # df1[is.na(df1)] = 0
  # 
  # df1 = pivot_longer(df1, cols = c("CD11c", "CD3CD4p"), names_to = c("CellTypeZ"), values_to = "cellProp")

# Get LA and donorNos:
df1 = df %>% 
  mutate(laIDUnique = paste0(paste0(blockID,"_"),ImageID)) %>%
  mutate(laIDUnique = paste0(paste0(laIDUnique,"_"),laID)) %>%
  mutate(laIDUnique = factor(laIDUnique, levels = unique(laIDUnique))) %>%
  dplyr::filter(CellTypeZ == "Unknown")

length(unique(df1$DonorNo))
length(unique(df1$laIDUnique))



df %>%
  dplyr::filter(CellTypeZ == "CD11c") %>%
  ggplot(aes(x = edgeInterval, y = cellProp, fill = edgeInterval)) +
  geom_boxplot(position=position_dodge(1.0), width = 0.60, alpha = 0.65, lwd = 1.25, outlier.shape = NA) +
  scale_fill_manual(values = rep("#78C679",8)) +
  # scale_fill_manual(values = rep("#4292C6",8)) +
  # scale_fill_manual(values = rep("#02384f",8)) +

  theme_classic() +
  coord_cartesian(ylim = c(0,70)) +
  # coord_cartesian(ylim = c(0, 40)) +
  # coord_cartesian(ylim = c(0, 20)) +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 18,
                                       face="plain",
                                       vjust= -1,
                                       angle = 0,
                                       hjust = 0.5),
              axis.title.y=element_blank(),

              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4),
              plot.margin = unit(c(1,1,1,1), "cm"))

ggsave("plot1.png", width = 6, height = 10, units = "cm", dpi = 300)


dfTest =  df %>%
  # select(-c(cellProp, hivProp, sumArea)) %>%
  dplyr::filter(CellTypeZ == "CD11c") %>%
  pivot_wider(names_from = edgeInterval, values_from = cellProp)
  
# dfTest[is.na(dfTest)] = 0

wilcox.test(dfTest$`4`, dfTest$`8`, paired = FALSE)


# Two methods. 1. Increasing radial intervals. 2. Concentric even Area circles. 

# Second Method

df = cellData %>%
  # dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  group_by(blockID, DonorNo, ImageID, laID) %>%
  dplyr::filter(Compartments == "LA") %>%
  dplyr::filter(laIDHIVCount >= 2) %>%
  mutate(minLP = min(LPDist)) %>%
  dplyr::filter(minLP < 10*3.07) %>%
  mutate(maxDist = max(LAInnerDist)) %>%
  mutate(LAInnerDist = LAInnerDist/maxDist)
#    
# dfWholeDen = df %>%
#   group_by(blockID, DonorNo, ImageID, laID) %>%
#   mutate(sumAreaWhole = sum(NucArea)/(((3.07^2)*10^6))) %>%
#   mutate(hivSumWhole = sum(hivCount)) %>%
#   mutate(hivDenWhole = hivSumWhole/sumAreaWhole) %>%
#   summarise(hivDenWhole = mean(hivDenWhole)) %>%
#   ungroup()

sequence = 1 - c(sqrt(1-(1/20)), sqrt(1-(2/20)), sqrt(1-(3/20)), sqrt(1-(4/20)), sqrt(1-(5/20)), sqrt(1-(6/20)), sqrt(1-(7/20)), sqrt(1-(8/20)),sqrt(1-(9/20)), sqrt(1-(10/20)), sqrt(1-(11/20)), sqrt(1-(12/20)), sqrt(1-(13/20)), sqrt(1-(14/20)), sqrt(1-(15/20)), sqrt(1-(16/20)), sqrt(1-(17/20)),sqrt(1-(18/20)), sqrt(1-(19/20)))

vals = data.frame(sequence)
colnames(vals) = "Distance"
base =  0 
dfMain = data.frame()
n = 0

for(i in sequence) {
  
  df0 = df %>%  
    group_by(blockID, DonorNo, ImageID, laID) %>%
    dplyr::filter((LAInnerDist >= base) & (LAInnerDist < i)) %>%
    add_count(name = "cellCount") %>%
    # mutate(sumArea = sum(NucArea)/(((3.07^2)*10^6))) %>%
    group_by(blockID, DonorNo, ImageID,laID, CellTypeZ) %>%
    dplyr::filter(hivCount > 0) %>%
    add_count(name = "cellTypeCount") %>%
    mutate(cellProp = (cellTypeCount/cellCount)*100) %>%
    # mutate(cellDen = cellTypeCount/sumArea) %>%
    dplyr::filter(CellTypeZ %in% c("CD11c", "CD3CD4p", "Unknown")) %>%
    mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD11c", "CD3CD4p", "Unknown"))) %>%
    summarise(cellProp = mean(cellProp)) %>%
    # summarise(cellDen = mean(cellDen)) %>%
    ungroup()
  
  toMeasure = "cellProp"
  df1 = pivot_wider(df0, names_from = CellTypeZ, values_from = toMeasure)

  df1[is.na(df1)] = 0
  df1 = pivot_longer(df1, cols = c("CD11c", "CD3CD4p", "Unknown"), names_to = c("CellTypeZ"), values_to = toMeasure)
  
  # df1 = left_join(df1, dfWholeDen)
  # 
  # df1 = df1 %>%
  #   mutate(foldChange = cellDen/cellDenWhole)
  
  df1$distance = i
  
  n = n + 1 
  df1$interval = n
  dfMain = rbind(dfMain, df1)
  
  base = i
  
}

dfMain$distance = as.factor(dfMain$distance)
dfMain$interval = as.factor(dfMain$interval)

# Get LA and donorNos:
df1 = dfMain %>% 
  mutate(laIDUnique = paste0(paste0(blockID,"_"),ImageID)) %>%
  mutate(laIDUnique = paste0(paste0(laIDUnique,"_"),laID)) %>%
  mutate(laIDUnique = factor(laIDUnique, levels = unique(laIDUnique)))
length(unique(df1$DonorNo))
length(unique(df1$laIDUnique))

# dfMain2 = dfMain %>% dplyr::filter(hivDen != 0)

# dfMain2 = dfMain %>% drop_na(foldChange)

dfMain2 = dfMain
# 
# test1 = dfMain2 %>%
#   pivot_longer(cols = c("foldChange", "hivDen", "hivDenWhole"), names_to = c("measureType"), values_to = "values") %>%
#   dplyr::filter(measureType != "foldChange") %>%
#   group_by(interval) %>%
#   summarise(pVal = t.test(values ~ measureType, paired = TRUE, alternative = "two.sided")$p.value)

test2 = dfMain2 %>%
  group_by(interval, CellTypeZ) %>%
  summarise(mean = mean(cellProp), sd = sd(cellProp))

test = test2
# test = left_join(test1, test2)
# # 
# test = test %>%
#   mutate(sdLower = mean - sd) %>%
#   mutate(sdHigher = mean + sd)

# test$distance = as.numeric(as.character((test$distance)))
test$interval = as.numeric(as.character((test$interval)))

g = test %>%
  # dplyr::filter(CellTypeZ != "Unknown") %>%
  ggplot(aes(x = interval, y = mean, fill = CellTypeZ, colour = CellTypeZ)) +
  # geom_line(aes(colour = CellTypeZ), size = 1) +
  geom_smooth() +
  # geom_ribbon(aes(ymin = sdLower, ymax = sdHigher, fill = CellTypeZ), colour = "grey70", alpha = 0.4) +
  # geom_point(size = 4, alpha = 0.65) +
  # scale_color_gradient(low = "#e5f5e0", high = "#31a354")
  # geom_hline(yintercept = 0.0, linetype = "dashed", color = "black") +
  # ylim(c(0.5,2.5)) +
  # coord_cartesian(ylim = c(0.9,1.5)) +
  theme_minimal() +
  scale_colour_manual(values = c("#78C679", "#4292C6", "#02384f")) +
  scale_fill_manual(values = c("#78C679", "#4292C6", "#02384f")) +
  # scale_colour_manual(values = c("#67a9cf", "#ef8a62")) +
  # scale_fill_manual(values = c("#67a9cf", "#ef8a62")) +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.0,
                                       angle = 0,
                                       hjust = 0.5),    # Y axis text
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4)) 
g
              
ggsave("plot1.png", width = 10, height = 10, units = "cm", dpi = 300)



```

## SM ##


### Figure 4 - Is HIV  entry into submucosa correlated with HIV uptake by cells in the mucosal layer? (USED IN PAPER)

```{r eval = FALSE, echo = FALSE}

df = cellData %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  dplyr::filter(Compartments != "Undefined") %>%
  group_by(blockID, DonorNo, ImageID) %>%
  dplyr::filter(
           (sum(Compartments == "LP") > 0) &
           (sum(Compartments == "EP") > 0) &
           (sum(Compartments == "LA") > 0) &
           (sum(Compartments == "SM") > 0)) %>%
  mutate(Compartments = case_when(
    Compartments == "EP" ~ "mucosa",
    Compartments == "LP" ~ "mucosa",
    Compartments == "LA" ~ "mucosa",
    TRUE~as.character(Compartments))) %>%
  group_by(blockID, DonorNo, ImageID, Compartments) %>%
  mutate(sumArea = sum(NucArea)/(((3.07^2)*10^6))) %>%
  mutate(hivPos = sum(hivCount)) %>%
  mutate(hivDen = hivPos/sumArea) %>%
  summarise(hivDen = mean(hivDen))
  
df1 = df %>%
  group_by(blockID, DonorNo, ImageID, Compartments) %>%
  dplyr::filter(hivDen != 0) %>%
  mutate(hivDen = log10(hivDen)) %>%
  pivot_wider(names_from = Compartments, values_from = hivDen) %>%
  drop_na() %>%
  ungroup()
  # dplyr::filter(blockID != "COL83_hivBal_2")


cor.test(df1$SM, df1$mucosa, method = "pearson")

df1 %>%
  ggplot(aes(x = mucosa, y = SM)) + 
  geom_point(size = 5, alpha = 0.65, colour = "#666666") +
  geom_smooth(method = "lm", colour = "#666666") +
  theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.0,
                                       angle = 0,
                                       hjust = 0.5),    # Y axis text
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4)) 

ggsave("plot1.png", width = 10, height = 10, units = "cm", dpi = 300)

length(unique(df1$DonorNo))
length((df1$ImageID))



```


### Figure 4 - Is HIV particle entry into the SM due to passage through the LP or the LA? (USED IN PAPER)

```{r eval = FALSE, echo = FALSE}


df = cellData %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  dplyr::filter(Compartments != "Undefined") %>%
  group_by(blockID, DonorNo) %>%
  dplyr::filter(
           (sum(Compartments == "LP") > 0) &
           (sum(Compartments == "LA") > 0) &
           (sum(Compartments == "SM") > 0)) %>%
  dplyr::filter(Compartments != "EP") %>%
  group_by(blockID, DonorNo, ImageID) %>%
  mutate(imageTotalHIV = sum(hivCount)) %>%
  dplyr::filter(imageTotalHIV >= 100) %>%
  group_by(blockID, DonorNo, Compartments) %>%
  mutate(sumArea = sum(NucArea)/(((3.07^2)*10^6))) %>%
  mutate(hivPos = sum(hivCount)) %>%
  mutate(hivDen = hivPos/sumArea) %>%
  summarise(hivDen = mean(hivDen))
  
df1 = df %>%
  group_by(blockID, DonorNo, Compartments) %>%
  dplyr::filter(hivDen != 0) %>%
  mutate(hivDen = log10(hivDen)) %>%
  pivot_wider(names_from = Compartments, values_from = hivDen) %>%
  ungroup() %>%
  drop_na() 
  # dplyr::filter(blockID != "COL83_hivBal_2")


cor.test(df1$SM, df1$LP, method = "pearson")

df1 %>%
  ggplot(aes(x = LP, y = SM)) + 
  geom_point(size = 5, alpha = 0.65, colour = "#666666") +
  geom_smooth(method = "lm", colour = "#666666") +
  theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.0,
                                       angle = 0,
                                       hjust = 0.5),    # Y axis text
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4)) 

ggsave("plot1.png", width = 10, height = 10, units = "cm", dpi = 300)

df2 = df1

df2 = df2 %>%
  select(-c(blockID))

# M = cor(df2, use = "complete.obs", method = "spearman")
# 
# # matrix of the p-value of the correlation
# p.mat <- cor.mtest(df2)
# corrplot(M, type="upper", order="hclust", 
#          p.mat = p.mat, sig.level = 0.05, insig = "blank")
# 
# # corrplot(M, order = "hclust", method = "circle", type = "upper", col = myPalette(100))
# corrplot(M, method = "circle", type = "upper",  order="hclust")


# Plotting pairs plots
df2 = as.data.frame(scale(df2))
png("plot1.png", width =70, height =70, units = "cm", res = 300)
pairs(scale_df2, pch = 19, cex=2)
dev.off()


## Try linear regression (simple and with mutliple regression to compare effect of LP vs LA on SM HIV prediction)

smlp = lm(df2$SM ~ df2$LP)
smla = lm(df2$SM ~ df2$LA)
smlpla = lm(df2$SM ~ df2$LA + df2$LP)
lalp = lm(df2$LP ~ df2$LA)


summary(smlp)
summary(smla)
summary(smlpla)
summary(lalp)


plot(smlpla)

```

### Figure 4 - Do Submucosal Macs have a greater mean or percentage HIV+ vs their mucosal counterparts? (USED IN PAPER)
```{r eval = FALSE, echo = FALSE}


df = cellData %>% 
  dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  group_by(DonorNo) %>%
  dplyr::filter(
           (sum(Compartments == "LP") > 0) &
           (sum(Compartments == "SM") > 0) &
           (sum(Compartments == "EP") > 0)) %>%
  dplyr::filter(Compartments %in% c("LP", "SM")) %>%
  dplyr::filter(CellTypeZ == "FXIIIa") %>%
  dplyr::filter(hivDist <= 50*3.07) %>%
  group_by(DonorNo, Compartments) %>%
  add_count(name = "cellCount") %>%
  dplyr::filter(hivCount > 0) %>%
  add_count(name = "hivPosCellCount")

df$DonorNo = factor(df$DonorNo)
df$ImageID = factor(df$ImageID)
df$Compartments = factor(df$Compartments, levels = c("LP", "SM"))

df1 = df %>%
  dplyr::filter(hivPosCellCount >= 5) %>%
  mutate(hivMean = mean(hivCount)) %>%
  mutate(cd4Mean = mean(CD4)) %>%
  summarise(hivMean = mean(hivMean), cd4Mean = mean(cd4Mean)) %>%
  group_by(DonorNo) %>%
  dplyr::filter(
           (sum(Compartments == "LP") > 0) &
           (sum(Compartments == "SM") > 0)) %>%
  ungroup()
 

df2 = df %>%
  dplyr::filter(hivPosCellCount >= 10 %>%
  group_by(DonorNo) %>%
  dplyr::filter(
           (sum(Compartments == "SM") >0) &
           (sum(Compartments == "LP") >0)) %>%
  group_by(DonorNo, Compartments) %>%
  mutate(hivPerc = (hivPosCellCount/cellCount)*100) %>% 
  summarise(hivPerc = mean(hivPerc)) %>%
  ungroup()
  
# Ggplot for Compartments

df3 = left_join(df1, df2)

#Colours need to adjusted manually below. 
df3 %>%
  ggplot(aes(x = Compartments, y = hivPerc, fill = Compartments, colour = Compartments )) +
  geom_boxplot(position=position_dodge(0.90), width = 0.85, outlier.shape = NA, alpha = 0.65, lwd =1.5) +
  # geom_dotplot(position=position_dodge(0.85), binaxis='y', stackdir = "center", dotsize=0.65, show.legend = FALSE, alpha = 0.65, binwidth = 4/20) +
  scale_fill_manual(values = c("#FEB24C", "#FEB24C")) +
  # scale_colour_manual(values =c(wes_palette("Zissou1")[1], wes_palette("Zissou1")[1])) +
  scale_colour_manual(values =c(wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5])) +
  coord_cartesian(ylim = c(0,15)) +
  # coord_cartesian(ylim = c(1,2.5)) +
  scale_x_discrete(labels = c("LP ", "SM")) +
  # scale_y_continuous(breaks = c(1.0,1.5,2.0)) +
  theme_minimal_hgrid(12) + 
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.0,
                                       angle = 0,
                                       hjust = 0.5),    # Y axis text
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4)) 

# ggsave("plot1.png", width = 7, height = 14, units = "cm", dpi = 300)
ggsave("plot1.png", width = 4, height = 8, units = "cm", dpi = 300)


dfTest = df1 %>% 
  select(DonorNo, Compartments, cd4Mean) %>%
  pivot_wider(names_from = Compartments, values_from = cd4Mean) %>%
  drop_na()

wilcox.test(dfTest$LP, dfTest$SM, paired = TRUE)

# Get donorNo
length(unique(df3$DonorNo))


# Histogram of mac SM vs LP hivCount per donor. Comment out 'summarise' at the end of df pipe above in order to plot

ggplot(df, aes(x = hivCount)) + 
  facet_grid(Compartments~DonorNo, scales = "fixed", drop = T) +
  geom_histogram(aes(y=(..count..)/tapply(..count..,..PANEL..,sum)[..PANEL..]), bins = 15)

ggsave("plot.png", width = 40, height = 28, units = "cm", dpi = 300)


````

### Figure 5 - Do any target cells in each compartment migrate toward HIV in that compartment? (USED IN PAPER)

``` {r }

#### Wilcox Method Comparing to whole Tissue (This one used for Figure) ####



df = cellData %>% 
    dplyr::filter(batch == "new") %>%
    dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
    dplyr::filter(Compartments != "Undefined") %>%
    group_by(blockID, DonorNo, ImageID) %>%
    dplyr::filter(
               (sum(Compartments == "LP") > 0) &
               (sum(Compartments == "EP") > 0)) %>%
    dplyr::filter(Compartments == "LP") %>%
    # dplyr::filter(laIDHIVCount >= 2) %>%
    ungroup()

dfWholeDen = df %>%
    group_by(blockID, DonorNo, ImageID) %>%
    mutate(sumArea = sum(NucArea)/(((3.07^2)*10^6))) %>%
    group_by(blockID, DonorNo, ImageID, CellTypeZ) %>%
    add_count(name = "cellNumber") %>%
    mutate(cellDensityWhole = cellNumber/sumArea) %>%
    summarise(cellDensityWhole = mean(cellDensityWhole)) %>%
    ungroup() %>%
    dplyr::filter(CellTypeZ %in% c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n")) %>%
    mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n")))

# df = df1

sequence = seq(20, 400, by = 20)
vals = data.frame(sequence)
colnames(vals) = "Distance"
n = 0
interval = 20

# dataframe to store all measurements
dfMain = data.frame()

for(i in sequence) {
  
  df0 = df %>%  
    mutate(region = case_when(
    (lpHIVDist >= n*interval*3.07) & (lpHIVDist <= i*3.07) ~ "hivClose",
    # lpHIVDist <= i*3.07 ~ "hivClose",
    TRUE ~ as.character("toDelete"))) %>%
    dplyr::filter(region == "hivClose") %>%
    group_by(blockID, DonorNo, ImageID, region) %>%
    mutate(sumArea = sum(NucArea)/(((3.07^2)*10^6))) %>%
    group_by(blockID, DonorNo, ImageID, region, CellTypeZ) %>%
    add_count(name = "cellNumber") %>%
    mutate(cellDensity = cellNumber/sumArea) %>%
    summarise(cellDensity = mean(cellDensity)) %>%
    ungroup() %>%
    select(-region) %>%
    dplyr::filter(CellTypeZ %in% c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n")) %>%
    mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n")))
    
  toMeasure = "cellDensity"
  #Adding back in cell counts that are 0 (and so excluded from cellDensity measurements above)
  df1 = pivot_wider(df0, names_from = c("CellTypeZ"), values_from = toMeasure)
  df1[is.na(df1)] = 0
  df1 = pivot_longer(df1, cols = c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n"), names_to = c("CellTypeZ"), values_to = toMeasure)
  df1 = left_join(df1, dfWholeDen)
  
  df1 = df1 %>%
    mutate(foldChange = cellDensity/cellDensityWhole) 
  
  df1$distance = i
  dfMain = rbind(dfMain, df1)
  
  n = n + 1 

}

dfMain$distance = as.factor(dfMain$distance)
dfMain$CellTypeZ = factor(dfMain$CellTypeZ, levels = c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n"))

dfMain2 = dfMain %>% dplyr::filter(foldChange != 0)

test1 = dfMain2 %>%
  pivot_longer(cols = c("foldChange", "cellDensity", "cellDensityWhole"), names_to = c("measureType"), values_to = "values") %>%
  dplyr::filter(measureType != "foldChange") %>%
  group_by(CellTypeZ, distance) %>%
  summarise(pVal = wilcox.test(values ~ measureType, paired = TRUE, alternative = "two.sided")$p.value)

test2 = dfMain2 %>%
  group_by(CellTypeZ, distance) %>%
  summarise(mean = mean(foldChange), sd = sd(foldChange))

test = left_join(test1, test2)

test = test %>%
  mutate(sdLower = mean - sd) %>%
  mutate(sdHigher = mean + sd)

test$distance = as.numeric(as.character((test$distance)))

g3 = test %>%
  dplyr::filter(CellTypeZ == "FXIIIa" | CellTypeZ == "CD3CD4p") %>%
  ggplot(aes(x = distance, y = mean, fill = CellTypeZ, colour = CellTypeZ)) +
  geom_smooth() +
  # geom_point(size = 3, alpha = 0.4) +
  geom_hline(yintercept = 1.0, linetype = "dashed", color = "black") +
  theme_minimal() +
  # scale_colour_manual(values = c("#78C679", "#B3B3B3")) +
  # scale_fill_manual(values = c("#78C679", "#B3B3B3")) +
  # scale_colour_manual(values = c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3")) +
  # scale_fill_manual(values = c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3")) +
  scale_colour_manual(values = c("#FEB24C", "#4292C6")) +
  scale_fill_manual(values = c("#FEB24C", "#4292C6")) +
  # scale_colour_manual(values = c("#FEB24C", "#02384f")) +
  # scale_fill_manual(values = c("#FEB24C", "#02384f")) +
  theme(
          text = element_text(family = "Arial"),
          legend.position = "none",
                axis.title.x=element_blank(),
                axis.text.x=element_text(size = 18,
                                         face="plain",
                                         vjust= 0.0,
                                         angle = 0,
                                         hjust = 0.5),    # Y axis text
                axis.title.y=element_blank(),
                axis.text.y=element_text(size = 18,
                                         face="plain",
                                         vjust= 0.4)) 

g3
  
ggsave("plot1.png", width = 10, height = 10, units = "cm", dpi = 300)

## Make heatmap column of p values to overlap on the fold-change vs distance plots

#using ggplot

data = test
data$pVal = -log10(data$pVal)
data$distance = as.factor(data$distance)
data$CellTypeZ = as.factor(data$CellTypeZ)

#Define a cool colour palette I found here: https://www.r-bloggers.com/simplest-possible-heatmap-with-ggplot2/
myPalette <- colorRampPalette(rev(brewer.pal(11, "Spectral")), space="Lab")

pScale = data %>%
  ungroup() %>%
  summarise(maxP = max(pVal), minP = min(pVal))

data %>%
  dplyr::filter(CellTypeZ == "FXIIIa") %>%
  ggplot(aes(x = distance, y = 1, fill = pVal)) +
  geom_tile(aes(fill = pVal)) + 
  scale_fill_gradientn(colors = myPalette(100),
                       limits = c(pScale$minP, pScale$maxP),
                        values=scales::rescale(c(pScale$minP,-log10(0.01), pScale$maxP))) +
  theme_classic() +
  theme(
    # legend.position = "none",
    plot.title=element_blank(), # title
          axis.title = element_blank(),
          axis.text=element_blank(),  
          legend.title = element_text(size = 18),
          legend.text = element_text(size =18),  
          axis.ticks = element_blank(),    
          strip.text.x = element_blank(),
          axis.line=element_blank(),
          panel.spacing = unit(0.3, "lines"))

#For Graph
ggsave("plot1.png", width = 10, height = 2.0, units = "cm", dpi = 300)
# For Legend
ggsave("plot1.png", width = 10, height = 8, units = "cm", dpi = 300)

  
```

### Figure 5 - 1. Are DCs migrating toward HIV+ EP? 2. Are macrophages and CD4 T cells moving away from the EP as HIV enters the mucosa - Pseudotime analysis. (USED IN PAPER FOR FIGURE S6B and FIGURE 5B)

```{r eval = FALSE, echo = FALSE}

# This quesiton is answered using two similar methods. 
# 1. Simply taking HIV+ and HIV- EP and the LP cells nearby. 
# 2. Specifically selecting windows that have HIV+ EP with low amounts of virus in LP to control for LP HIV levels influence on cell localisation.
# The code to execute method 2 is the same as method 1. However the chunk of code at the top of this chunk is run first to find appropriate windows. The windows are then filtered for when running code for method 1. 

# HOW TO USE THIS CHUNK FOR FIGURES 5 and 6 (READ ME):

# How to use for FIGURE 5B (assessing if DCs migrating into HIV+ EP):
# Run the code for EP > LP. Only plot DCs and CD4n T cells. 

# How to use for FIGURE S6B (pseudotime mac migration away from HIV+ EP):
# Run the code three times with diferent input paramteres. Once for when HIV in EP > LP (using winkeep below) and again for EP < LP. Also run for winkeep as EP==0 and LP==0 which is for HIV- windows. The actual code you need to run is further down and is the fold-change between EPClose and EPFar. 


# Get winCoords that fit criteria. Then feed into Method 1 above with a filter command. 
df = cellData %>%
  dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  group_by(blockID, DonorNo, ImageID) %>%
  dplyr::filter(Compartments == "EP" | Compartments == "LP") %>%
  group_by(blockID, DonorNo, ImageID, winCoord, Compartments) %>%
  mutate(hivSum = sum(hivCount)) %>%
  mutate(sumArea = sum(NucArea)/((3.07^2)*(10^6))) %>%
  group_by(Condition, DonorNo, ImageID, winCoord) %>%
  dplyr::filter(
           (sum((Compartments == "LP") & (sumArea > 0.001)) > 0) &
           (sum((Compartments == "EP") & (sumArea > 0.0005)) > 0)) %>%
  group_by(Condition, DonorNo, ImageID, winCoord, Compartments) %>%
  summarise(hivSum = mean(hivSum)) %>%
  ungroup() %>%
  mutate(uniqueWin = paste0(paste0(ImageID, "_"), winCoord))

df1 = df %>%
  pivot_wider(names_from = Compartments, values_from = hivSum) %>%
  dplyr::filter(EP > LP)
  # dplyr::filter(EP==0 & LP==0)

# df1=df
winKeep = unique(df1$uniqueWin)

# Check HIV levels in EP vs LP windows. 
# df %>%
#   ggplot(aes(x = EP, y = LP)) +
#   geom_point() +
#   facet_wrap(~DonorNo, scales = "free")


## Method 1

# Note that the distance from epithelium values for EPHIVStatus were originally set to 13um as this is the distance at which 50% of the LP cells are located
# This value has been tweeked so that we can measure a closer distance to the EP. Like 5um. 

df = cellData %>% 
  dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  group_by(blockID, DonorNo, ImageID) %>%
  dplyr::filter(sum(Compartments == "EP" & CellTypeZ == "Unknown" & hivCount > 0) > 10) %>%
  dplyr::filter(Compartments == "LP") %>%
  # mutate(hivStatus = case_when(
  #   hivCount > 0 ~ "HIVPos",
  #   hivCount == 0 ~ "HIVNeg",
  #   TRUE~as.character("toDelete"))) %>%
  # dplyr::filter(hivStatus != "toDelete") %>%
  # mutate(hivStatus = factor(hivStatus, levels = c("HIVNeg", "HIVPos"))) %>%
  mutate(uniqueWin = paste0(paste0(ImageID, "_"), winCoord)) %>%
  mutate(EPHIVStatus = case_when(
    # epHIVDist <= 5*3.07 ~ "EPHIVClose",
    epHIVDist <= 10*3.07 & (uniqueWin %in% winKeep) ~ "EPHIVClose",
    EPDist <= 10*3.07 & epHIVDist > 50*3.07 ~ "EPHIVFar",
    # EPDist > 10*3.07 & EPDist <= 50*3.07 & (uniqueWin %in% winKeep) ~ "EPHIVFar",
    TRUE~as.character("toDelete"))) %>%
  dplyr::filter(EPHIVStatus != "toDelete") %>%
  mutate(EPHIVStatus = factor(EPHIVStatus, levels = c("EPHIVFar", "EPHIVClose"))) %>%
  group_by(blockID, DonorNo, ImageID, EPHIVStatus) %>%
  mutate(sumArea = sum(NucArea)/(((3.07^2)*10^6))) %>%
  # add_count(name = "totalCellCount") %>%
  group_by(blockID, DonorNo, ImageID, EPHIVStatus, CellTypeZ) %>%
  add_count(name = "cellTypeCount") %>%
  # mutate(cellPerc = (cellTypeCount/cellTypeCount)*100) %>%
  dplyr::filter(cellTypeCount >= 1) %>%
  mutate(cellDen = cellTypeCount/sumArea) %>%
  dplyr::filter(CellTypeZ %in% c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n")) %>%
  mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n"))) %>%
  summarise(cellDen = mean(cellDen), cellTypeCount = mean(cellTypeCount), sumArea = mean(sumArea)) %>%
  ungroup()

# Because doing density need to include 0 values for target cells (at least for the LAClose vs Far comparison for either HIV+ or HIV- cells)
# For now don't do this because it drastically skews the results.
# 
# df1 = df %>%
#   pivot_wider(names_from = c(EPHIVStatus, CellTypeZ), values_from = cellDen)
# 
# df1[is.na(df1)] = 0
# 
# df1 = df1 %>%
#   pivot_longer(cols =c(EPHIVFar_CD11c:EPHIVClose_Unknown), names_to = c("EPHIVStatus", "CellTypeZ"), names_sep = "_", values_to = "cellDen")

#plotting
 
df %>%
  group_by(blockID, DonorNo, ImageID) %>%
  dplyr::filter(
    (sum(EPHIVStatus == "EPHIVClose") > 0) &
    (sum(EPHIVStatus == "EPHIVFar") > 0)) %>%
  dplyr::filter(CellTypeZ %in% c("CD11c", "CD3CD4n")) %>%
    # mutate(EPHIVStatus = factor(EPHIVStatus, levels = c("EPHIVClose", "EPHIVFar"))) %>%
  ggplot(aes(x = CellTypeZ, y = cellDen, fill = interaction(CellTypeZ, EPHIVStatus), colour = interaction(CellTypeZ, EPHIVStatus)))  +
  geom_boxplot(position=position_dodge(0.90), width = 0.8, alpha = 0.65, lwd = 1.25, outlier.shape = NA) +
 #  scale_fill_manual(values = c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3", "#78C679", "#FEB24C", "#4292C6", "#B3B3B3")) +
 #    scale_colour_manual(values =c(wes_palette("Zissou1")[1], wes_palette("Zissou1")[1], wes_palette("Zissou1")[1], wes_palette("Zissou1")[1],wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5]))+
 # scale_x_discrete(labels = c("DC", "Mac", "CD4+ TC", "CD4- TC")) +
   # coord_cartesian(ylim = c(0,2500)) +
  scale_fill_manual(values = c("#78C679", "#B3B3B3", "#78C679", "#B3B3B3")) +
  scale_colour_manual(values =c(wes_palette("Zissou1")[1],  wes_palette("Zissou1")[1], wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5]))+
  scale_x_discrete(labels = c("DC", "CD4- TC")) +
   coord_cartesian(ylim = c(0,1500)) +

  theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 14,
                                       face="plain",
                                       vjust= -2.0,
                                       angle = 0,
                                       hjust = 0.55),
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4),
              plot.margin = unit(c(1,1,1,1), "cm"))

ggsave("plot1.png", width = 14, height = 10, units = "cm", dpi = 300)


dfTest = df %>%
  dplyr::filter(CellTypeZ == "CD3CD4p") %>%
  select(-c(cellTypeCount, sumArea)) %>%
  pivot_wider(names_from = EPHIVStatus, values_from = cellDen)

wilcox.test(dfTest$EPHIVClose, dfTest$EPHIVFar, paired = TRUE)


## Graphing the fold increase in density for  target cells in EPClose vs EPFar regions for HIV+ vs HIV- EP

df = cellData %>% 
  dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  group_by(blockID, DonorNo, Image) %>%
  dplyr::filter(sum(Compartments == "EP" & CellTypeZ == "Unknown" & hivCount > 0) > 10) %>%
  dplyr::filter(Compartments == "LP") %>%
  # mutate(hivStatus = case_when(
  #   hivCount > 0 ~ "HIVPos",
  #   hivCount == 0 ~ "HIVNeg",
  #   TRUE~as.character("toDelete"))) %>%
  # dplyr::filter(hivStatus != "toDelete") %>%
  # mutate(hivStatus = factor(hivStatus, levels = c("HIVNeg", "HIVPos"))) %>%
  mutate(uniqueWin = paste0(paste0(ImageID, "_"), winCoord)) %>%
  mutate(EPHIVStatus = case_when(
    epHIVDist <= 10*3.07 & (uniqueWin %in% winKeep) ~ "EPHIVPosClose",
    epHIVDist > 10*3.07 & epHIVDist <= 50*3.07 & (uniqueWin %in% winKeep) ~ "EPHIVPosFar",
    EPDist <= 10*3.07 & epHIVDist > 50*3.07 ~ "EPHIVNegClose",
    EPDist > 10*3.07 &  EPDist <= 50*3.07 & epHIVDist > 50*3.07 ~ "EPHIVNegFar",
    TRUE~as.character("toDelete"))) %>%
  dplyr::filter(EPHIVStatus != "toDelete") %>%
  # mutate(EPHIVStatus = factor(EPHIVStatus, levels = c("EPHIVFar", "EPHIVClose"))) %>%
  group_by(blockID, DonorNo, Image, EPHIVStatus) %>%
  mutate(sumArea = sum(NucArea)/(((3.07^2)*10^6))) %>%
  # add_count(name = "totalCellCount") %>%
  group_by(blockID, DonorNo, Image, EPHIVStatus, CellTypeZ) %>%
  add_count(name = "cellTypeCount") %>%
  mutate(cellDen = cellTypeCount/sumArea) %>%
  dplyr::filter(CellTypeZ %in% c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n")) %>%
  mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n"))) %>%
  summarise(cellDen = mean(cellDen), cellTypeCount = mean(cellTypeCount), sumArea = mean(sumArea)) %>%
  ungroup()

# Because doing density need to include 0 values for target cells (at least for the LAClose vs Far comparison for either HIV+ or HIV- cells)
# For now don't do this because it drastically skews the results.
# 
# df1 = df %>%
#   pivot_wider(names_from = c(EPHIVStatus, CellTypeZ), values_from = cellDen)
# 
# df1[is.na(df1)] = 0
# 
# df1 = df1 %>%
#   pivot_longer(cols =c(EPHIVNegClose_CD11c:EPHIVPosFar_Unknown), names_to = c("EPHIVStatus", "CellTypeZ"), names_sep = "_", values_to = "cellDen")

dfFold = df %>%
  select(-c(cellTypeCount, sumArea)) %>%
  pivot_wider(names_from = c(EPHIVStatus), values_from = cellDen)

dfFold = dfFold %>%
  mutate(hivPosFold = log2(EPHIVPosClose/EPHIVPosFar)) %>%
  mutate(hivNegFold = log2(EPHIVNegClose/EPHIVNegFar)) %>%
  select(c(DonorNo, Image, CellTypeZ, hivPosFold, hivNegFold)) %>%
  pivot_longer(cols = c(hivPosFold:hivNegFold), names_to = "hivStatus", values_to = "foldIncrease") %>%
  group_by(DonorNo, Image, CellTypeZ) %>%
  drop_na(foldIncrease) %>%
  dplyr::filter(
    (sum(hivStatus == "hivPosFold") > 0) &
    (sum(hivStatus == "hivNegFold") > 0))

dfFold %>%
  ggplot(aes(x = CellTypeZ, y = foldIncrease, fill = interaction(CellTypeZ, hivStatus), colour = interaction(CellTypeZ, hivStatus)))  +
  geom_boxplot(position=position_dodge(0.90), width = 0.8, alpha = 0.65, lwd = 1.25, outlier.shape = NA) +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color = "black", size = 1.0) +
 scale_fill_manual(values = c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3", "#78C679", "#FEB24C", "#4292C6", "#B3B3B3")) +
   scale_colour_manual(values =c(wes_palette("Zissou1")[1], wes_palette("Zissou1")[1], wes_palette("Zissou1")[1], wes_palette("Zissou1")[1],wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5])) +
 scale_x_discrete(labels = c("DC", "Mac", "CD4+ TC", "CD4- TC")) +
 coord_cartesian(ylim = c(-2.5,1.5)) +
  theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 14,
                                       face="plain",
                                       vjust= -2.0,
                                       angle = 0,
                                       hjust = 0.55),
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4),
              plot.margin = unit(c(1,1,1,1), "cm"))


ggsave("plot1.png", width = 14, height = 10, units = "cm", dpi = 300)

dfTest = dfFold %>%
  dplyr::filter(CellTypeZ == "CD3CD4p") %>%
  pivot_wider(names_from = hivStatus, values_from = foldIncrease)

wilcox.test(dfTest$hivPosFold, dfTest$hivNegFold, paired = TRUE)

  
# Below is a modified version of the fold change measurements. It is for HIV- windows only which requires only 4 boxplots and not 8 as the above version.



df = cellData %>% 
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  group_by(blockID, DonorNo, Image) %>%
  dplyr::filter(sum(Compartments == "EP" & CellTypeZ == "Unknown" & hivCount > 0) > 10) %>%
  dplyr::filter(Compartments == "LP") %>%
  mutate(uniqueWin = paste0(paste0(ImageID, "_"), winCoord)) %>%
  mutate(EPStatus = case_when(
    EPDist <= 10*3.07 & (uniqueWin %in% winKeep) ~ "EPClose",
    EPDist > 10*3.07 & EPDist <= 50*3.07 & (uniqueWin %in% winKeep) ~ "EPFar",
    TRUE~as.character("toDelete"))) %>%
  dplyr::filter(EPStatus != "toDelete") %>%
  mutate(EPStatus = factor(EPStatus, levels = c("EPClose", "EPFar"))) %>%
  group_by(blockID, DonorNo, Image, EPStatus) %>%
  mutate(sumArea = sum(NucArea)/(((3.07^2)*10^6))) %>%
  group_by(blockID, DonorNo, Image, EPStatus, CellTypeZ) %>%
  add_count(name = "cellTypeCount") %>%
  mutate(cellDen = cellTypeCount/sumArea) %>%
  dplyr::filter(CellTypeZ %in% c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n")) %>%
  mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n"))) %>%
  summarise(cellDen = mean(cellDen), cellTypeCount = mean(cellTypeCount), sumArea = mean(sumArea)) %>%
  ungroup()

dfFold = df %>%
  select(-c(cellTypeCount, sumArea)) %>%
  pivot_wider(names_from = c(EPStatus), values_from = cellDen) %>%
  mutate(fold = log2(EPClose/EPFar)) %>%
  select(c(DonorNo, Image, CellTypeZ, fold))

dfFold %>%
  ggplot(aes(x = CellTypeZ, y = fold, fill = CellTypeZ))  +
  geom_boxplot(position=position_dodge(0.90), width = 0.8, alpha = 0.65, lwd = 1.25, outlier.shape = NA) +
  geom_hline(aes(yintercept = 0), linetype = "dashed", color = "black", size = 1.0) +
 scale_fill_manual(values = c("#78C679", "#FEB24C", "#4292C6", "#B3B3B3")) +
 scale_x_discrete(labels = c("DC", "Mac", "CD4+ TC", "CD4- TC")) +
 coord_cartesian(ylim = c(-2.5,1.5)) +
  theme_classic() +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 14,
                                       face="plain",
                                       vjust= -2.0,
                                       angle = 0,
                                       hjust = 0.55),
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4),
              plot.margin = unit(c(1,1,1,1), "cm"))


ggsave("plot1.png", width = 14, height = 10, units = "cm", dpi = 300)

dfTest = dfFold
dfTest$baseline = 0

dfTest = dfTest %>%
  dplyr::filter(CellTypeZ == "CD3CD4n")

wilcox.test(dfTest$fold, dfTest$baseline, paired = TRUE)



```

### Figure 5 -  Are DCs enriched in HIV+ EP? (USED IN PAPER)
```{r eval = FALSE, echo = FALSE}


## code below calculates either the density of DCs in HIV+ vs HIV- epi, or their proportion within the HIV+ vs HIV- epi.

df = cellData %>%
   dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  dplyr::filter(Compartments == "EP") %>%
  mutate(hivStatus = case_when(
    (hivCount > 0)  ~ "HIV+",
    (hivCount == 0)  ~ "HIV-",
    TRUE ~ as.character(CellTypeZ))) %>%
  group_by(DonorNo, ImageID, hivStatus) %>%
  add_count(name = "compCellCount") %>%
  mutate(sumArea = sum(NucArea)/((3.07^2)*1000)) %>%
  group_by(DonorNo, ImageID,  hivStatus, CellTypeZ) %>%
  add_count(name = "cellCount") %>%
  mutate(cellDen = cellCount/sumArea) %>%
  mutate(cellPerc = (cellCount/compCellCount)*100) %>%
  summarise(cellDen = mean(cellDen), cellPerc = mean(cellPerc), sumArea = mean(sumArea), compCellCount = mean(compCellCount)) %>%
  ungroup()


df %>% 
  dplyr::filter(CellTypeZ == "CD11c") %>%
  ggplot(aes(x = hivStatus, y = cellPerc, fill = hivStatus)) +
    geom_boxplot(position=position_dodge(0.90), width = 0.85, outlier.shape = NA, alpha = 0.65, lwd = 1.5) +
    # scale_fill_manual(values = c( "#78C679", "#78C679")) +
    scale_fill_manual(values = c( "#B3B3B3", "#B3B3B3")) +
    coord_cartesian(ylim = c(0,10)) +
    theme_minimal_hgrid(12) + 
    theme(plot.title=element_blank(),
            legend.position = "none",
            axis.title.x=element_text(vjust= -6,
                                      size=15), # X axis title
            axis.title.y=element_text(vjust = 6,
                                    size=15),
            axis.text.x=element_text(size = 18,
                                     face="bold",
                                     vjust= -3,  # X axis text
                                     hjust = 0.5),
            axis.text.y=element_text(size = 14,
                                     face="bold",
                                     vjust= 0.4,
                                     hjust = 0),   # Y axis text
            axis.line.x = element_blank(),
            plot.margin = unit(c(1,1,1,1), "cm"))    # Y axis title



ggsave("plot.png", width = 9, height = 9, units = "cm", dpi = 300)

dfTest = df %>%
  dplyr::filter(CellTypeZ == "CD3CD4n") %>%
  select(-c(sumArea, compCellCount, cellDen)) %>%
  pivot_wider(names_from = "hivStatus", values_from = "cellPerc")


dfTest = drop_na(dfTest)
cox = wilcox.test(dfTest$`HIV-`, dfTest$`HIV+`, paired = TRUE)
cox$p.value




```

### Figure 5 - 1. Is the increase in HIV+ target cell density near LAs specfic to HIV+ LAs? 2. Does the proportion of target cells that are HIV+ increase moving toward LAs? (USED IN PAPER)

```{r eval = FALSE, echo = FALSE}


#### Wilcox Method Comparing to whole Tissue (This one used for Figure) ####

# df and dfWholeDen are changed so as to measure hivBal, mock or 'all cells' or 'HIV+ cells only'. 
# This is sometimes accompanied by change in the loop as well, such as changing the measured parameter.

df = cellData %>% 
    dplyr::filter(batch == "new") %>%
    dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
    dplyr::filter(Compartments != "Undefined") %>%
    group_by(blockID, DonorNo, ImageID) %>%
    dplyr::filter(
               (sum(Compartments == "LP") > 0) &
               (sum(Compartments == "LA") > 0)) %>%
    dplyr::filter(Compartments == "LP") %>%
    mutate(laHIVStatus = case_when(
      laIDHIVCount >= 2 ~ "hivPosLA",
      laIDHIVCount < 2 ~ "hivNegLA",
      TRUE~as.character("toDelete"))) %>% 
    dplyr::filter(laHIVStatus != "toDelete") %>%
      # mutate(CellTypeZ = case_when(
      #   CellTypeZ == "CD3" ~ "CD3CD4p",
      #   CellTypeZ == "CD3CD4n" ~ "CD3CD4p",
      #   TRUE~as.character(CellTypeZ))) %>%
      # mutate(laHIVStatus = case_when(
      #   laIDHIVCount <= 18 ~ "hivLowLA",
      #   laIDHIVCount > 18 & laIDHIVCount <86 ~ "hivMidLA",
      #   laIDHIVCount > 86 ~ "hivHighLA",
      #   TRUE~as.character("toDelete"))) %>%
      # dplyr::filter(laHIVStatus != "toDelete") %>%
      # mutate(laHIVStatus = case_when(
      #   laIDHIVCount <= 16 ~ "hivLowLA",
      #   laIDHIVCount >= 17 & laIDHIVCount <=82 ~ "hivMidLA",
      #   laIDHIVCount >= 83 ~ "hivHighLA",
      #   TRUE~as.character("toDelete"))) %>%
      #   dplyr::filter(laHIVStatus != "toDelete") %>%
       # mutate(laHIVStatus = case_when(
       #  laIDHIVCount <= 2 ~ "hivNegLA",
       #  laIDHIVCount > 2 & laIDHIVCount <=19 ~ "hivLowLA",
       #  laIDHIVCount > 19 ~ "hivHighLA",
       #  TRUE~as.character("toDelete"))) %>%
       #  dplyr::filter(laHIVStatus != "toDelete") %>%
        ungroup()


# Start Filtering LA Prox for HIV densities (Not run for main figure)

# NOTE: This is for making sure LAClose and LAFar regions have only 10% max difference in HIV density. I wanted to select
# for HIV+ LAs that didn't have LAProx hiv enrichment so that I could determine whether DCs are migrating towrad HIV+ LAs or the HIV that may tend to 
# be enriched near the HIV+ LA.
df = df %>%
    mutate(LAProx = case_when(
      laMinDist <= 100*3.07 ~ "laClose",
      laMinDist > 100*3.07 & laMinDist <= 200*3.07 ~ "laFar",
      TRUE~as.character("laFarFar"))) %>%
    mutate(LAProx = factor(LAProx, levels = c("laClose", "laFar", "laFarFar"))) %>%
    group_by(blockID, DonorNo, ImageID, laID) %>%
    dplyr::filter((sum(LAProx == "laClose") > 0) & (sum(LAProx =="laFar") > 0)) %>%
    group_by(blockID, DonorNo, ImageID, laID, LAProx) %>%
    mutate(LPRegion_Area = sum(NucArea)/(((3.07^2)*10^6))) %>%
    mutate(LPRegion_hivCellCount = sum(hivCount > 0)) %>%
    mutate(LPRegion_hivCellDen = LPRegion_hivCellCount/LPRegion_Area) %>% 
    mutate(LAClose_hivDen = case_when (
    LAProx == "laClose" ~ LPRegion_hivCellDen,
    TRUE~NA_real_)) %>%
    mutate(LAFar_hivDen = case_when (
    LAProx == "laFar" ~ LPRegion_hivCellDen,
    TRUE~NA_real_)) %>%
    group_by(blockID, DonorNo, ImageID, laID) %>%
    mutate(LAClose_hivDen = mean(LAClose_hivDen, na.rm = TRUE)) %>%
    mutate(LAFar_hivDen = mean(LAFar_hivDen, na.rm = TRUE)) %>%
    mutate(laIDUnique = paste0(paste0(ImageID,"_"),laID))

# Choose to keep LAs where the density of HIV+ cells is lower in the LAClose region compared to the Far (this is supposed to be used for Figure S5A)
a = df %>%  
  group_by(blockID, DonorNo, ImageID, LAProx, laIDUnique) %>%
  slice_head(n=1) %>%
  select(laIDUnique, LAProx, LPRegion_hivCellDen, LAClose_hivDen, LAFar_hivDen) %>%
  dplyr::filter(LAClose_hivDen < LAFar_hivDen)

df = df %>%
  dplyr::filter(laIDUnique %in% unique(a$laIDUnique))

# End 
  

dfWholeDen = df %>%
    group_by(blockID, DonorNo, ImageID, laHIVStatus) %>%
    mutate(sumArea = sum(NucArea)/(((3.07^2)*10^6))) %>%
    group_by(blockID, DonorNo, ImageID, laHIVStatus, CellTypeZ) %>%
    # dplyr::filter(hivCount > 0) %>%
    add_count(name = "cellNumber") %>%
    mutate(cellDensityWhole = cellNumber/sumArea) %>%
    summarise(cellDensityWhole = mean(cellDensityWhole)) %>%
    ungroup() %>%
    dplyr::filter(CellTypeZ %in% c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n")) %>%
    mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n")))

sequence = seq(50,800, by = 50)
vals = data.frame(sequence)
colnames(vals) = "Distance"
n = 0
interval = 50

# dataframe to store all measurements
dfMain = data.frame()

for(i in sequence) {
  
  df0 = df %>%  
    group_by(blockID, DonorNo, ImageID, laHIVStatus) %>%
    dplyr::filter((laMinDist >= n*interval*3.07) & (laMinDist <= i*3.07)) %>%
    mutate(sumArea = sum(NucArea)/(((3.07^2)*10^6))) %>%
    # add_count(name = "totalCellNumber") %>%
    group_by(blockID, DonorNo, ImageID, laHIVStatus, CellTypeZ) %>%
    # dplyr::filter(hivCount > 0) %>%
    add_count(name = "cellNumber") %>%
    # dplyr::filter(cellNumber >= 10) %>%
    # dplyr::filter(hivCount > 0) %>%
    # add_count(name = "hivPosCellNumber") %>%
    mutate(cellDensity = cellNumber/sumArea) %>%
    # mutate(hivCellProp = (hivPosCellNumber/cellNumber)*100) %>%
    summarise(cellDensity = mean(cellDensity)) %>%
    # summarise(hivCellProp = mean(hivCellProp)) %>%
    ungroup() %>%
    dplyr::filter(CellTypeZ %in% c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n")) %>%
    mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n")))
  
   
  toMeasure = "cellDensity"
  #Adding back in cell counts that are 0 (and so excluded from cellDensity measurements above).
  df1 = pivot_wider(df0, names_from = c("CellTypeZ"), values_from = toMeasure)
  df1[is.na(df1)] = 0
  df1 = pivot_longer(df1, cols = c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n"), names_to = c("CellTypeZ"), values_to = toMeasure)
  df1 = left_join(df1, dfWholeDen)
  df1 = df1 %>%
    mutate(foldChange = cellDensity/cellDensityWhole)
  df1$distance = i
  dfMain = rbind(dfMain, df1)
   n = n + 1
  
  # run this part for the hivCellProp measurements. You can't use pivot_wider as above because the many NA values introduced by the cellNumber >=10 condition
  # will result in tonnes of zero values which falsely smooth the curve you're looking at.
  
  # df0$distance = i
  # dfMain = rbind(dfMain, df0)
  #  n = n + 1

}

## This section is for plotting foldChange and associated statistical testing ####

dfMain$distance = as.factor(dfMain$distance)
dfMain$CellTypeZ = factor(dfMain$CellTypeZ, levels = c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n"))
# dfMain$laHIVStatus = factor(dfMain$laHIVStatus, levels = c("hivNegLA", "hivLowLA", "hivHighLA"))

dfMain2 = dfMain %>% dplyr::filter(foldChange != 0)

# Getting comparison of each Cell TypeZ density in each interval to the image average denstiy.
test1 = dfMain2 %>%
  pivot_longer(cols = c("foldChange", "cellDensity", "cellDensityWhole"), names_to = c("measureType"), values_to = "values") %>%
  # dplyr::filter(laHIVStatus != "hivHighLA") %>%
  dplyr::filter(measureType != "foldChange") %>%
  group_by(laHIVStatus, CellTypeZ, distance) %>%
  summarise(pVal = t.test(values ~ measureType, paired = TRUE, alternative = "two.sided")$p.value)

# Getting comparison of HIV+ vs HIV- LA foldchange for each image
test2 = dfMain2 %>%
  group_by(ImageID, distance, CellTypeZ) %>%
  dplyr::filter(
    (sum(laHIVStatus == "hivPosLA") > 0) &
    (sum(laHIVStatus == "hivNegLA") > 0)) %>%
  # dplyr::filter(laHIVStatus != "hivHighLA") %>%
  select(-c(cellDensity, cellDensityWhole)) %>%
  group_by(CellTypeZ, distance) %>%
  mutate(foldChange = log2(foldChange)) %>%
  summarise(pValComp = t.test(foldChange ~ laHIVStatus, paired = TRUE, alternative = "two.sided")$p.value)

  
test3 = dfMain2 %>%
  group_by(laHIVStatus, CellTypeZ, distance) %>%
  summarise(mean = mean(foldChange), sd = sd(foldChange))

test = left_join(test1, test2)
test = left_join(test, test3)

test = test %>%
  mutate(sdLower = mean - sd) %>%
  mutate(sdHigher = mean + sd)

test$distance = as.numeric(as.character((test$distance)))

# Graphing foldChange vs distance from LAs
test %>%
  dplyr::filter(CellTypeZ == "FXIIIa") %>%
  ggplot(aes(x = distance, y = mean, fill = laHIVStatus, colour = laHIVStatus)) +
  geom_smooth() +
  # geom_point(size = 3, alpha = 0.4) +
  geom_hline(yintercept = 1.0, linetype = "dashed", color = "black") +
  theme_minimal() +
  scale_colour_manual(values = c("#67a9cf", "#ef8a62")) +
  scale_fill_manual(values = c("#67a9cf", "#ef8a62")) +
  # scale_colour_manual(values = c("#67a9cf", "#67cf8d", "#ef8a62")) +
  # scale_fill_manual(values = c("#67a9cf","#67cf8d","#ef8a62")) +
  # coord_cartesian(ylim = c(0.75,1.90)) +
  coord_cartesian(ylim = c(0.75,2.15)) +
  # coord_cartesian(ylim = c(0,230)) +
  theme( 
          text = element_text(family = "Arial"),
          legend.position = "none",
                axis.title.x=element_blank(),
                axis.text.x=element_text(size = 18,
                                         face="plain",
                                         vjust= 0.0,
                                         angle = 0,
                                         hjust = 0.5),    # Y axis text
                axis.title.y=element_blank(),
                axis.text.y=element_text(size = 18,
                                         face="plain",
                                         vjust= 0.4)) 

  
ggsave("plot3.png", width = 10, height = 10, units = "cm", dpi = 300)

## Plotting P values for comparison to image average density and comparison between HIV+ and HIV- LA densities

data = test
data$pVal = -log10(data$pVal)
data$pValComp = -log10(data$pValComp)
data$distance = as.factor(data$distance)
data$CellTypeZ = as.factor(data$CellTypeZ)

#Define a cool colour palette I found here: https://www.r-bloggers.com/simplest-possible-heatmap-with-ggplot2/
myPalette <- colorRampPalette(rev(brewer.pal(11, "Spectral")), space="Lab")

pScale = data %>%
  ungroup() %>%
  summarise(maxP = max(pVal), minP = min(pVal), maxPComp = max(pValComp), minPComp = min(pValComp))

data %>%
  dplyr::filter(laHIVStatus == "hivPosLA") %>%
  dplyr::filter(CellTypeZ == "CD3CD4p") %>%
  ggplot(aes(x = distance, y = 1, fill = pValComp)) +
  geom_tile(aes(fill = pValComp)) + 
  scale_fill_gradientn(colors = myPalette(100),
                       limits = c(pScale$minPComp, pScale$maxPComp),
                        values=scales::rescale(c(min(data$pValComp),-log10(0.05), max(data$pValComp)))) +
  theme_classic() +
  theme(
    # legend.position = "none",
    plot.title=element_blank(), # title
          axis.title = element_blank(),
          axis.text=element_blank(),  
          legend.title = element_text(size = 18),
          legend.text = element_text(size =18),  
          axis.ticks = element_blank(),    
          strip.text.x = element_blank(),
          axis.line=element_blank(),
          panel.spacing = unit(0.3, "lines"))

#For Graph
ggsave("plot1.png", width = 10, height = 2.0, units = "cm", dpi = 300)
# For Legend
ggsave("plot1.png", width = 10, height = 8, units = "cm", dpi = 300)




## This section is for plotting the proportion of cells that are HIV+ with distance from LAs ####


dfMain$distance = as.factor(dfMain$distance)
dfMain$CellTypeZ = factor(dfMain$CellTypeZ, levels = c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n"))

test = dfMain %>%
dplyr::filter(ImageID %in% unique(b$ImageID)) %>%
  dplyr::filter(laHIVStatus == "hivPosLA") %>%
  group_by(CellTypeZ, distance) %>%
  summarise(hivCellProp = mean(hivCellProp)) %>%
  dplyr::filter(CellTypeZ == "CD3CD4p") %>%
  mutate(distance = as.numeric(as.character(distance))) 

ggplot(test, aes(x = distance, y = hivCellProp, fill = CellTypeZ, colour = CellTypeZ)) +
  geom_bar(stat = "identity", position = "stack", alpha = 0.65, colour = NA) +
  geom_point(data=subset(test, distance < 150), size= 3, alpha = 0.65, colour = "red") + 
  geom_point(data=subset(test, distance >= 150), size= 3, alpha = 0.65, colour = "black") + 
  geom_smooth(data=subset(test, distance >= 150), method='lm', formula = y~x) +
  scale_colour_manual(values = "black") +
  # scale_fill_manual(values = "#78C679") +
  # scale_fill_manual(values = "#FEB24C") +
  # scale_fill_manual(values = "#4292C6") +
  scale_fill_manual(values = "#B3B3B3") +
  # coord_cartesian(ylim = c(0,11.9)) +
  # coord_cartesian(ylim = c(0,20)) +
  theme_minimal() +
  theme(
          text = element_text(family = "Arial"),
          legend.position = "none",
                axis.title.x=element_blank(),
                axis.text.x=element_text(size = 18,
                                         face="plain",
                                         vjust= 0.0,
                                         angle = 0,
                                         hjust = 0.5),    # Y axis text
                axis.title.y=element_blank(),
                axis.text.y=element_text(size = 18,
                                         face="plain",
                                         vjust= 0.4)) 

  
ggsave("plot1.png", width = 10, height = 10, units = "cm", dpi = 300)


# Getting correlation of hivCellProp from 150 to 800um from HIV+ or HIV- LA for each target cell type

#Summarised data
dfTest = dfMain %>%
  dplyr::filter(ImageID %in% unique(b$ImageID)) %>%
  dplyr::filter(laHIVStatus == "hivPosLA") %>%
  dplyr::filter(CellTypeZ == "CD11c") %>%
  mutate(distance = as.numeric(as.character(distance))) %>%
  dplyr::filter(distance >=150) %>%
  group_by(distance) %>%
  summarise(hivCellProp = mean(hivCellProp))

cor.test(dfTest$distance, dfTest$hivCellProp, method = "pearson")

#Unsummarised data (not shown, but confirms linear increase specific to DCs and CD4 T cells)
dfTest = dfMain %>%
  dplyr::filter(laHIVStatus == "hivPosLA") %>%
  dplyr::filter(CellTypeZ == "CD3CD4n") %>%
  mutate(distance = as.numeric(as.character(distance))) %>%
  dplyr::filter(distance >=150)

cor.test(dfTest$distance, dfTest$hivCellProp, method = "pearson")

ggplot(dfTest, aes(x = distance, y= hivCellProp)) +
  geom_point() +
  geom_smooth(method = "lm")


```


### Figure 5 - Does the composition of cells within HIV+ Las differ from that of HIV- Las? (USED IN PAPER)

```{r eval = FALSE, echo = FALSE}

# Chose to comparse densities instead of cell type proportions. 
df = cellData %>%
   dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  dplyr::filter(Compartments == "LA") %>%
  mutate(minLP = min(LPDist)) %>%
  dplyr::filter(minLP < 10*3.07) %>%
  # mutate(CellTypeZ = case_when(
  #   CellTypeZ == "CD3" ~ "CD3CD4p",
  #   CellTypeZ == "CD3CD4n" ~ "CD3CD4p",
  #   TRUE~as.character(CellTypeZ))) %>%
  mutate(laHIVStatus = case_when(
    laIDHIVCount > 2 ~ "hivPosLA",
    laIDHIVCount <= 2 ~ "hivNegLA",
    TRUE~as.character("toDelete"))) %>%
  dplyr::filter(laHIVStatus != "toDelete") %>%
  # mutate(laHIVStatus = case_when(
  #   laIDHIVCount <= 18 ~ "hivLowLA",
  #   laIDHIVCount > 18 & laIDHIVCount <86 ~ "hivMidLA",
  #   laIDHIVCount > 86 ~ "hivHighLA",
  #   TRUE~as.character("toDelete"))) %>%
  # dplyr::filter(laHIVStatus != "toDelete") %>%
  # mutate(laHIVStatus = case_when(
  #   laIDHIVCount <= 16 ~ "hivLowLA",
  #   laIDHIVCount >= 17 & laIDHIVCount <=82 ~ "hivMidLA",
  #   laIDHIVCount >= 83 ~ "hivHighLA",
  #   TRUE~as.character("toDelete"))) %>%
  #   dplyr::filter(laHIVStatus != "toDelete") %>%
  # mutate(laHIVStatus = case_when(
  #   laIDHIVCount >= 2 ~ "hivPosLA",
  #   laIDHIVCount < 2 ~ "hivNegLA",
  #   TRUE~as.character("toDelete"))) %>%
  # dplyr::filter(laHIVStatus != "toDelete") %>%
  group_by(DonorNo, blockID, Image, laHIVStatus, laID) %>%
  # add_count(name = "totalCellCount") %>%
  mutate(compArea = sum(NucArea)/(((3.07^2)*10^6))) %>%
  group_by(DonorNo, blockID, Image, laHIVStatus, laID, CellTypeZ) %>%
  add_count(name = "cellTypeCount") %>%
  mutate(cellDen = (cellTypeCount/compArea)) %>%
  # mutate(cellProp = (cellTypeCount/totalCellCount)*100) %>%
  # summarise(cellProp = mean(cellProp)) %>%
  summarise(cellDen = mean(cellDen)) %>%
  dplyr::filter(CellTypeZ %in% c("CD11c", "CD3CD4p", "CD3CD4n")) %>%
  mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD11c", "CD3CD4p", "CD3CD4n"))) %>%
  ungroup()

# df$laHIVStatus = factor(df$laHIVStatus, levels = c("hivLowLA", "hivMidLA", "hivHighLA"))


df %>%
  dplyr::filter(CellTypeZ %in% c("CD11c", "CD3CD4p")) %>%
ggplot(aes(x = CellTypeZ, y = cellDen, fill = interaction(CellTypeZ, laHIVStatus),  colour = interaction(CellTypeZ, laHIVStatus))) +
  geom_boxplot(position=position_dodge(0.90), width = 0.80, outlier.shape = NA, alpha = 0.65, lwd = 1.25) +
  scale_fill_manual(values = c("#78C679", "#4292C6", "#78C679", "#4292C6")) +
  # scale_fill_manual(values = c("#78C679", "#4292C6", "#78C679", "#4292C6", "#78C679", "#4292C6")) +
  # scale_colour_manual(values = c("#78C679", "#4292C6", "#78C679", "#4292C6", "#78C679", "#4292C6")) +
  # scale_fill_manual(values = c("#78C679", "#4292C6", "#B3B3B3", "#78C679", "#4292C6", "#B3B3B3", "#78C679", "#4292C6", "#B3B3B3")) +
  scale_colour_manual(values =c(wes_palette("Zissou1")[1], wes_palette("Zissou1")[1],  wes_palette("FantasticFox1")[5], wes_palette("FantasticFox1")[5])) +
  # scale_x_discrete(labels = c("DC","CD4+ TC", "CD4- TC")) +
  scale_x_discrete(labels = c("DC","CD4+ TC")) +
  theme_classic() +
  coord_cartesian(ylim = c(0,11000)) +
    theme(
            text = element_text(family = "Arial"),
            legend.position = "none",
                  axis.title.x=element_blank(),
                  axis.text.x=element_text(size = 18,
                                           face="plain",
                                           vjust= 0.0,
                                           angle = 0,
                                           hjust = 0.5),    # Y axis text
                  axis.title.y=element_blank(),
                  axis.text.y=element_text(size = 18,
                                           face="plain",
                                           vjust= 0.4)) 


ggsave("plot1.png", width = 12, height = 10, units = "cm", dpi = 300)

dfTest = df %>%
  dplyr::filter(CellTypeZ == "CD11c") %>%
  pivot_wider(names_from = laHIVStatus, values_from = cellDen)

wilcox.test(dfTest$hivNegLA, dfTest$hivPosLA, paired = FALSE)
  
  
```


## Figure 5 - Do DCs migrate into LAs? Compare HIV+ and HIV- LAs to see if distribution of target cells differ from the edge to center? Is there more DCs toward the edge? (USED FOR PAPER)

```{r echo = FALSE}

# Two methods. 1.  Concentric even Area circles. 2. Increasing radial intervals.

## First Method (Even concentric circles) ####

# NOTE: You can do this by Image or by individual LAs. If doing by LAs then you have to add laID to groupings and also do unpaired cox test in the
# test1 pipe after the loop

df = cellData %>%
  dplyr::filter(batch == "new") %>%
  dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
  group_by(blockID, DonorNo, ImageID, laID) %>%
  dplyr::filter(Compartments == "LA") %>%
  mutate(minLP = min(LPDist)) %>%
  dplyr::filter(minLP < 10*3.07) %>%
  # mutate(CellTypeZ = case_when(
  #   CellTypeZ == "CD3" ~ "CD3CD4p",
  #   CellTypeZ == "CD3CD4n" ~ "CD3CD4p",
  #   TRUE~as.character(CellTypeZ))) %>%
  mutate(laHIVStatus = case_when(
    laIDHIVCount > 2 ~ "hivPosLA",
    laIDHIVCount <= 2 ~ "hivNegLA",
    TRUE~as.character("toDelete"))) %>%
  dplyr::filter(laHIVStatus != "toDelete") %>%
  # mutate(laHIVStatus = case_when(
  #   laIDHIVCount <= 18 ~ "hivLowLA",
  #   laIDHIVCount > 18 & laIDHIVCount <86 ~ "hivMidLA",
  #   laIDHIVCount > 86 ~ "hivHighLA",
  #   TRUE~as.character("toDelete"))) %>%
  # dplyr::filter(laHIVStatus != "toDelete") %>%
  # mutate(laHIVStatus = case_when(
  #   laIDHIVCount <= 16 ~ "hivLowLA",
  #   laIDHIVCount >= 17 & laIDHIVCount <=82 ~ "hivMidLA",
  #   laIDHIVCount >= 83 ~ "hivHighLA",
  #   TRUE~as.character("toDelete"))) %>%
  #   dplyr::filter(laHIVStatus != "toDelete") %>%
  mutate(maxDist = max(LAInnerDist)) %>%
  mutate(LAInnerDist = LAInnerDist/maxDist) 
# 
# # CHecking how to split the LAs by HIV level fairly
# dfTest = df %>%
#   group_by(laIDHIVCount) %>%
#   slice_head(1) %>%
#   select(ImageID, laID, laIDHIVCount)
# 
# dfTest$quants =  fabricatr::split_quantile(dfTest$laIDHIVCount, 3)
# dfTest$quants = factor(dfTest$quants, levels = c("1", "2", "3"))


dfWholeDen = df %>%
    group_by(blockID, DonorNo, ImageID, laHIVStatus, laID) %>%
    mutate(sumArea = sum(NucArea)/(((3.07^2)*10^6))) %>%
    group_by(blockID, DonorNo, ImageID, laHIVStatus, laID, CellTypeZ) %>%
    add_count(name = "cellNumber") %>%
    mutate(cellDensityWhole = cellNumber/sumArea) %>%
    summarise(cellDensityWhole = mean(cellDensityWhole)) %>%
    ungroup() %>%
    dplyr::filter(CellTypeZ %in% c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n")) %>%
    mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD11c", "FXIIIa", "CD3CD4p", "CD3CD4n")))


sequence = 1 - c(sqrt(1-(1/20)), sqrt(1-(2/20)), sqrt(1-(3/20)), sqrt(1-(4/20)), sqrt(1-(5/20)), sqrt(1-(6/20)), sqrt(1-(7/20)), sqrt(1-(8/20)),sqrt(1-(9/20)), sqrt(1-(10/20)), sqrt(1-(11/20)), sqrt(1-(12/20)), sqrt(1-(13/20)), sqrt(1-(14/20)), sqrt(1-(15/20)), sqrt(1-(16/20)), sqrt(1-(17/20)),sqrt(1-(18/20)), sqrt(1-(19/20)))

vals = data.frame(sequence)
colnames(vals) = "Distance"
base =  0 
dfMain = data.frame()
n = 0

for(i in sequence) {
  
  df0 = df %>%  
    group_by(blockID, DonorNo, ImageID, laHIVStatus, laID) %>%
    dplyr::filter((LAInnerDist >= base) & (LAInnerDist < i)) %>%
    mutate(sumArea = sum(NucArea)/(((3.07^2)*10^6))) %>%
    add_count(name = "cellCount") %>%
    group_by(blockID, DonorNo, ImageID,laHIVStatus, laID, CellTypeZ) %>%
    add_count(name = "cellTypeCount") %>%
    # mutate(cellDensity = cellTypeCount/sumArea) %>%
    mutate(cellProp = (cellTypeCount/cellCount)*100) %>%
    dplyr::filter(CellTypeZ %in% c("CD11c", "CD3CD4p")) %>%
    mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD11c", "CD3CD4p"))) %>%
    # summarise(cellDensity = mean(cellDensity)) %>%
    summarise(cellProp = mean(cellProp)) %>%
    ungroup()
  
  toMeasure = "cellProp"
  df1 = pivot_wider(df0, names_from = CellTypeZ, values_from = toMeasure)

  df1[is.na(df1)] = 0
  df1 = pivot_longer(df1, cols = c("CD11c", "CD3CD4p"), names_to = c("CellTypeZ"), values_to = toMeasure)
  
  
  # df1 = left_join(df1, dfWholeDen)
  # df1 = df1 %>%
    # mutate(foldChange = cellDensity/cellDensityWhole)
  
  df1$distance = i
  # df1 = df0
  n = n + 1 
  df1$interval = n
  dfMain = rbind(dfMain, df1)
  
  base = i

}


dfMain$interval = as.factor(dfMain$interval)
dfMain$CellTypeZ = factor(dfMain$CellTypeZ, levels = c("CD11c", "CD3CD4p"))
dfMain$laHIVStatus = factor(dfMain$laHIVStatus, levels = c("hivNegLA", "hivPosLA"))
# dfMain$laHIVStatus = factor(dfMain$laHIVStatus, levels = c("hivLowLA", "hivMidLA", "hivHighLA"))

# Add blockID to the pipe above. Then merge with blockID and ImageID and laID. 
df1 = dfMain %>%
  mutate(laIDUnique = paste0(paste0(blockID,"_"),ImageID)) %>%
  mutate(laIDUnique = paste0(paste0(laIDUnique,"_"),laID))
length(unique(df1$DonorNo))
length(unique(df1$laIDUnique))

# dfMain2 = dfMain %>% dplyr::filter(foldChange != 0)

dfMain2 = dfMain

# Run this one for foldChange graphs
test1 = dfMain2 %>%
  pivot_longer(cols = c("foldChange", "cellDensity", "cellDensityWhole"), names_to = c("measureType"), values_to = "values") %>%
  dplyr::filter(measureType != "foldChange") %>%
  # dplyr::filter(laHIVStatus != "hivMidLA") %>%
  group_by(laHIVStatus, CellTypeZ, interval) %>%
  summarise(pVal = t.test(values ~ measureType, paired = TRUE, alternative = "two.sided")$p.value)

# Run this one for cellprop graphs
# Wilcox test to compare cellProp for each target cell in each interval between HIV- and HIV+ LAs in same image
test2 = dfMain2 %>%
  # group_by(ImageID, interval, CellTypeZ) %>%
  # dplyr::filter(
  #   (sum(laHIVStatus == "hivPosLA") > 0) &
  #   (sum(laHIVStatus == "hivNegLA") > 0)) %>%
  # dplyr::filter(laHIVStatus != "hivMidLA") %>%
  group_by(CellTypeZ, interval) %>%
  summarise(pValComp = wilcox.test(cellProp ~ laHIVStatus, paired = FALSE, alternative = "two.sided")$p.value)

test3 = dfMain2 %>%
  group_by(CellTypeZ, interval, laHIVStatus) %>%
  summarise(mean = mean(cellProp), sd = sd(cellProp))

# test = left_join(test1, test2)
# test = left_join(test, test3)
test = left_join(test2, test3)

# test = test3

test = test %>%
  mutate(sdLower = mean - sd) %>%
  mutate(sdHigher = mean + sd)

test$interval = as.numeric(as.character((test$interval)))

g = test %>%
  dplyr::filter(CellTypeZ == "CD11c") %>%
  ggplot(aes(x = interval, y = mean, colour = laHIVStatus, fill = laHIVStatus)) +
  geom_smooth() +
  theme_minimal() +
  scale_colour_manual(values = c("#67a9cf", "#ef8a62")) +
  scale_fill_manual(values = c("#67a9cf", "#ef8a62")) +
  # scale_colour_manual(values = c("#67a9cf", "#67cf8d", "#ef8a62")) +
  # scale_fill_manual(values = c("#67a9cf","#67cf8d","#ef8a62")) +
  # coord_cartesian(ylim = c(1500,7000)) +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.0,
                                       angle = 0,
                                       hjust = 0.5),    # Y axis text
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 18,
                                       face="plain",
                                       vjust= 0.4)) 
g
              
ggsave("plot1.png", width = 10, height = 10, units = "cm", dpi = 300)


# Statistical comparison of CellProp between HIV+ and HIV- for each interval

data = test
# data$pVal = -log10(data$pVal)
data$pValComp = -log10(data$pValComp)
data$interval = as.factor(data$interval)
data$CellTypeZ = as.factor(data$CellTypeZ)

#Define a cool colour palette I found here: https://www.r-bloggers.com/simplest-possible-heatmap-with-ggplot2/
myPalette <- colorRampPalette(rev(brewer.pal(11, "Spectral")), space="Lab")

pScale = data %>%
  ungroup() %>%
  # summarise(maxP = max(pVal), minP = min(pVal), maxPComp = max(pValComp), minPComp = min(pValComp)) 
  summarise(maxPComp = max(pValComp), minPComp = min(pValComp))


data %>%
  dplyr::filter(laHIVStatus == "hivPosLA") %>%
  dplyr::filter(CellTypeZ == "CD3CD4p") %>%
  ggplot(aes(x = interval, y = 1, fill = pValComp)) +
  geom_tile(aes(fill = pValComp)) + 
  scale_fill_gradientn(colors = myPalette(100),
                       limits = c(pScale$minPComp, pScale$maxPComp),
                        values=scales::rescale(c(min(data$pValComp, na.rm = TRUE),-log10(0.05), max(data$pValComp, na.rm = TRUE)))) +
  theme_classic() +
  theme(
    # legend.position = "none",
    plot.title=element_blank(), # title
          axis.title = element_blank(),
          axis.text=element_blank(),  
          legend.title = element_text(size = 18),
          legend.text = element_text(size =18),  
          axis.ticks = element_blank(),    
          strip.text.x = element_blank(),
          axis.line=element_blank(),
          panel.spacing = unit(0.3, "lines"))

#For Graph
ggsave("plot1.png", width = 10, height = 2.0, units = "cm", dpi = 300)
# For Legend
ggsave("plot1.png", width = 10, height = 8, units = "cm", dpi = 300)



```

### Figure 6 - Are increasing CD4 T cell HIV loads associated with increased DC membrane overlap? (USED IN PAPER)

```{r eval = FALSE, echo = FALSE}

df = cellData %>% 
    dplyr::filter(batch == "new") %>%
    dplyr::filter(Condition == "hivBal" | Condition == "hivTF") %>%
    dplyr::filter(Compartments != "Undefined") %>%
    group_by(DonorNo, Image) %>%
    dplyr::filter(
               (sum(Compartments == "LP") > 0) &
               (sum(Compartments == "LA") > 0)) %>%
    dplyr::filter(Compartments == "LP" | Compartments == "LA") %>%
    dplyr::filter(sum(CellTypeZ == "CD3CD4n" & hivCount == 0) >= 3) %>%
    dplyr::filter(sum(CellTypeZ == "CD3CD4n" & hivCount == 1) >= 3) %>%
    dplyr::filter(sum(CellTypeZ == "CD3CD4n" & (hivCount == 2 | hivCount == 3)) >= 3) %>%
    dplyr::filter(sum(CellTypeZ == "CD3CD4n" & hivCount > 3) >= 3) %>%
    mutate(CellTypeZ = case_when(
    CellTypeZ == "CD3CD4n" & hivCount == 0 ~ "CD3CD4n_HIV-",
    CellTypeZ == "CD3CD4n" & hivCount == 1 ~ "CD3CD4n_H1",
    CellTypeZ == "CD3CD4n" & (hivCount == 2 | hivCount == 3) ~ "CD3CD4n_H2",
    CellTypeZ == "CD3CD4n" & hivCount > 3 ~ "CD3CD4n_H4",
    TRUE ~ as.character(CellTypeZ))) %>%
   # dplyr::filter(CellTypeZ != "toDelete") %>%
    droplevels() %>%
    ungroup() 

df1 = df %>%
  mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD3CD4n_HIV-", "CD3CD4n_H1","CD3CD4n_H2", "CD3CD4n_H4"))) %>%
  dplyr::filter(CellTypeZ %in% c("CD3CD4n_HIV-", "CD3CD4n_H1","CD3CD4n_H2", "CD3CD4n_H4")) %>%
  group_by(Image, CellTypeZ) %>%
  summarise(CD11cOverlap = mean((CD11cOverlap/100)*CellArea))
  

df1 %>%
  ggplot(aes(x = CellTypeZ, y = CD11cOverlap, fill = CellTypeZ, colour = CellTypeZ)) + 
  geom_boxplot(position=position_dodge(0.8), width = 0.7, alpha = 0.65, lwd = 2) +
  scale_fill_manual(values = c("#4292C6", "#4292C6", "#4292C6", "#4292C6")) +
  # scale_fill_manual(values = c("#B3B3B3", "#B3B3B3", "#B3B3B3", "#B3B3B3")) +
  # scale_colour_manual(values = c("#FEB24C", "#FEB24C", "#FEB24C", "#FEB24C")) +
  scale_colour_manual(values = c("#78C679", "#78C679", "#78C679", "#78C679")) +
  # theme_minimal_hgrid(12) +
  theme_classic() +
  coord_cartesian(ylim = c(0,350)) +
  theme(
        text = element_text(family = "Arial"),
        legend.position = "none",
              axis.title.x=element_blank(),
              axis.text.x=element_text(size = 21,
                                       face="plain",
                                       vjust= 0.9,
                                       angle = 45,
                                       hjust = 1.0),    # Y axis text
              axis.title.y=element_blank(),
              axis.text.y=element_text(size = 21,
                                       face="plain",
                                       vjust= 0.4),
          plot.margin = unit(c(0.8,0.8,0.8,0.8), "cm"))  # Y axis title

  

ggsave("plot.png", width = 14, height = 16, units = "cm", dpi = 300)
       
  dfTest = df1 %>%
  # dplyr::filter(Compartments == "LP") %>%
  group_by(Image, CellTypeZ) %>%
  pivot_wider(names_from = CellTypeZ, values_from = CD11cOverlap)

wilcox.test(dfTest$`CD3CD4p_HIV-`, dfTest$CD3CD4p_H1, paired = TRUE)
wilcox.test(dfTest$`CD3CD4p_HIV-`, dfTest$CD3CD4p_H2, paired = TRUE)
wilcox.test(dfTest$CD3CD4p_H1, dfTest$CD3CD4p_H4, paired = TRUE)
wilcox.test(dfTest$CD3CD4p_H2, dfTest$CD3CD4p_H4, paired = TRUE)



#4. Subset and export CD4 T cells with varying levels of HIV so they can be visualised on images. ####

## Export CD4 T cell DC contacts
df1 = left_join(neigh, df)

df2 = df1 %>%
  mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD3CD4p_HIV-", "CD3CD4p_H1","CD3CD4p_H2", "CD3CD4p_H4"))) %>%
  mutate(CD11c_N = replace(CD11c_N,CD11c_N == 0, NA)) %>%
  select(Image, X, Y, CellTypeZ, CD11c_N) %>%
  drop_na()

write.csv(df2, "DC_CD4_Interactions2.csv")
  
df2 = df1 %>%
  mutate(CellTypeZ = factor(CellTypeZ, levels = c("CD3CD4p_HIV-", "CD3CD4p_H1","CD3CD4p_H2", "CD3CD4p_H4"))) %>%
  mutate(FXIIIa_N = replace(FXIIIa_N,FXIIIa_N == 0, NA)) %>%
  select(Image, X, Y, CellTypeZ, FXIIIa_N) %>%
  drop_na()

write.csv(df2, "Mac_CD4_Interactions2.csv")

```

